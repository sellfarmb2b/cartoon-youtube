<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì…€íŒœ AI ì• ë‹ˆë©”ì´ì…˜ ë©”ì´ì»¤</title>
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --sidebar-bg: #111827;
            --sidebar-text: #9ca3af;
            --sidebar-active-bg: #1f2937;
            --sidebar-active-text: #ffffff;
        }
        body { font-family: 'Noto Sans KR', Arial, sans-serif; background: var(--bg-color); margin:0; padding:0; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }
        /* ìƒˆë¡œìš´ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ (ë‚´ë¹„ê²Œì´ì…˜ ì „ìš©) */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--sidebar-bg); 
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #1f2937;
        }
        .sidebar-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }
        .nav-menu {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        .nav-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 4px;
            border: none;
            background: transparent;
            color: var(--sidebar-text);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            text-align: left;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }
        .nav-item.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        .nav-item span { margin-left: 10px; }
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #1f2937;
        }
        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .main-content { 
            flex: 1; 
            padding: 0; 
            overflow-y: auto; 
            position: relative;
            background: #f9fafb;
        }
        .content-view {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
            animation: fadeIn 0.3s ease;
        }
        .content-view.active {
            display: block; /* í™œì„±í™”ëœ íƒ­ë§Œ í‘œì‹œ */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        main { max-width: 100%; margin: 0; padding: 0; }
        h1 { color: #1f2937; margin-bottom: 10px; }
        p { color:#4b5563; }
        textarea { width: 100%; min-height: 200px; padding: 14px; border:1px solid #d1d5db; border-radius:8px; resize: vertical; background:#fff; font-size:15px; line-height:1.5; }
        input[type="number"], select, input[type="text"] { width: 100%; padding: 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:15px; }
        label { display:block; margin:16px 0 6px; font-weight:600; color:#1f2937; }
        button { 
            background: var(--primary-color); 
            color: #fff; 
            border: none; 
            border-radius: 8px; 
            padding: 12px 20px; 
            cursor: pointer; 
            font-size: 15px; 
            font-weight: 500;
            transition: all 0.2s ease; 
        }
        button:hover { filter: brightness(110%); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .secondary-btn { background: #4b5563; }
        .success-btn { background: #10b981; }
        .danger-btn { background: #ef4444; }
        .purple-btn { background: #8b5cf6; }
        .primary-btn { background: var(--primary-color); }
        .result-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 16px;
        }
        .button-row { display:flex; flex-wrap:wrap; gap:12px; margin:18px 0 0; }
        .preview-controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 0; }
        .preview-controls input { flex: 1 1 300px; }
        audio { width:100%; margin-top:10px; }
        .mode-tabs { display:flex; gap:8px; margin-top:10px; background: #f3f4f6; padding: 4px; border-radius: 12px; display: inline-flex; }
        .mode-tab { 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: none; 
            background: transparent; 
            color: #6b7280; 
            font-weight: 600; 
            cursor: pointer; 
        }
        .mode-tab.active { background: white; color: var(--primary-color); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .status-msg { margin-top:18px; padding:14px 16px; border-radius:10px; display:none; font-weight:600; }
        .status-msg.info { background:#dbeafe; color:#1d4ed8; }
        .status-msg.success { background:#dcfce7; color:#15803d; }
        .status-msg.error { background:#fee2e2; color:#b91c1c; }
        #promptSection { display:none; }
        table { width:100%; border-collapse: collapse; margin-top: 16px; }
        th, td { border:1px solid #e5e7eb; padding:12px; text-align:left; vertical-align:top; }
        th { background:#f3f4f6; color:#1f2937; font-weight:700; }
        pre { white-space: pre-wrap; word-break: break-word; margin:0; font-family: inherit; }
        .img-placeholder { color:#9ca3af; font-style:italic; }
        img.prompt-img { max-width:180px; border-radius:10px; box-shadow:0 6px 12px rgba(15,23,42,0.15); cursor:pointer; transition:transform 0.2s ease; }
        img.prompt-img:hover { transform:scale(1.05); }
        #progressPanel { display:none; }
        /* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .preview-modal { position:fixed; inset:0; background:rgba(15,23,42,0.9); display:none; align-items:center; justify-content:center; z-index:10001; padding:20px; }
        .preview-modal.active { display:flex; }
        .preview-modal-content { position:relative; max-width:90vw; max-height:90vh; background:#000; border-radius:12px; overflow:hidden; box-shadow:0 25px 50px rgba(0,0,0,0.5); }
        .preview-modal-content img { max-width:100%; max-height:90vh; display:block; margin:0 auto; }
        .preview-modal-content video { max-width:100%; max-height:90vh; display:block; }
        .preview-close { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); border:none; color:#fff; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; z-index:10; transition:background 0.2s ease; }
        .preview-close:hover { background:rgba(0,0,0,0.9); }
        .preview-title { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); color:#fff; padding:8px 16px; border-radius:6px; font-size:14px; font-weight:600; z-index:10; }
        #progressPanel ul { list-style:none; padding-left:0; margin-top:12px; max-height:220px; overflow-y:auto; }
        #progressPanel li { padding:8px 0; border-bottom:1px solid #e5e7eb; font-size:14px; color:#4b5563; }
        progress { width:100%; height:16px; border-radius:999px; background:#e0e7ff; overflow:hidden; }
        progress::-webkit-progress-bar { background:#e0e7ff; border-radius:999px; }
        progress::-webkit-progress-value { background:#2563eb; border-radius:999px; }
        #stageModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
        #stageModal.active { display:flex; }
        
        /* AI ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .ai-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }
        .ai-loading-overlay.active { display: flex; }
        .ai-loading-content {
            background: #fff;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            min-width: 350px;
        }
        .ai-loading-progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }
        .ai-loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .ai-loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            position: relative;
        }
        .ai-loading-spinner::before,
        .ai-loading-spinner::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: ai-spin 1s linear infinite;
        }
        .ai-loading-spinner::after {
            border-top-color: #8b5cf6;
            animation-delay: -0.5s;
        }
        @keyframes ai-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .ai-loading-subtext {
            font-size: 14px;
            color: #6b7280;
        }
        .stage-modal-content { background:#fff; border-radius:12px; padding:24px 28px; width:320px; box-shadow:0 20px 40px rgba(15,23,42,0.18); }
        .stage-modal-content h3 { margin:0; color:#1f2937; font-size:18px; }
        .stage-list { list-style:none; padding:0; margin:18px 0 16px; }
        .stage-item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #e5e7eb; font-weight:600; color:#4b5563; }
        .stage-item:last-child { border-bottom:none; }
        .stage-item .status-dot { width:12px; height:12px; border-radius:50%; margin-left:12px; background:#d1d5db; transition:background 0.3s ease; }
        .stage-item.completed { color:#15803d; }
        .stage-item.completed .status-dot { background:#22c55e; }
        .stage-item.active { color:#1d4ed8; }
        .stage-item.active .status-dot { background:#2563eb; }
        .stage-item.error { color:#b91c1c; }
        .stage-item.error .status-dot { background:#ef4444; }
        .stage-progress-track { width:100%; height:6px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:6px; }
        .stage-progress-bar { height:100%; width:0; background:#2563eb; transition:width 0.3s ease; }
        .stage-close { margin-top:18px; width:100%; padding:10px 14px; border:none; border-radius:8px; background:#1f2937; color:#fff; font-weight:600; cursor:pointer; display:none; }
        #stageModal.stage-complete .stage-close,
        #stageModal.stage-error .stage-close { display:block; }
        .settings-modal { position:fixed; inset:0; background:rgba(15,23,42,0.55); display:none; align-items:center; justify-content:center; z-index:10000; padding:16px; }
        .settings-modal.active { display:flex; }
        .settings-modal-content { width:100%; max-width:420px; background:#fff; border-radius:16px; padding:24px; box-shadow:0 25px 45px rgba(15,23,42,0.2); position:relative; }
        .settings-modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .settings-modal-header h2 { margin:0; color:#111827; }
        .settings-close { background:transparent; border:none; font-size:26px; line-height:1; cursor:pointer; color:#6b7280; }
        .settings-close:hover { color:#111827; }
        .settings-modal-content label { margin-top:12px; }
        .settings-modal-content input { margin-top:4px; }
        .settings-helper { color:#6b7280; font-size:13px; margin:4px 0 0; }
        .settings-actions { display:flex; justify-content:flex-end; margin-top:20px; gap:10px; }
        /* ëŒ€ë³¸ ìƒì„± ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .script-generator-section { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb; }
        .script-generator-section:last-child { border-bottom: none; }
        .script-generator-section h3 { margin: 0 0 12px 0; color: #1f2937; font-size: 16px; font-weight: 700; }
        .script-generator-section textarea { min-height: 120px; font-size: 14px; }
        .script-generator-section button { width: 100%; margin-top: 12px; }
        .script-result { margin-top: 16px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; max-height: 400px; overflow-y: auto; }
        .script-result pre { white-space: pre-wrap; word-break: break-word; margin: 0; font-size: 13px; line-height: 1.6; color: #374151; }
        .script-result h4 { margin: 0 0 8px 0; color: #1f2937; font-size: 14px; font-weight: 600; }
        .thumbnail-prompt-result { margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 6px; border: 1px solid #fbbf24; }
        .thumbnail-prompt-result code { display: block; font-size: 12px; color: #92400e; }
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ ë¦¬íŒŒì¸ */
        .card { 
            background: #fff; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            padding: 32px; 
            margin-bottom: 24px; 
            border: 1px solid #e5e7eb;
        }
        .section-header {
            margin-bottom: 24px;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 16px;
        }
        .section-header h2 {
            margin: 0;
            font-size: 24px;
            color: #111827;
        }
        .section-header p {
            margin: 8px 0 0;
            color: #6b7280;
        }
        @media (max-width:768px) {
            .sidebar { width: 100%; position: relative; height: auto; }
            .main-content { margin-left: 0; }
            .button-row { flex-direction:column; }
            .preview-controls { flex-direction:column; align-items:stretch; }
            img.prompt-img { width:100%; max-width:none; }
        }
    </style>
</head>
<body>
<div class="app-container">
    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°”: ë‚´ë¹„ê²Œì´ì…˜ ì „ìš© -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <h1>ğŸ¬ ì…€íŒœ ìŠ¤íŠœë””ì˜¤</h1>
        </div>
        <div class="nav-menu">
            <button class="nav-item active" onclick="switchView('scriptView')">
                <span>ğŸ“ ëŒ€ë³¸ ìƒì„±</span>
            </button>
            <button class="nav-item" onclick="switchView('metadataView')">
                <span>âœ¨ ì œëª©/ë‚´ìš© ìƒì„±</span>
            </button>
            <button class="nav-item" onclick="switchView('videoGenView')">
                <span>ğŸ¥ ì˜ìƒ ì œì‘</span>
            </button>
            <button class="nav-item" onclick="switchView('thumbnailView')">
                <span>ğŸ–¼ï¸ ì¸ë„¤ì¼ ì œì‘</span>
            </button>
        </div>
        <div class="sidebar-footer">
            <button class="nav-item" id="openSettingsBtn" style="width: 100%; justify-content: center; background: #374151;">
                âš™ï¸ ì„¤ì •
            </button>
        </div>
    </nav>

    <main class="main-content">
        <!-- ëŒ€ë³¸ ìƒì„± ë·° -->
        <div id="scriptView" class="content-view active">
            <div class="section-header">
                <h2>ëŒ€ë³¸ ì•„ì´ë””ì–´ & ì‘ì„±</h2>
                <p>AIì™€ í•¨ê»˜ ìœ íŠœë¸Œ ëŒ€ë³¸ì„ ì²˜ìŒë¶€í„° ëê¹Œì§€ ì‘ì„±í•´ë³´ì„¸ìš”.</p>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0;">1ë‹¨ê³„: ì•„ì´ë””ì–´ í™•ì‚° (ê²€ìˆ˜ ëŒ€ë³¸)</h3>
                <div style="display: flex; gap: 12px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label for="draftTopic">ì£¼ì œ/í‚¤ì›Œë“œ</label>
                        <input type="text" id="draftTopic" placeholder="ì˜ˆ: ì›Œë Œ ë²„í•ì˜ íˆ¬ì ì² í•™, ì¡°ì„ ì™•ì¡°ì‹¤ë¡ ë¯¸ìŠ¤í„°ë¦¬">
                    </div>
                    <button type="button" id="generateDraftBtn">ê²€ìˆ˜ ëŒ€ë³¸ ìƒì„±</button>
                </div>
                <div id="draftResult" class="result-box" style="display: none; margin-top: 16px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h4>ìƒì„±ëœ ê²€ìˆ˜ ëŒ€ë³¸</h4>
                        <button type="button" id="copyDraftBtn" class="success-btn" style="padding:4px 12px; font-size:12px;">ë³µì‚¬</button>
                    </div>
                    <pre id="draftScriptContent" style="max-height: 200px; overflow-y: auto;"></pre>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">2ë‹¨ê³„: ì‹œë‚˜ë¦¬ì˜¤ ì™„ì„± (ìµœì¢… ëŒ€ë³¸)</h3>
                <label for="finalDraftScript">ê²€ìˆ˜ ëŒ€ë³¸ ì…ë ¥ (ìˆ˜ì • ê°€ëŠ¥)</label>
                <textarea id="finalDraftScript" placeholder="ìœ„ì—ì„œ ìƒì„±ëœ ê²€ìˆ˜ ëŒ€ë³¸ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤. ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                
                <div style="margin-top:16px; text-align:right;">
                    <button type="button" id="generateFinalBtn" class="purple-btn">ìµœì¢… ëŒ€ë³¸ ë° í”„ë¡¬í”„íŠ¸ ìƒì„±</button>
                </div>

                <div id="finalResult" class="result-box" style="display: none; margin-top: 16px;">
                    <h4>ğŸ™ï¸ ìµœì¢… ëŒ€ë³¸ (ë‚´ë ˆì´ì…˜ìš©)</h4>
                    <pre id="finalScriptContent" style="max-height: 300px; overflow-y: auto; margin-bottom:15px;"></pre>
                    <button type="button" id="copyFinalBtn" class="success-btn" style="width:100%">ìµœì¢… ëŒ€ë³¸ ë³µì‚¬</button>
                </div>

                <div id="visualPromptResult" class="result-box" style="display: none; background:#f0f9ff; border-color:#bae6fd; margin-top: 16px;">
                    <h4>ğŸ–¼ï¸ AI ì‹œê°í™” í”„ë¡¬í”„íŠ¸</h4>
                    <pre id="visualPromptContent" style="max-height: 200px; overflow-y: auto; font-size:12px;"></pre>
                    <button type="button" id="copyVisualPromptBtn" class="primary-btn" style="width:100%; margin-top:10px;">í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <button type="button" id="applyScriptBtn" class="success-btn" style="width: 100%; padding: 16px; font-size: 16px;" disabled>
                        ğŸš€ ì˜ìƒ ì œì‘ìœ¼ë¡œ ëŒ€ë³¸ ë³´ë‚´ê¸°
                    </button>
                    <p style="text-align: center; font-size: 13px; margin-top: 8px;">í´ë¦­í•˜ë©´ 'ì˜ìƒ ì œì‘' íƒ­ìœ¼ë¡œ ì´ë™í•˜ë©° ëŒ€ë³¸ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>

        <!-- ì œëª©/ë‚´ìš© ìƒì„± ë·° -->
        <div id="metadataView" class="content-view">
            <div class="section-header">
                <h2>ìœ íŠœë¸Œ ì„±ì¥ ì „ëµ (Growth Hacker)</h2>
                <p>ì•Œê³ ë¦¬ì¦˜ì´ ì‚¬ë‘í•˜ëŠ” ì œëª©, ì„¤ëª…, ì¸ë„¤ì¼ ì „ëµì„ ì œì•ˆë°›ìœ¼ì„¸ìš”.</p>
            </div>

            <div class="card">
                <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <label style="margin-top:0; color: #0369a1;">ë¶„ì„ ëŒ€ìƒ ìƒíƒœ</label>
                    <div id="targetScriptStatus" style="font-size: 15px; color: #0c4a6e; font-weight: 500;">
                        ëŒ€ë³¸ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. [ëŒ€ë³¸ ìƒì„±] íƒ­ì—ì„œ ëŒ€ë³¸ì„ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.
                    </div>
                </div>

                <button type="button" id="generateMetadataBtn" style="width: 100%; padding: 16px; font-size: 16px;">
                    âœ¨ ì „ëµ ë¶„ì„ ë° ë©”íƒ€ë°ì´í„° ìƒì„± ì‹œì‘
                </button>
            </div>

            <div id="metadataResult" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 style="margin:0;">ğŸ§ í•µì‹¬ ê°€ì¹˜ ë¶„ì„</h3>
                        <button type="button" id="copyAnalysisBtn" class="success-btn" style="padding:4px 10px; font-size:12px;">ë³µì‚¬</button>
                    </div>
                    <p id="metaAnalysis" style="line-height: 1.6; color: #374151;"></p>
                </div>

                <div class="card">
                    <h3 style="margin-top:0; color:#dc2626;">ğŸ”¥ í•„ì‚´ê¸° ì œëª© 3ì„ </h3>
                    
                    <div style="margin-bottom: 16px; padding: 12px; background: #fff5f5; border-radius: 8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <span style="font-size: 12px; font-weight:bold; color: #991b1b;">ì˜µì…˜ 1: ê²€ìƒ‰ ì ì¤‘í˜• (SEO)</span>
                            <button class="copyTitleBtn" data-target="metaTitleSearch" style="border:none; background:none; cursor:pointer;">ğŸ“‹</button>
                        </div>
                        <p id="metaTitleSearch" style="font-size: 16px; font-weight: 700; margin:0; cursor:pointer;" onclick="copyText(this)"></p>
                    </div>

                    <div style="margin-bottom: 16px; padding: 12px; background: #fffbeb; border-radius: 8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <span style="font-size: 12px; font-weight:bold; color: #92400e;">ì˜µì…˜ 2: í˜¸ê¸°ì‹¬/í›„í‚¹í˜• (CTR)</span>
                            <button class="copyTitleBtn" data-target="metaTitleHook" style="border:none; background:none; cursor:pointer;">ğŸ“‹</button>
                        </div>
                        <p id="metaTitleHook" style="font-size: 16px; font-weight: 700; margin:0; cursor:pointer;" onclick="copyText(this)"></p>
                    </div>

                    <div style="padding: 12px; background: #eff6ff; border-radius: 8px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                            <span style="font-size: 12px; font-weight:bold; color: #1e40af;">ì˜µì…˜ 3: ê¶Œìœ„/ìŠ¤í† ë¦¬í˜•</span>
                            <button class="copyTitleBtn" data-target="metaTitleStory" style="border:none; background:none; cursor:pointer;">ğŸ“‹</button>
                        </div>
                        <p id="metaTitleStory" style="font-size: 16px; font-weight: 700; margin:0; cursor:pointer;" onclick="copyText(this)"></p>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0;">ğŸ“ ì„¤ëª…ë€ (Description)</h3>
                    <textarea id="metaDescription" readonly style="background: #f9fafb; border: none; font-size: 14px; color: #4b5563;"></textarea>
                    
                    <div style="margin-top: 20px;">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                            <strong>ì¶”ì²œ íƒœê·¸:</strong>
                            <button id="copyTagsBtn" class="success-btn" style="padding:2px 8px; font-size:11px;">ë³µì‚¬</button>
                        </div>
                        <p id="metaTags" style="color: #2563eb; background: #eff6ff; padding: 10px; border-radius: 6px; font-size: 13px;"></p>
                    </div>
                </div>

                <div class="card" style="border-left: 5px solid #fbbf24;">
                    <h3 style="margin-top:0; color:#b45309;">ğŸ¨ ì¸ë„¤ì¼ ê°€ì´ë“œ</h3>
                    <div style="margin-bottom: 16px;">
                        <p style="font-weight:600; margin-bottom:4px;">í…ìŠ¤íŠ¸ ë¬¸êµ¬:</p>
                        <div id="metaThumbText" style="background:#fff; border:1px solid #e5e7eb; padding:8px; border-radius:4px; font-weight:bold; font-size:18px;"></div>
                    </div>
                    <div>
                        <p style="font-weight:600; margin-bottom:4px;">ì´ë¯¸ì§€ êµ¬ì„±:</p>
                        <p id="metaThumbImage" style="color:#4b5563; line-height:1.5;"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì˜ìƒ ì œì‘ ë·° -->
        <div id="videoGenView" class="content-view">
            <div class="section-header">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h2>ì˜ìƒ ì œì‘ ìŠ¤íŠœë””ì˜¤</h2>
                        <p>ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  AIë¡œ ìŒì„±ê³¼ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì—¬ ì˜ìƒì„ ì™„ì„±í•˜ì„¸ìš”.</p>
                    </div>
                    <div>
                        <button type="button" id="testModeBtn" class="success-btn">í…ŒìŠ¤íŠ¸ ëª¨ë“œ</button>
                        <button type="button" id="restartBtn" class="danger-btn" style="margin-left:8px;">ğŸ”„ ì´ˆê¸°í™”</button>
                    </div>
                </div>
            </div>
            <div class="card">

                <label for="script">ìµœì¢… ëŒ€ë³¸</label>
                <textarea id="script" placeholder="[ëŒ€ë³¸ ìƒì„±] íƒ­ì—ì„œ ë§Œë“  ëŒ€ë³¸ì„ ì ìš©í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”."></textarea>

        <div id="promptInputSection" style="display:none; margin-top:20px;">
            <label>ë¬¸ì¥ë³„ ì˜ì–´ í”„ë¡¬í”„íŠ¸ ì…ë ¥ (ì„ íƒì‚¬í•­)</label>
            <p style="color:#6b7280; font-size:14px; margin:6px 0 12px;">ê° ë¬¸ì¥ì— ëŒ€í•œ ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ì•„ë˜ '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±' ë²„íŠ¼ì„ ëˆŒëŸ¬ ìë™ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <button type="button" id="selectAllBananaBtn" style="display:none; margin-bottom:12px; padding:8px 16px; background-color:#fbbf24; color:#1f2937; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:14px; transition:all 0.2s ease;" onmouseover="this.style.backgroundColor='#f59e0b'" onmouseout="this.style.backgroundColor='#fbbf24'">ğŸŒ ë‚˜ë…¸ë°”ë‚˜ë‚˜ ì „ì²´ì„ íƒ</button>
            <div id="promptInputs" style="max-height:400px; overflow-y:auto; border:1px solid #d1d5db; border-radius:8px; padding:12px; background:#f9fafb;"></div>
        </div>

                <div style="display: flex; gap: 20px; margin-top: 20px;">
                    <div style="flex: 1;">
                        <label for="limit">ìë§‰ ì¤„ë°”ê¿ˆ (ê¸€ì ìˆ˜)</label>
                        <input type="number" id="limit" value="25" min="10">
                    </div>
                    <div style="flex: 1;">
                        <label for="voiceSelect">ì„±ìš° ì„ íƒ (ElevenLabs)</label>
                        <select id="voiceSelect">
                            {% for voice in voices %}
                                <option value="{{ voice.id }}" {% if default_voice_id == voice.id %}selected{% endif %}>
                                    {{ voice.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <label style="margin-top:20px;">ì˜ìƒ ìŠ¤íƒ€ì¼</label>
                <div class="mode-tabs">
                    <button type="button" class="mode-tab active" data-mode="animation">ì• ë‹ˆë©”ì´ì…˜</button>
                    <button type="button" class="mode-tab" data-mode="animation2">ì• ë‹ˆë©”ì´ì…˜2</button>
                    <button type="button" class="mode-tab" data-mode="animation3">ì• ë‹ˆë©”ì´ì…˜3</button>
                    <button type="button" class="mode-tab" data-mode="realistic">ì‹¤ì‚¬í™”</button>
                    <button type="button" class="mode-tab" data-mode="realistic2">ì‹¤ì‚¬í™”2</button>
                    <button type="button" class="mode-tab" data-mode="custom">ì»¤ìŠ¤í…€</button>
                </div>

                <div id="customPromptSection" style="display: none; margin-top: 12px; padding: 16px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px;">
                    <label for="customStylePrompt" style="margin-top:0;">ë‚˜ë§Œì˜ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸</label>
                    <textarea id="customStylePrompt" rows="3" placeholder="ì˜ˆ: A vibrant 2D cartoon style..." style="min-height:80px;"></textarea>
                </div>

                <div class="preview-controls" style="margin-top:24px; padding-top:20px; border-top:1px solid #eee;">
                    <div style="display:flex; gap:10px; flex:1;">
                        <input type="text" id="previewText" placeholder="ëª©ì†Œë¦¬ ë¯¸ë¦¬ë“£ê¸°ìš© ë¬¸ì¥ ì…ë ¥" style="flex:1;">
                        <button type="button" id="previewBtn" class="secondary-btn">ğŸ”Š ë¯¸ë¦¬ë“£ê¸°</button>
                    </div>
                    <audio id="previewAudio" controls style="display:none; margin-top:10px; width:100%;"></audio>
                    <div id="previewStatus" style="font-size:13px; color:#6b7280; margin-top:4px;"></div>
                </div>

                <div style="margin-top: 30px; display: flex; gap: 12px;">
                    <button type="button" id="generateImagesBtn" style="flex:1;" disabled>1. ì´ë¯¸ì§€ ìƒì„±</button>
                    <button type="button" id="generateVideoBtn" class="purple-btn" style="flex:1;" disabled>2. ì˜ìƒ ìƒì„±</button>
                </div>
                
                <div style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="includeSubtitlesCheckbox" checked>
                    <label for="includeSubtitlesCheckbox" style="margin:0; cursor:pointer;">ì˜ìƒì— ìë§‰ í¬í•¨í•˜ê¸°</label>
                </div>

                <div id="statusMessage" class="status-msg info"></div>
            </div>

            <section id="promptSection" class="card" style="display:none;">
                <h3 style="margin-top:0;">ì‘ì—… í˜„í™©</h3>
                <table id="promptTable">
                    <thead>
                        <tr>
                            <th style="width:30%;">ë¬¸ì¥</th>
                            <th style="width:40%;">í”„ë¡¬í”„íŠ¸</th>
                            <th style="width:20%;">ì´ë¯¸ì§€</th>
                            <th style="width:10%;">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>

            <div id="progressPanel" class="card" style="display:none;">
                <h3 style="margin-top:0;">ì˜ìƒ ìƒì„± ì§„í–‰ë„</h3>
                <progress id="progressBar" value="0" max="100"></progress>
                <div id="progressMessage" style="margin-top:12px; font-weight:600; color:#1f2937;"></div>
                <ul id="progressLog"></ul>
            </div>

            <div id="resultContainer">
                {% if video_filename %}
                <div class="card" style="border: 2px solid #2563eb;">
                    <h2 style="margin-top:0; color:#2563eb;">ğŸ‰ ì˜ìƒ ìƒì„± ì™„ë£Œ!</h2>
                    {% set video_job_id = video_filename.replace('final_video_', '').replace('.mp4', '') %}
                    {% set video_url = url_for('static', filename=video_filename) %}
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button type="button" onclick="showVideoPreview('{{ video_url }}', 'ì™„ì„±ëœ ì˜ìƒ')" class="purple-btn">ì˜ìƒ ì¬ìƒ</button>
                        <a href="/download_video/{{ video_job_id }}" style="text-decoration:none;">
                            <button type="button" class="success-btn">ë‹¤ìš´ë¡œë“œ</button>
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ì¸ë„¤ì¼ ì œì‘ ë·° -->
        <div id="thumbnailView" class="content-view">
            <div class="section-header">
                <h2>ìœ íŠœë¸Œ ì¸ë„¤ì¼ ì œì‘</h2>
                <p>AIë¡œ í´ë¦­ë¥ ì„ ë†’ì´ëŠ” ì¸ë„¤ì¼ì„ ì œì‘í•˜ì„¸ìš”.</p>
            </div>

            <div class="card">
                <h3 style="margin-top:0;">1ë‹¨ê³„: ì…ë ¥ ì •ë³´</h3>
                
                <label for="thumbnailScriptRef">ì°¸ì¡° ëŒ€ë³¸</label>
                <textarea id="thumbnailScriptRef" readonly placeholder="[ëŒ€ë³¸ ìƒì„±] íƒ­ì—ì„œ ìƒì„±ëœ ëŒ€ë³¸ì´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤." style="min-height: 150px; background: #f9fafb;"></textarea>
                <button type="button" id="loadScriptBtn" class="secondary-btn" style="margin-top: 8px;">ëŒ€ë³¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>

                <label for="thumbnailCharacterSetting" style="margin-top: 20px;">ìºë¦­í„°/ëª¨ë¸ ì„¤ì • (ì„ íƒì‚¬í•­)</label>
                <input type="text" id="thumbnailCharacterSetting" placeholder="ì˜ˆ: 20ëŒ€ ë‚¨ì„±, ë°ì€ í”¼ë¶€, ê²€ì€ ë¨¸ë¦¬, ì •ì¥ ì°¨ë¦¼">

                <label for="thumbnailReferenceImage" style="margin-top: 20px;">ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)</label>
                <input type="file" id="thumbnailReferenceImage" accept="image/*" style="padding: 8px;">
                <div id="thumbnailReferencePreview" style="margin-top: 12px; display: none;">
                    <img id="thumbnailReferenceImg" src="" alt="ì°¸ì¡° ì´ë¯¸ì§€" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <button type="button" id="removeReferenceImageBtn" class="danger-btn" style="margin-left: 8px; padding: 4px 12px; font-size: 12px;">ì œê±°</button>
                </div>

                <button type="button" id="generateThumbnailConceptsBtn" class="purple-btn" style="width: 100%; margin-top: 24px; padding: 16px; font-size: 16px;">
                    âœ¨ ì¸ë„¤ì¼ ê¸°íšì•ˆ ìƒì„±í•˜ê¸°
                </button>
            </div>

            <div id="thumbnailConceptsResult" style="display: none;">
                <div class="card">
                    <h3 style="margin-top:0;">2ë‹¨ê³„: ê¸°íšì•ˆ ì„ íƒ ë° ìˆ˜ì •</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">ìƒì„±ëœ 3ê°€ì§€ ì˜µì…˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ê³ , í•„ìš”ì‹œ ìˆ˜ì •í•œ í›„ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.</p>
                    
                    <div id="thumbnailConceptsContainer" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- ê¸°íšì•ˆ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <div id="thumbnailImageResult" style="display: none;">
                <div class="card">
                    <h3 style="margin-top:0;">3ë‹¨ê³„: ìƒì„±ëœ ì¸ë„¤ì¼</h3>
                    <div id="thumbnailImageContainer" style="text-align: center;">
                        <!-- ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>
    </main>

<div id="settingsModal" class="settings-modal">
    <div class="settings-modal-content">
        <div class="settings-modal-header">
            <h2>ì„¤ì •</h2>
            <button type="button" class="settings-close" id="closeSettingsBtn" aria-label="ë‹«ê¸°">&times;</button>
        </div>
        <p class="settings-helper">ì…ë ¥í•œ í‚¤ëŠ” ë¡œì»¬ Application Support/AppData í´ë”ì— ì €ì¥ë˜ë©°, ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <label for="settingsReplicateKey">Replicate ì´ë¯¸ì§€ ìƒì„± API í‚¤</label>
        <input type="password" id="settingsReplicateKey" placeholder="r8_..." autocomplete="off">
        <p class="settings-helper">Replicate í‚¤ê°€ ì—†ìœ¼ë©´ ì´ë¯¸ì§€ ìƒì„±ì´ ì œí•œë©ë‹ˆë‹¤.</p>
        <label for="settingsElevenlabsKey">ElevenLabs TTS API í‚¤</label>
        <input type="password" id="settingsElevenlabsKey" placeholder="sk-..." autocomplete="off">
        <p class="settings-helper">ElevenLabs í‚¤ê°€ ì—†ìœ¼ë©´ TTSê°€ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <label for="settingsGeminiKey">Gemini API í‚¤</label>
        <input type="password" id="settingsGeminiKey" placeholder="AIza..." autocomplete="off">
        <p class="settings-helper">Gemini í‚¤ëŠ” ëŒ€ë³¸ ìƒì„± ë° í”„ë¡¬í”„íŠ¸ ìë™ ìƒì„±ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
        <label for="settingsDownloadFolder">ë‹¤ìš´ë¡œë“œ í´ë” ê²½ë¡œ (ì„ íƒì‚¬í•­)</label>
        <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" id="settingsDownloadFolder" placeholder="ì˜ˆ: /Users/username/Downloads ë˜ëŠ” C:\Users\username\Downloads" autocomplete="off" style="flex:1;">
            <button type="button" id="selectFolderBtn" style="background:#6366f1; padding:10px 16px; white-space:nowrap;">í´ë” ì„ íƒ</button>
        </div>
        <p class="settings-helper">ë‹¤ìš´ë¡œë“œ í´ë” ê²½ë¡œë¥¼ ì§€ì •í•˜ë©´ ìƒì„±ëœ íŒŒì¼ì´ í•´ë‹¹ í´ë”ë¡œ ë³µì‚¬ë©ë‹ˆë‹¤. í´ë” ì„ íƒ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì§ì ‘ ì„ íƒí•˜ê±°ë‚˜, ê²½ë¡œë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">
        
        <h3 style="margin-top: 0; margin-bottom: 12px; color: #1f2937; font-size: 16px;">ì‚¬ìš©ì ì •ì˜ ë³´ì´ìŠ¤ ID ê´€ë¦¬</h3>
        <p class="settings-helper">ElevenLabsì—ì„œ ì œê³µí•˜ëŠ” ë³´ì´ìŠ¤ IDë¥¼ ì¶”ê°€í•˜ì—¬ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        
        <div style="display:flex; gap:8px; align-items:center; margin-bottom: 12px;">
            <input type="text" id="customVoiceIdInput" placeholder="ë³´ì´ìŠ¤ ID ì…ë ¥ (ì˜ˆ: pNInz6AJB3aCYtXltRbl)" autocomplete="off" style="flex:1; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
            <button type="button" id="addVoiceIdBtn" style="background:#10b981; padding:10px 16px; white-space:nowrap;">ì¶”ê°€</button>
        </div>
        
        <div id="customVoiceList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px; background: #f9fafb;">
            <p style="margin: 0; color: #6b7280; font-size: 14px; text-align: center; padding: 12px;">ì¶”ê°€ëœ ë³´ì´ìŠ¤ IDê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        
        <div class="settings-actions">
            <button type="button" id="cancelSettingsBtn" style="background:#e5e7eb; color:#111827;">ì·¨ì†Œ</button>
            <button type="button" id="saveSettingsBtn">ì €ì¥</button>
        </div>
    </div>
</div>

    <div id="stageModal">
        <div class="stage-modal-content">
            <h3>ì‘ì—… ì§„í–‰ ìƒíƒœ</h3>
            <ul class="stage-list">
                <li class="stage-item pending" data-stage="1" data-stage-key="ìì‚° ìƒì„±">
                    <span>1. ìì‚° ìƒì„±</span>
                    <span class="status-dot"></span>
                </li>
                <li class="stage-item pending" data-stage="2" data-stage-key="íƒ€ì„ìŠ¤íƒ¬í”„ ê³„ì‚°">
                    <span>2. íƒ€ì„ìŠ¤íƒ¬í”„ ê³„ì‚°</span>
                    <span class="status-dot"></span>
                </li>
                <li class="stage-item pending" data-stage="3" data-stage-key="ì˜ìƒ í•©ì„±">
                    <span>3. ì˜ìƒ í•©ì„±</span>
                    <span class="status-dot"></span>
                </li>
            </ul>
            <div class="stage-progress-track">
                <div class="stage-progress-bar" id="stageProgressBar"></div>
            </div>
            <button type="button" class="stage-close" id="stageCloseBtn">ë‹«ê¸°</button>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€/ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-modal-content">
            <button type="button" class="preview-close" id="previewCloseBtn" aria-label="ë‹«ê¸°">&times;</button>
            <div class="preview-title" id="previewTitle"></div>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- AI ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="aiLoadingOverlay" class="ai-loading-overlay">
        <div class="ai-loading-content">
            <div class="ai-loading-spinner"></div>
            <div class="ai-loading-text" id="aiLoadingText">AIê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤...</div>
            <div class="ai-loading-progress" id="aiLoadingProgress" style="display: none;">
                <div class="ai-loading-progress-bar" id="aiLoadingProgressBar"></div>
            </div>
            <div class="ai-loading-subtext" id="aiLoadingSubtext">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
        </div>
    </div>

<script>
        // ì´ë¯¸ì§€/ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„)
        function showImagePreview(imageUrl, title = 'ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°') {
            const previewModal = document.getElementById('previewModal');
            const previewContent = document.getElementById('previewContent');
            const previewTitle = document.getElementById('previewTitle');
            
            if (!previewModal || !previewContent) return;
            
            previewTitle.textContent = title;
            previewContent.innerHTML = `<img src="${imageUrl}" alt="${title}" style="max-width:100%; max-height:90vh; display:block; margin:0 auto;">`;
            previewModal.classList.add('active');
        }
        
        function showVideoPreview(videoUrl, title = 'ë™ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°') {
            const previewModal = document.getElementById('previewModal');
            const previewContent = document.getElementById('previewContent');
            const previewTitle = document.getElementById('previewTitle');
            
            if (!previewModal || !previewContent) return;
            
            previewTitle.textContent = title;
            previewContent.innerHTML = `<video controls autoplay style="max-width:100%; max-height:90vh; display:block; margin:0 auto;"><source src="${videoUrl}" type="video/mp4">ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</video>`;
            previewModal.classList.add('active');
        }
        
        // ë¹„ë””ì˜¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„)
        async function downloadVideo(jobId) {
            try {
                const statusMessage = document.getElementById('statusMessage');
                if (statusMessage) {
                    statusMessage.style.display = 'block';
                    statusMessage.textContent = 'ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì¤‘...';
                    statusMessage.className = 'status-msg info';
                }
                // ì§ì ‘ ë§í¬ë¡œ ì´ë™í•˜ì—¬ ë‹¤ìš´ë¡œë“œ (ì¬ìƒ ë°©ì§€)
                const downloadUrl = `/download_video/${jobId}`;
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `video_${jobId}.mp4`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // ì•½ê°„ì˜ ì§€ì—° í›„ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    if (statusMessage) {
                        statusMessage.textContent = 'ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        statusMessage.className = 'status-msg success';
                    }
                }, 500);
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                const statusMessage = document.getElementById('statusMessage');
                if (statusMessage) {
                    statusMessage.style.display = 'block';
                    statusMessage.textContent = 'ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    statusMessage.className = 'status-msg error';
                }
            }
        }

        // ë·° ì „í™˜ í•¨ìˆ˜ (ì „ì—­)
        function switchView(viewId) {
            // ëª¨ë“  ë·° ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active'));
            // ì„ íƒëœ ë·° ë³´ì´ê¸°
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
            }
            
            // ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            // onclick ì†ì„±ì„ í†µí•´ í•´ë‹¹ ë²„íŠ¼ ì°¾ê¸°
            const activeBtn = Array.from(document.querySelectorAll('.nav-item')).find(btn => {
                const onclick = btn.getAttribute('onclick');
                return onclick && onclick.includes(`'${viewId}'`);
            });
            if(activeBtn) activeBtn.classList.add('active');

            // ë©”íƒ€ë°ì´í„° íƒ­ í´ë¦­ ì‹œ ìƒíƒœ ì²´í¬
            if(viewId === 'metadataView') {
                if (typeof checkScriptAvailability === 'function') {
                    checkScriptAvailability();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            
            const previewBtn = document.getElementById('previewBtn');
            const voiceSelect = document.getElementById('voiceSelect');
            const previewAudio = document.getElementById('previewAudio');
            const previewText = document.getElementById('previewText');
            const previewStatus = document.getElementById('previewStatus');

            const scriptInput = document.getElementById('script');
            const charLimitInput = document.getElementById('limit');
            const generateImagesBtn = document.getElementById('generateImagesBtn');
            const generateVideoBtn = document.getElementById('generateVideoBtn');
            const statusMessage = document.getElementById('statusMessage');
            const promptSection = document.getElementById('promptSection');
            const promptTableBody = document.querySelector('#promptTable tbody');
            const progressPanel = document.getElementById('progressPanel');
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressLog = document.getElementById('progressLog');
            const resultContainer = document.getElementById('resultContainer');
            const modeTabs = document.querySelectorAll('.mode-tab');
            const stageModal = document.getElementById('stageModal');
            const stageItems = Array.from(stageModal.querySelectorAll('.stage-item'));
            const stageProgressBar = document.getElementById('stageProgressBar');
            const stageCloseBtn = document.getElementById('stageCloseBtn');
            const stageTotal = stageItems.length;
            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const previewModal = document.getElementById('previewModal');
            const previewCloseBtn = document.getElementById('previewCloseBtn');
            const settingsReplicateInput = document.getElementById('settingsReplicateKey');
            const settingsElevenlabsInput = document.getElementById('settingsElevenlabsKey');
            const settingsGeminiInput = document.getElementById('settingsGeminiKey');
            const settingsDownloadFolderInput = document.getElementById('settingsDownloadFolder');
            const selectFolderBtn = document.getElementById('selectFolderBtn');
            const customVoiceIdInput = document.getElementById('customVoiceIdInput');
            const addVoiceIdBtn = document.getElementById('addVoiceIdBtn');
            const customVoiceList = document.getElementById('customVoiceList');
            let settingsState = {
                replicate_api_key: '',
                elevenlabs_api_key: '',
                gemini_api_key: '',
                download_folder_path: ''
            };
            let customVoiceIds = [];

            function populateSettingsForm() {
                if (!settingsReplicateInput || !settingsElevenlabsInput || !settingsGeminiInput) return;
                settingsReplicateInput.value = settingsState.replicate_api_key || '';
                settingsElevenlabsInput.value = settingsState.elevenlabs_api_key || '';
                settingsGeminiInput.value = settingsState.gemini_api_key || '';
                if (settingsDownloadFolderInput) {
                    settingsDownloadFolderInput.value = settingsState.download_folder_path || '';
                }
            }

            function openSettingsModal() {
                if (!settingsModal) return;
                populateSettingsForm();
                loadCustomVoices(); // ë³´ì´ìŠ¤ ëª©ë¡ë„ ë¡œë“œ
                settingsModal.classList.add('active');
            }

            function closeSettingsModal() {
                if (!settingsModal) return;
                settingsModal.classList.remove('active');
            }

            async function loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    if (!response.ok) {
                        throw new Error('ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                    const data = await response.json();
                    settingsState = {
                        replicate_api_key: data.replicate_api_key || '',
                        elevenlabs_api_key: data.elevenlabs_api_key || '',
                        gemini_api_key: data.gemini_api_key || '',
                        download_folder_path: data.download_folder_path || ''
                    };
                    populateSettingsForm();
                    
                    // ë³´ì´ìŠ¤ ëª©ë¡ ë¡œë“œ
                    await loadCustomVoices();
                } catch (error) {
                    console.error('[ì„¤ì •] ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                }
            }
            
            async function loadCustomVoices() {
                try {
                    const response = await fetch('/api/voices');
                    if (!response.ok) {
                        throw new Error('ë³´ì´ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                    const data = await response.json();
                    customVoiceIds = data.custom_voice_ids || [];
                    renderCustomVoiceList();
                } catch (error) {
                    console.error('[ë³´ì´ìŠ¤] ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                }
            }
            
            function renderCustomVoiceList() {
                if (!customVoiceList) return;
                
                if (customVoiceIds.length === 0) {
                    customVoiceList.innerHTML = '<p style="margin: 0; color: #6b7280; font-size: 14px; text-align: center; padding: 12px;">ì¶”ê°€ëœ ë³´ì´ìŠ¤ IDê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    return;
                }
                
                customVoiceList.innerHTML = customVoiceIds.map(voiceId => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin-bottom: 4px; background: white; border-radius: 4px; border: 1px solid #e5e7eb;">
                        <span style="font-family: monospace; font-size: 13px; color: #1f2937;">${voiceId}</span>
                        <button type="button" class="delete-voice-btn" data-voice-id="${voiceId}" style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">ì‚­ì œ</button>
                    </div>
                `).join('');
                
                // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                customVoiceList.querySelectorAll('.delete-voice-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const voiceId = btn.getAttribute('data-voice-id');
                        await deleteCustomVoice(voiceId);
                    });
                });
            }
            
            async function addCustomVoice() {
                if (!customVoiceIdInput || !addVoiceIdBtn) return;
                
                const voiceId = customVoiceIdInput.value.trim();
                if (!voiceId) {
                    setStatus('ë³´ì´ìŠ¤ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // ê¸°ë³¸ í˜•ì‹ ê²€ì¦ (ì˜ë¬¸ì, ìˆ«ìë¡œë§Œ êµ¬ì„±)
                if (!/^[a-zA-Z0-9]+$/.test(voiceId)) {
                    setStatus('ë³´ì´ìŠ¤ IDëŠ” ì˜ë¬¸ìì™€ ìˆ«ìë¡œë§Œ êµ¬ì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                addVoiceIdBtn.disabled = true;
                addVoiceIdBtn.textContent = 'ì¶”ê°€ ì¤‘...';
                
                try {
                    const response = await fetch('/api/voices', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ voice_id: voiceId })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'ë³´ì´ìŠ¤ ID ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    customVoiceIdInput.value = '';
                    await loadCustomVoices();
                    
                    // ë³´ì´ìŠ¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒˆë¡œê³ ì¹¨
                    await refreshVoiceSelect();
                    
                    setStatus('ë³´ì´ìŠ¤ IDê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    console.error('[ë³´ì´ìŠ¤] ì¶”ê°€ ì‹¤íŒ¨:', error);
                    setStatus(error.message || 'ë³´ì´ìŠ¤ ID ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    addVoiceIdBtn.disabled = false;
                    addVoiceIdBtn.textContent = 'ì¶”ê°€';
                }
            }
            
            async function deleteCustomVoice(voiceId) {
                if (!confirm(`ë³´ì´ìŠ¤ ID "${voiceId}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/voices?voice_id=${encodeURIComponent(voiceId)}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'ë³´ì´ìŠ¤ ID ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                    
                    await loadCustomVoices();
                    
                    // ë³´ì´ìŠ¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒˆë¡œê³ ì¹¨
                    await refreshVoiceSelect();
                    
                    setStatus('ë³´ì´ìŠ¤ IDê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } catch (error) {
                    console.error('[ë³´ì´ìŠ¤] ì‚­ì œ ì‹¤íŒ¨:', error);
                    setStatus(error.message || 'ë³´ì´ìŠ¤ ID ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
            
            async function refreshVoiceSelect() {
                try {
                    const response = await fetch('/api/voices');
                    if (!response.ok) return;
                    const data = await response.json();
                    const voices = data.voices || [];
                    
                    if (voiceSelect) {
                        const currentValue = voiceSelect.value;
                        voiceSelect.innerHTML = voices.map(voice => 
                            `<option value="${voice.id}">${voice.name}</option>`
                        ).join('');
                        
                        // ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€ (ê°€ëŠ¥í•œ ê²½ìš°)
                        if (currentValue && Array.from(voiceSelect.options).some(opt => opt.value === currentValue)) {
                            voiceSelect.value = currentValue;
                        }
                    }
                } catch (error) {
                    console.error('[ë³´ì´ìŠ¤] ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                }
            }

            async function saveSettings() {
                if (!saveSettingsBtn) return;
                const payload = {
                    replicate_api_key: settingsReplicateInput.value.trim(),
                    elevenlabs_api_key: settingsElevenlabsInput.value.trim(),
                    gemini_api_key: settingsGeminiInput.value.trim(),
                    download_folder_path: settingsDownloadFolderInput ? settingsDownloadFolderInput.value.trim() : ''
                };
                saveSettingsBtn.disabled = true;
                saveSettingsBtn.textContent = 'ì €ì¥ ì¤‘...';
                try {
                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'ì„¤ì •ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                    settingsState = { ...settingsState, ...payload };
                    setStatus('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    closeSettingsModal();
                } catch (error) {
                    console.error('[ì„¤ì •] ì €ì¥ ì‹¤íŒ¨:', error);
                    setStatus(error.message || 'ì„¤ì •ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    saveSettingsBtn.disabled = false;
                    saveSettingsBtn.textContent = 'ì €ì¥';
                }
            }

            let currentJobId = null;
            let currentMode = 'animation';
            let promptItems = [];
            let imageItems = {};
            let pollingInterval = null;
            let isTestMode = false;
            
            // í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ ë³€ìˆ˜ (scriptInputì€ ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            const promptInputSection = document.getElementById('promptInputSection');
            const promptInputs = document.getElementById('promptInputs');
            
            // í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ìƒì„± í•¨ìˆ˜
            function updatePromptInputs(sentences) {
                if (!promptInputSection || !promptInputs) {
                    console.error('í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const selectAllBananaBtn = document.getElementById('selectAllBananaBtn');
                
                if (!sentences || sentences.length === 0) {
                    promptInputSection.style.display = 'none';
                    promptInputs.innerHTML = '';
                    if (selectAllBananaBtn) {
                        selectAllBananaBtn.style.display = 'none';
                    }
                    return;
                }
                
                promptInputSection.style.display = 'block';
                if (selectAllBananaBtn) {
                    selectAllBananaBtn.style.display = 'block';
                }
                
                // ê¸°ì¡´ ì…ë ¥ê°’ ì €ì¥
                const existingValues = {};
                promptInputs.querySelectorAll('textarea[data-index]').forEach(input => {
                    const index = parseInt(input.dataset.index, 10);
                    const value = input.value.trim();
                    if (value) {
                        existingValues[index] = value;
                    }
                });
                
                promptInputs.innerHTML = '';
                
                sentences.forEach((sentence, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.marginBottom = '16px';
                    itemDiv.style.padding = '12px';
                    itemDiv.style.background = '#fff';
                    itemDiv.style.borderRadius = '8px';
                    itemDiv.style.border = '1px solid #e5e7eb';
                    
                    // ì²´í¬ë°•ìŠ¤ì™€ ë¼ë²¨ì„ í¬í•¨í•˜ëŠ” ì»¨í…Œì´ë„ˆ
                    const labelContainer = document.createElement('div');
                    labelContainer.style.display = 'flex';
                    labelContainer.style.alignItems = 'center';
                    labelContainer.style.gap = '8px';
                    labelContainer.style.marginBottom = '6px';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `banana-checkbox-${index}`;
                    checkbox.dataset.index = index;
                    checkbox.className = 'banana-checkbox';
                    checkbox.style.width = '20px';
                    checkbox.style.height = '20px';
                    checkbox.style.cursor = 'pointer';
                    checkbox.style.accentColor = '#fbbf24';
                    checkbox.style.transition = 'transform 0.15s ease';
                    
                    const sentenceLabel = document.createElement('label');
                    sentenceLabel.htmlFor = `banana-checkbox-${index}`;
                    sentenceLabel.style.display = 'flex';
                    sentenceLabel.style.alignItems = 'center';
                    sentenceLabel.style.gap = '6px';
                    sentenceLabel.style.fontWeight = '600';
                    sentenceLabel.style.color = '#1f2937';
                    sentenceLabel.style.cursor = 'pointer';
                    sentenceLabel.innerHTML = `ë¬¸ì¥ ${index + 1}: <span>ğŸŒ</span>`;
                    
                    labelContainer.appendChild(checkbox);
                    labelContainer.appendChild(sentenceLabel);
                    
                    const sentenceText = document.createElement('div');
                    sentenceText.textContent = sentence;
                    sentenceText.dataset.sentenceIndex = index;
                    sentenceText.className = 'sentence-text';
                    sentenceText.style.color = '#4b5563';
                    sentenceText.style.fontSize = '14px';
                    sentenceText.style.marginBottom = '8px';
                    sentenceText.style.padding = '8px';
                    sentenceText.style.background = '#f9fafb';
                    sentenceText.style.borderRadius = '6px';
                    
                    const promptInput = document.createElement('textarea');
                    promptInput.dataset.index = index;
                    promptInput.placeholder = 'ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)';
                    promptInput.style.width = '100%';
                    promptInput.style.minHeight = '60px';
                    promptInput.style.padding = '10px';
                    promptInput.style.border = '1px solid #d1d5db';
                    promptInput.style.borderRadius = '6px';
                    promptInput.style.fontSize = '14px';
                    promptInput.style.resize = 'vertical';
                    promptInput.style.fontFamily = 'inherit';
                    
                    // ê¸°ì¡´ ì…ë ¥ê°’ ë³µì› (ì¸ë±ìŠ¤ê°€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°)
                    if (existingValues[index] !== undefined) {
                        promptInput.value = existingValues[index];
                    }
                    
                    itemDiv.appendChild(labelContainer);
                    itemDiv.appendChild(sentenceText);
                    itemDiv.appendChild(promptInput);
                    promptInputs.appendChild(itemDiv);
                });
            }
            
            // ë‚˜ë…¸ë°”ë‚˜ë‚˜ ì „ì²´ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
            // ë™ì ìœ¼ë¡œ ìƒì„±ëœ ë²„íŠ¼ì—ë„ ì‘ë™í•˜ë„ë¡ documentì— ì´ë²¤íŠ¸ ìœ„ì„
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'selectAllBananaBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const selectAllBananaBtn = e.target;
                    // í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ ë‚´ë¶€ì˜ ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì°¾ê¸°
                    const promptInputs = document.getElementById('promptInputs');
                    if (!promptInputs) {
                        console.warn('í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    const checkboxes = promptInputs.querySelectorAll('.banana-checkbox');
                    if (checkboxes.length === 0) {
                        console.warn('ì²´í¬ë°•ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²´í¬ë°•ìŠ¤ ê°œìˆ˜: 0');
                        return;
                    }
                    
                    console.log(`ì „ì²´ì„ íƒ ë²„íŠ¼ í´ë¦­: ${checkboxes.length}ê°œì˜ ì²´í¬ë°•ìŠ¤ ë°œê²¬`);
                    
                    // ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    const newCheckedState = !allChecked;
                    
                    console.log(`í˜„ì¬ ìƒíƒœ: ${allChecked ? 'ì „ì²´ ì²´í¬ë¨' : 'ì¼ë¶€ ë˜ëŠ” ì „ì²´ ë¯¸ì²´í¬'}, ìƒˆ ìƒíƒœ: ${newCheckedState ? 'ì „ì²´ ì²´í¬' : 'ì „ì²´ í•´ì œ'}`);
                    
                    // ì „ì²´ì„ íƒ ë˜ëŠ” ì „ì²´í•´ì œ (ì‹œê°ì  í”¼ë“œë°±ì„ ìœ„í•´ í•˜ë‚˜ì”© ì²˜ë¦¬)
                    checkboxes.forEach((checkbox, idx) => {
                        setTimeout(() => {
                            checkbox.checked = newCheckedState;
                            console.log(`ì²´í¬ë°•ìŠ¤ ${idx + 1} ì²´í¬ ìƒíƒœ: ${checkbox.checked}`);
                            
                            // ì²´í¬ ìƒíƒœ ë³€ê²½ ì‹œê°ì  í”¼ë“œë°±
                            checkbox.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                checkbox.style.transform = 'scale(1)';
                            }, 150);
                        }, idx * 20); // ìˆœì°¨ì ìœ¼ë¡œ ì²´í¬ë˜ë„ë¡ ì•½ê°„ì˜ ì§€ì—° ì¶”ê°€
                    });
                    
                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                    selectAllBananaBtn.textContent = allChecked ? 'ğŸŒ ë‚˜ë…¸ë°”ë‚˜ë‚˜ ì „ì²´ì„ íƒ' : 'ğŸŒ ë‚˜ë…¸ë°”ë‚˜ë‚˜ ì „ì²´í•´ì œ';
                    
                    // ë²„íŠ¼ í´ë¦­ í”¼ë“œë°±
                    selectAllBananaBtn.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        selectAllBananaBtn.style.transform = 'scale(1)';
                    }, 150);
                }
            });
            
            // íŒ¨í„´ ê¸°ë°˜ ëŒ€ë³¸ íŒŒì‹± í•¨ìˆ˜ (í•œêµ­ì–´ ë²ˆì—­ + ì˜ì–´ í”„ë¡¬í”„íŠ¸ í˜•ì‹)
            function parseScriptWithPrompts(scriptText) {
                const results = [];
                
                // íŒ¨í„´: [í•œêµ­ì–´ ë²ˆì—­] ... [ì˜ì–´ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸] ...
                // ì—¬ëŸ¬ ì¤„ì— ê±¸ì³ ìˆì„ ìˆ˜ ìˆìŒ
                // ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›: [í•œêµ­ì–´ ë²ˆì—­], [í•œêµ­ì–´], [Korean Translation], [English Image Prompt] ë“±
                const pattern = /\[(?:í•œêµ­ì–´\s*(?:ë²ˆì—­)?|Korean(?:\s*Translation)?)\]\s*([\s\S]*?)\s*\[(?:ì˜ì–´\s*(?:ì´ë¯¸ì§€\s*)?í”„ë¡¬í”„íŠ¸|English(?:\s*Image)?\s*Prompt)\]\s*([\s\S]*?)(?=\[(?:í•œêµ­ì–´|Korean)|$)/gi;
                
                let match;
                
                while ((match = pattern.exec(scriptText)) !== null) {
                    const koreanText = match[1].trim();
                    const englishPrompt = match[2].trim();
                    
                    if (koreanText && englishPrompt) {
                        results.push({
                            sentence: koreanText,
                            prompt: englishPrompt
                        });
                    }
                }
                
                // íŒ¨í„´ì´ ë°œê²¬ë˜ë©´ ê²°ê³¼ ë°˜í™˜
                if (results.length > 0) {
                    return results;
                }
                
                // íŒ¨í„´ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ë¬¸ì¥ ë¶„ë¦¬
                return null;
            }
            
            // ëŒ€ë³¸ ì…ë ¥ ì‹œ ë¬¸ì¥ë³„ í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ìƒì„±
            if (scriptInput && promptInputSection && promptInputs) {
                scriptInput.addEventListener('input', () => {
                    const scriptText = scriptInput.value.trim();
                    const selectAllBananaBtn = document.getElementById('selectAllBananaBtn');
                    
                    if (!scriptText) {
                        promptInputSection.style.display = 'none';
                        promptInputs.innerHTML = '';
                        if (selectAllBananaBtn) {
                            selectAllBananaBtn.style.display = 'none';
                        }
                        return;
                    }
                    
                    // ë¨¼ì € íŒ¨í„´ ê¸°ë°˜ íŒŒì‹± ì‹œë„
                    const parsedResults = parseScriptWithPrompts(scriptText);
                    
                    if (parsedResults && parsedResults.length > 0) {
                        // íŒ¨í„´ì´ ê°ì§€ëœ ê²½ìš°: í•œêµ­ì–´ ë¬¸ì¥ê³¼ ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ í•¨ê»˜ í‘œì‹œ
                        promptInputSection.style.display = 'block';
                        if (selectAllBananaBtn) {
                            selectAllBananaBtn.style.display = 'block';
                        }
                        promptInputs.innerHTML = '';
                        
                        parsedResults.forEach((item, index) => {
                            const itemDiv = document.createElement('div');
                            itemDiv.style.marginBottom = '16px';
                            itemDiv.style.padding = '12px';
                            itemDiv.style.background = '#fff';
                            itemDiv.style.borderRadius = '8px';
                            itemDiv.style.border = '1px solid #e5e7eb';
                            
                            // ì²´í¬ë°•ìŠ¤ì™€ ë¼ë²¨ì„ í¬í•¨í•˜ëŠ” ì»¨í…Œì´ë„ˆ
                            const labelContainer = document.createElement('div');
                            labelContainer.style.display = 'flex';
                            labelContainer.style.alignItems = 'center';
                            labelContainer.style.gap = '8px';
                            labelContainer.style.marginBottom = '6px';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.id = `banana-checkbox-${index}`;
                            checkbox.dataset.index = index;
                            checkbox.className = 'banana-checkbox';
                            checkbox.style.width = '20px';
                            checkbox.style.height = '20px';
                            checkbox.style.cursor = 'pointer';
                            checkbox.style.accentColor = '#fbbf24';
                            checkbox.style.transition = 'transform 0.15s ease';
                            
                            const sentenceLabel = document.createElement('label');
                            sentenceLabel.htmlFor = `banana-checkbox-${index}`;
                            sentenceLabel.style.display = 'flex';
                            sentenceLabel.style.alignItems = 'center';
                            sentenceLabel.style.gap = '6px';
                            sentenceLabel.style.fontWeight = '600';
                            sentenceLabel.style.color = '#1f2937';
                            sentenceLabel.style.cursor = 'pointer';
                            sentenceLabel.innerHTML = `ë¬¸ì¥ ${index + 1}: <span>ğŸŒ</span>`;
                            
                            labelContainer.appendChild(checkbox);
                            labelContainer.appendChild(sentenceLabel);
                            
                            const sentenceText = document.createElement('div');
                            sentenceText.textContent = item.sentence;
                            sentenceText.dataset.sentenceIndex = index;
                            sentenceText.className = 'sentence-text';
                            sentenceText.style.color = '#4b5563';
                            sentenceText.style.fontSize = '14px';
                            sentenceText.style.marginBottom = '8px';
                            sentenceText.style.padding = '8px';
                            sentenceText.style.background = '#f9fafb';
                            sentenceText.style.borderRadius = '6px';
                            
                            const promptInput = document.createElement('textarea');
                            promptInput.dataset.index = index;
                            promptInput.value = item.prompt; // ì˜ì–´ í”„ë¡¬í”„íŠ¸ ìë™ ì±„ìš°ê¸°
                            promptInput.placeholder = 'ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)';
                            promptInput.style.width = '100%';
                            promptInput.style.minHeight = '60px';
                            promptInput.style.padding = '10px';
                            promptInput.style.border = '1px solid #d1d5db';
                            promptInput.style.borderRadius = '6px';
                            promptInput.style.fontSize = '14px';
                            promptInput.style.resize = 'vertical';
                            promptInput.style.fontFamily = 'inherit';
                            
                            itemDiv.appendChild(labelContainer);
                            itemDiv.appendChild(sentenceText);
                            itemDiv.appendChild(promptInput);
                            promptInputs.appendChild(itemDiv);
                        });
                        
                        // íŒ¨í„´ ê°ì§€ ì™„ë£Œ ì‹œ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ í™œì„±í™”
                        generateImagesBtn.disabled = false;
                        setStatus('ëŒ€ë³¸ì´ ìë™ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ìƒì„±ì„ ì§„í–‰í•˜ì„¸ìš”.', 'success');
                    } else {
                        // íŒ¨í„´ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ë¬¸ì¥ ë¶„ë¦¬
                        const sentences = scriptText
                            .split(/[.!?ã€‚ï¼ï¼Ÿ]\s*/)
                            .map(s => s.trim())
                            .filter(s => s.length > 0);
                        
                        if (sentences.length === 0) {
                            promptInputSection.style.display = 'none';
                            promptInputs.innerHTML = '';
                            const selectAllBananaBtn = document.getElementById('selectAllBananaBtn');
                            if (selectAllBananaBtn) {
                                selectAllBananaBtn.style.display = 'none';
                            }
                            generateImagesBtn.disabled = true;
                            return;
                        }
                        
                        updatePromptInputs(sentences);
                        // ì¼ë°˜ ë¬¸ì¥ ë¶„ë¦¬ ì‹œì—ëŠ” í”„ë¡¬í”„íŠ¸ ìƒì„±ì´ í•„ìš”í•˜ë¯€ë¡œ ë²„íŠ¼ ë¹„í™œì„±í™” ìœ ì§€
                        generateImagesBtn.disabled = true;
                    }
                });
            } else {
                console.error('ëŒ€ë³¸ ì…ë ¥ë€ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            function openStageModal() {
                stageModal.classList.add('active');
                stageModal.classList.remove('stage-complete', 'stage-error');
                stageCloseBtn.style.display = 'none';
            }

            function closeStageModal() {
                stageModal.classList.remove('active');
            }

            stageCloseBtn.addEventListener('click', closeStageModal);

            function resetStageModal() {
                stageItems.forEach(item => {
                    item.classList.remove('completed', 'active', 'pending', 'error');
                    item.classList.add('pending');
                    const dot = item.querySelector('.status-dot');
                    if (dot) dot.style.background = '';
                });
                stageProgressBar.style.width = '0%';
                stageModal.classList.remove('stage-complete', 'stage-error');
                stageCloseBtn.style.display = 'none';
            }

            function updateStageModal(stageProgress, currentStage, status) {
                const completedCount = Math.min(stageProgress || 0, stageTotal);
                stageItems.forEach((item, index) => {
                    item.classList.remove('completed', 'active', 'pending', 'error');
                    if (index < completedCount) {
                        item.classList.add('completed');
                    } else if (index === completedCount && status === 'running') {
                        item.classList.add('active');
                    } else {
                        item.classList.add('pending');
                    }
                });

                if (status === 'error') {
                    stageModal.classList.add('stage-error');
                    stageItems[Math.min(completedCount, stageTotal - 1)].classList.add('error');
                    stageCloseBtn.style.display = 'block';
                } else if (status === 'completed') {
                    stageItems.forEach(item => item.classList.add('completed'));
                    stageProgressBar.style.width = '100%';
                    stageModal.classList.add('stage-complete');
                    stageCloseBtn.style.display = 'block';
                    return;
                }

            const percent = Math.min(completedCount / stageTotal, 1) * 100;
                stageProgressBar.style.width = `${percent}%`;
            }

            function setStatus(text, type = 'info') {
                if (!text) {
                    statusMessage.style.display = 'none';
                    statusMessage.textContent = '';
                    statusMessage.className = 'status-msg';
                    return;
                }
                statusMessage.style.display = 'block';
                statusMessage.textContent = text;
                statusMessage.className = `status-msg ${type}`;
            }

            function renderPromptRows() {
                promptTableBody.innerHTML = '';
                if (!promptItems.length) {
                    promptSection.style.display = 'none';
                    return;
                }
                promptSection.style.display = 'block';
                promptItems.forEach(item => {
                    const row = document.createElement('tr');

                    const sentenceCell = document.createElement('td');
                    sentenceCell.textContent = item.sentence;
                    row.appendChild(sentenceCell);

                    const promptCell = document.createElement('td');
                    const promptPre = document.createElement('pre');
                    promptPre.textContent = item.prompt || '';
                    promptCell.appendChild(promptPre);
                    row.appendChild(promptCell);

                    const imageCell = document.createElement('td');
                    const imageUrl = imageItems[item.index];
                    if (imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `Scene ${item.index}`;
                        img.className = 'prompt-img';
                        img.style.cursor = 'pointer';
                        img.addEventListener('click', () => {
                            showImagePreview(imageUrl, `Scene ${item.index} ì´ë¯¸ì§€`);
                        });
                        imageCell.appendChild(img);
                    } else {
                        const span = document.createElement('span');
                        span.textContent = 'ì´ë¯¸ì§€ ì—†ìŒ';
                        span.className = 'img-placeholder';
                        imageCell.appendChild(span);
                    }
                    row.appendChild(imageCell);

                    const actionCell = document.createElement('td');
                    const actionDiv = document.createElement('div');
                    actionDiv.style.display = 'flex';
                    actionDiv.style.gap = '8px';
                    
                    const regenBtn = document.createElement('button');
                    regenBtn.type = 'button';
                    regenBtn.textContent = 'ì¬ìƒì„±';
                    regenBtn.dataset.index = item.index;
                    regenBtn.className = 'regen-button';
                    if (!currentJobId) {
                        regenBtn.disabled = true;
                    }
                    actionDiv.appendChild(regenBtn);
                    
                    const videoBtn = document.createElement('button');
                    videoBtn.type = 'button';
                    videoBtn.textContent = 'ë¹„ë””ì˜¤ ìƒì„±';
                    videoBtn.dataset.index = item.index;
                    videoBtn.className = 'video-button';
                    videoBtn.style.background = '#10b981';
                    videoBtn.style.color = 'white';
                    if (!currentJobId) {
                        videoBtn.disabled = true;
                    }
                    actionDiv.appendChild(videoBtn);
                    
                    actionCell.appendChild(actionDiv);
                    row.appendChild(actionCell);

                    promptTableBody.appendChild(row);
                });
                bindRegenerateButtons();
                bindVideoButtons();
            }

            function bindVideoButtons() {
                document.querySelectorAll('.video-button').forEach(btn => {
                    btn.addEventListener('click', async (event) => {
                        const index = parseInt(event.currentTarget.dataset.index, 10);
                        if (!currentJobId || !index) {
                            setStatus('ë¨¼ì € í”„ë¡¬í”„íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ ì¤€ë¹„í•˜ì„¸ìš”.', 'error');
                            return;
                        }
                        const button = event.currentTarget;
                        const originalText = button.textContent;
                        button.disabled = true;
                        button.textContent = 'ìƒì„± ì¤‘...';
                        setStatus(`${index}ë²ˆ ì´ë¯¸ì§€ ë¹„ë””ì˜¤ ë³€í™˜ ì¤‘...`, 'info');

                        try {
                            const response = await fetch('/generate_video_from_image', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ job_id: currentJobId, scene_index: index })
                            });
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                const msg = errorData.error || 'ë¹„ë””ì˜¤ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                                throw new Error(msg);
                            }
                            const data = await response.json();
                            setStatus(`${index}ë²ˆ ì´ë¯¸ì§€ê°€ ë¹„ë””ì˜¤ë¡œ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        } catch (error) {
                            console.error('ë¹„ë””ì˜¤ ìƒì„± ì˜¤ë¥˜:', error);
                            setStatus(error.message || 'ë¹„ë””ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        } finally {
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    });
                });
            }

            function bindRegenerateButtons() {
                document.querySelectorAll('.regen-button').forEach(btn => {
                    btn.addEventListener('click', async (event) => {
                        const index = parseInt(event.currentTarget.dataset.index, 10);
                        if (!currentJobId || !index) {
                            setStatus('ë¨¼ì € í”„ë¡¬í”„íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ ì¤€ë¹„í•˜ì„¸ìš”.', 'error');
                            return;
                        }
                        const button = event.currentTarget;
                        const originalText = button.textContent;
                        button.disabled = true;
                        button.textContent = 'ìƒì„± ì¤‘...';
                        setStatus(`${index}ë²ˆ ì´ë¯¸ì§€ ì¬ìƒì„± ì¤‘...`, 'info');

                        try {
                            const response = await fetch('/regenerate_image', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ job_id: currentJobId, scene_index: index })
                            });
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                const msg = errorData.error || 'ì´ë¯¸ì§€ ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                                throw new Error(msg);
                            }
                            const data = await response.json();
                            imageItems[index] = data.image_url;
                            renderPromptRows();
                            setStatus(`${index}ë²ˆ ì´ë¯¸ì§€ê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        } catch (error) {
                            console.error(error);
                            setStatus(error.message || 'ì´ë¯¸ì§€ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    });
                });
            }

            function setActiveModeTab() {
                modeTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.mode === currentMode);
                });
                
                // ì»¤ìŠ¤í…€ ëª¨ë“œ ì„ íƒ ì‹œ í”„ë¡¬í”„íŠ¸ ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
                const customPromptSection = document.getElementById('customPromptSection');
                if (customPromptSection) {
                    customPromptSection.style.display = currentMode === 'custom' ? 'block' : 'none';
                }
            }

            function resetProgressPanel() {
                if (!progressPanel || !progressBar || !progressMessage || !progressLog) return;
                progressPanel.style.display = 'block';
                progressBar.value = 0;
                progressMessage.textContent = 'ì‘ì—…ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.';
                progressLog.innerHTML = '';
            }

            function appendProgressLog(text) {
                if (!progressLog) return;
                const li = document.createElement('li');
                li.textContent = text;
                progressLog.appendChild(li);
                progressLog.scrollTop = progressLog.scrollHeight;
            }

            function updateProgressBar(status, messageCount) {
                if (!progressBar) return;
                let value = 0;
                if (status === 'pending') value = 5;
                else if (status === 'running') value = Math.min(95, 10 + messageCount * 5);
                else if (status === 'completed') value = 100;
                else if (status === 'error') value = 100;
                progressBar.value = value;
            }

            setActiveModeTab();

            modeTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const newMode = this.dataset.mode;
                    if (!newMode) {
                        console.error('ëª¨ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤:', this);
                        return;
                    }
                    if (currentMode === newMode) return;
                    currentMode = newMode;
                    setActiveModeTab();
                    let modeName = 'ì• ë‹ˆë©”ì´ì…˜';
                    if (newMode === 'realistic') {
                        modeName = 'ì‹¤ì‚¬í™”';
                    } else if (newMode === 'realistic2') {
                        modeName = 'ì‹¤ì‚¬í™”2';
                    } else if (newMode === 'animation2') {
                        modeName = 'ì• ë‹ˆë©”ì´ì…˜2';
                    } else if (newMode === 'animation3') {
                        modeName = 'ì• ë‹ˆë©”ì´ì…˜3';
                    } else if (newMode === 'custom') {
                        modeName = 'ì»¤ìŠ¤í…€';
                    }
                    setStatus(`${modeName} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ${newMode === 'custom' ? 'ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.' : 'í”„ë¡¬í”„íŠ¸ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì„¸ìš”.'}`, 'info');
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    currentJobId = null;
                    promptItems = [];
                    imageItems = {};
                    renderPromptRows();
                    generateImagesBtn.disabled = true;
                    generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                    generateVideoBtn.disabled = true;
                    generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                    if (progressPanel) progressPanel.style.display = 'none';
                    resultContainer.innerHTML = '';
                });
            });

            // ì¬ì‹œì‘ ë²„íŠ¼
            const restartBtn = document.getElementById('restartBtn');
            if (restartBtn) {
                restartBtn.addEventListener('click', function() {
                    if (confirm('ëª¨ë“  ì‘ì—…ì„ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒë¶€í„° ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(API í‚¤ëŠ” ë³´ì¡´ë©ë‹ˆë‹¤)')) {
                        // pollingInterval ì •ë¦¬
                        if (pollingInterval) {
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                        }
                        
                        // ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
                        currentJobId = null;
                        promptItems = [];
                        imageItems = {};
                        isTestMode = false;
                        
                        // UI ì´ˆê¸°í™”
                        scriptInput.value = '';
                        promptInputSection.style.display = 'none';
                        promptInputs.innerHTML = '';
                        const selectAllBananaBtn = document.getElementById('selectAllBananaBtn');
                        if (selectAllBananaBtn) {
                            selectAllBananaBtn.style.display = 'none';
                        }
                        promptSection.style.display = 'none';
                        promptTableBody.innerHTML = '';
                        resultContainer.innerHTML = '';
                        if (progressPanel) progressPanel.style.display = 'none';
                        if (progressBar) progressBar.value = 0;
                        if (progressMessage) progressMessage.textContent = '';
                        if (progressLog) progressLog.innerHTML = '';
                        statusMessage.style.display = 'none';
                        statusMessage.textContent = '';
                        previewText.value = '';
                        previewAudio.src = '';
                        previewAudio.style.display = 'none';
                        previewStatus.textContent = '';
                        
                        // ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”
                        const customStylePromptInput = document.getElementById('customStylePrompt');
                        if (customStylePromptInput) {
                            customStylePromptInput.value = '';
                        }
                        
                        // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                        generateImagesBtn.disabled = true;
                        generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                        generateVideoBtn.disabled = true;
                        generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                        
                        // í…ŒìŠ¤íŠ¸ ëª¨ë“œ ë²„íŠ¼ ì´ˆê¸°í™”
                        if (testModeBtn) {
                            testModeBtn.style.background = '#10b981';
                            testModeBtn.textContent = 'í…ŒìŠ¤íŠ¸';
                        }
                        
                        // ëª¨ë“œ íƒ­ ì´ˆê¸°í™” (ì• ë‹ˆë©”ì´ì…˜ ëª¨ë“œë¡œ)
                        currentMode = 'animation';
                        modeTabs.forEach(tab => {
                            tab.classList.toggle('active', tab.dataset.mode === 'animation');
                        });
                        const customPromptSection = document.getElementById('customPromptSection');
                        if (customPromptSection) {
                            customPromptSection.style.display = 'none';
                        }
                        
                        // ìŠ¤í…Œì´ì§€ ëª¨ë‹¬ ì´ˆê¸°í™”
                        if (stageModal) {
                            stageModal.classList.remove('active', 'stage-complete', 'stage-error');
                            stageItems.forEach(item => {
                                item.classList.remove('completed', 'active', 'error');
                            });
                            if (stageProgressBar) {
                                stageProgressBar.style.width = '0%';
                            }
                            if (stageCloseBtn) {
                                stageCloseBtn.style.display = 'none';
                            }
                        }
                        
                        setStatus('ëª¨ë“  ì‘ì—…ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
                        
                        // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            }

            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ ë²„íŠ¼
            const testModeBtn = document.getElementById('testModeBtn');
            if (testModeBtn) {
                testModeBtn.addEventListener('click', function() {
                    isTestMode = !isTestMode;
                    if (isTestMode) {
                        this.style.background = '#ef4444';
                        this.textContent = 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ ON';
                        setStatus('í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ìƒì„± ì‹œ photo í´ë”ì˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'info');
                    } else {
                        this.style.background = '#10b981';
                        this.textContent = 'í…ŒìŠ¤íŠ¸';
                        setStatus('í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    }
                });
            }

            if (previewBtn) {
                previewBtn.addEventListener('click', async () => {
                    const voiceId = voiceSelect.value;
                    const text = previewText.value.trim();
                    previewBtn.disabled = true;
                    previewBtn.textContent = 'ìƒì„± ì¤‘...';
                    previewStatus.textContent = 'ë¯¸ë¦¬ ë“£ê¸°ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

                    try {
                        const params = new URLSearchParams({ voice_id: voiceId });
                        if (text) {
                            params.append('text', text);
                        }
                        const response = await fetch(`/preview_voice?${params.toString()}`);
                        if (!response.ok) {
                            throw new Error('ë¯¸ë¦¬ ë“£ê¸° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        previewAudio.src = url;
                        previewAudio.style.display = 'block';
                        previewAudio.play();
                        previewStatus.textContent = 'ë¯¸ë¦¬ ë“£ê¸°ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤.';
                    } catch (error) {
                        console.error(error);
                        previewStatus.textContent = 'ë¯¸ë¦¬ ë“£ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    } finally {
                        previewBtn.disabled = false;
                        previewBtn.textContent = 'ë¯¸ë¦¬ ë“£ê¸°';
                    }
                });
            }

            // í”„ë¡¬í”„íŠ¸ ìƒì„± ë²„íŠ¼ ì œê±°ë¨ - ëŒ€ë³¸ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ íŒ¨í„´ ê°ì§€ ë° ë¶„ë¥˜

            // ì´ë¯¸ì§€ ìƒì„± ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸
            let isGeneratingImages = false;
            
            generateImagesBtn.addEventListener('click', async () => {
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ë²„íŠ¼ í´ë¦­ë¨');
                
                // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€: ì´ë¯¸ ìƒì„± ì¤‘ì´ë©´ ë¬´ì‹œ
                if (isGeneratingImages) {
                    console.warn('[ì´ë¯¸ì§€ ìƒì„±] ì´ë¯¸ ìƒì„± ì¤‘ì…ë‹ˆë‹¤. ì¤‘ë³µ í˜¸ì¶œì„ ë¬´ì‹œí•©ë‹ˆë‹¤.');
                    return;
                }
                
                // ë²„íŠ¼ì´ disabled ìƒíƒœì¸ì§€ í™•ì¸
                if (generateImagesBtn.disabled) {
                    console.warn('[ì´ë¯¸ì§€ ìƒì„±] ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    setStatus('ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  íŒ¨í„´ì´ ê°ì§€ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // ì¦‰ì‹œ í”Œë˜ê·¸ ì„¤ì • ë° ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
                isGeneratingImages = true;
                generateImagesBtn.disabled = true;
                generateImagesBtn.textContent = 'ìƒì„± ì¤‘...';
                
                const scriptText = scriptInput.value.trim();
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ëŒ€ë³¸ ê¸¸ì´:', scriptText.length);
                
                if (!scriptText) {
                    console.warn('[ì´ë¯¸ì§€ ìƒì„±] ëŒ€ë³¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    setStatus('ëŒ€ë³¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                    isGeneratingImages = false;
                    generateImagesBtn.disabled = false;
                    generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                    return;
                }
                
                // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ ìˆ˜ì§‘
                const userPrompts = [];
                const sentences = [];
                const promptInputElements = promptInputs.querySelectorAll('textarea[data-index]');
                
                console.log('[ì´ë¯¸ì§€ ìƒì„±] í”„ë¡¬í”„íŠ¸ ì…ë ¥ ìš”ì†Œ ê°œìˆ˜:', promptInputElements.length);
                
                if (promptInputElements.length === 0) {
                    console.warn('[ì´ë¯¸ì§€ ìƒì„±] í”„ë¡¬í”„íŠ¸ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    setStatus('ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  íŒ¨í„´ì´ ê°ì§€ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'error');
                    isGeneratingImages = false;
                    generateImagesBtn.disabled = false;
                    generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                    return;
                }
                
                // ì •ë ¬ëœ ìˆœì„œë¡œ ìˆ˜ì§‘
                const sortedInputs = Array.from(promptInputElements).sort((a, b) => {
                    return parseInt(a.dataset.index, 10) - parseInt(b.dataset.index, 10);
                });
                
                const bananaModelFlags = []; // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥
                
                sortedInputs.forEach(input => {
                    const index = parseInt(input.dataset.index, 10);
                    const prompt = input.value.trim();
                    const itemDiv = input.parentElement;
                    
                    if (!itemDiv) {
                        console.warn(`ì¸ë±ìŠ¤ ${index}: itemDivë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    // ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸
                    const checkbox = itemDiv.querySelector(`.banana-checkbox[data-index="${index}"]`);
                    const isBananaModel = checkbox ? checkbox.checked : false;
                    bananaModelFlags.push(isBananaModel);
                    
                    // ë” ì•ˆì •ì ì¸ ë°©ë²•ìœ¼ë¡œ ë¬¸ì¥ ì°¾ê¸°
                    let sentence = '';
                    const sentenceDiv = itemDiv.querySelector('.sentence-text');
                    if (sentenceDiv) {
                        sentence = sentenceDiv.textContent.trim();
                    } else {
                        // fallback: data-sentence-indexë¡œ ì°¾ê¸°
                        const fallbackDiv = itemDiv.querySelector(`[data-sentence-index="${index}"]`);
                        if (fallbackDiv) {
                            sentence = fallbackDiv.textContent.trim();
                        } else {
                            // ë§ˆì§€ë§‰ fallback: background ìŠ¤íƒ€ì¼ë¡œ ì°¾ê¸°
                            const styleDiv = itemDiv.querySelector('div[style*="background: #f9fafb"]');
                            if (styleDiv) {
                                sentence = styleDiv.textContent.trim();
                            } else {
                                console.warn(`ì¸ë±ìŠ¤ ${index}: ë¬¸ì¥ divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, itemDiv);
                            }
                        }
                    }
                    
                    if (sentence) {
                        sentences.push(sentence);
                        userPrompts.push(prompt || null);
                    } else {
                        console.warn(`ì¸ë±ìŠ¤ ${index}: ë¬¸ì¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
                    }
                });
                
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ìˆ˜ì§‘ëœ ë¬¸ì¥ ê°œìˆ˜:', sentences.length);
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ìˆ˜ì§‘ëœ í”„ë¡¬í”„íŠ¸ ê°œìˆ˜:', userPrompts.length);
                
                if (sentences.length === 0) {
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    setStatus('ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    isGeneratingImages = false;
                    generateImagesBtn.disabled = false;
                    generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                    return;
                }
                
                // í”„ë¡¬í”„íŠ¸ê°€ ì—†ëŠ” ë¬¸ì¥ì´ ìˆìœ¼ë©´ ì˜¤ë¥˜
                const hasEmptyPrompts = userPrompts.some(p => !p || p.trim() === '');
                if (hasEmptyPrompts) {
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ë¹ˆ í”„ë¡¬í”„íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.');
                    setStatus('ëª¨ë“  ë¬¸ì¥ì— ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    isGeneratingImages = false;
                    generateImagesBtn.disabled = false;
                    generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                    return;
                }
                
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ê²€ì¦ ì™„ë£Œ, ì´ë¯¸ì§€ ìƒì„± ì‹œì‘');
                
                // ë²„íŠ¼ ìƒíƒœëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„¤ì •ë¨ (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€ë¥¼ ìœ„í•´)
                generateVideoBtn.disabled = true;
                imageItems = {};
                promptItems = sentences.map((sentence, idx) => ({
                    index: idx + 1,
                    sentence: sentence,
                    prompt: userPrompts[idx] || ''
                }));
                renderPromptRows();
                resultContainer.innerHTML = '';
                if (progressPanel) progressPanel.style.display = 'none';
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                setStatus('ì´ë¯¸ì§€ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                resetProgressPanel();
                resetStageModal();
                openStageModal();
                updateStageModal(0, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘', 'running');
                
                // AI ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ
                showAILoading('ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ì‹œì‘', `ì´ ${sentences.length}ê°œì˜ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤...`, 0);

                try {
                    // í”„ë¡¬í”„íŠ¸ ìƒì„± ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³  ë°”ë¡œ ì´ë¯¸ì§€ ìƒì„±
                    // API í‚¤ ì½ê¸°
                    const replicateApiKey = (settingsState.replicate_api_key || '').trim() || null;
                    const elevenlabsApiKey = (settingsState.elevenlabs_api_key || '').trim() || null;
                    const geminiApiKey = (settingsState.gemini_api_key || '').trim() || null;
                    
                    console.log('[ì´ë¯¸ì§€ ìƒì„±] API ìš”ì²­ ì‹œì‘:', {
                        sentencesCount: sentences.length,
                        promptsCount: userPrompts.length,
                        mode: currentMode,
                        hasReplicateKey: !!replicateApiKey,
                        hasElevenlabsKey: !!elevenlabsApiKey,
                        hasGeminiKey: !!geminiApiKey
                    });
                    
                    const customStylePromptInput = document.getElementById('customStylePrompt');
                    const customStylePrompt = (customStylePromptInput && currentMode === 'custom') ? customStylePromptInput.value.trim() : '';
                    
                    const response = await fetch('/generate_images_direct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            script_text: scriptText,
                            sentences: sentences,
                            prompts: userPrompts,
                            mode: currentMode,
                            custom_style_prompt: customStylePrompt,
                            test_mode: isTestMode,
                            replicate_api_key: replicateApiKey,
                            elevenlabs_api_key: elevenlabsApiKey,
                            gemini_api_key: geminiApiKey,
                            banana_model_flags: bananaModelFlags
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let msg = errorData.error || 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        if (response.status === 404) {
                            msg = 'ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ì£¼ì„¸ìš”.';
                        } else if (response.status === 400) {
                            msg = errorData.error || 'ìš”ì²­ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        }
                        throw new Error(msg);
                    }
                    const data = await response.json();
                    currentJobId = data.job_id;
                    
                    // ì§„í–‰ë„ í´ë§ ì‹œì‘
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                    }
                    
                    const pollImagesProgress = async () => {
                        try {
                            const statusResponse = await fetch(`/job_status/${currentJobId}`);
                            if (!statusResponse.ok) return;
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'completed') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                
                                // AI ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
                                hideAILoading();
                                
                                // ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                const job = statusData;
                                imageItems = {};
                                
                                if (job.image_files) {
                                    // ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œë¥¼ URLë¡œ ë³€í™˜
                                    Object.keys(job.image_files).forEach(idx => {
                                        const absPath = job.image_files[idx];
                                        // Windows ê²½ë¡œ êµ¬ë¶„ìë¥¼ ë¨¼ì € ìŠ¬ë˜ì‹œë¡œ ë³€í™˜
                                        let normalizedPath = absPath.replace(/\\/g, '/');
                                        // ì ˆëŒ€ ê²½ë¡œì—ì„œ static/ ë˜ëŠ” generated_assets/ ì´í›„ ë¶€ë¶„ ì¶”ì¶œ
                                        let relPath = normalizedPath;
                                        if (normalizedPath.includes('/static/')) {
                                            relPath = normalizedPath.split('/static/')[1];
                                        } else if (normalizedPath.includes('static/')) {
                                            relPath = normalizedPath.split('static/')[1];
                                        } else if (normalizedPath.includes('/generated_assets/')) {
                                            relPath = 'generated_assets/' + normalizedPath.split('/generated_assets/')[1];
                                        } else if (normalizedPath.includes('generated_assets/')) {
                                            relPath = 'generated_assets/' + normalizedPath.split('generated_assets/')[1];
                                        }
                                        imageItems[parseInt(idx)] = '/static/' + relPath;
                                    });
                                }
                                
                                // í”„ë¡¬í”„íŠ¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                                if (job.prompts && job.sentences) {
                                    promptItems = job.sentences.map((sentence, idx) => ({
                                        index: idx + 1,
                                        sentence: sentence,
                                        prompt: job.prompts[idx] || ''
                                    }));
                                } else {
                                    // jobì— promptsê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
                                    promptItems = sentences.map((sentence, idx) => ({
                                        index: idx + 1,
                                        sentence: sentence,
                                        prompt: userPrompts[idx] || ''
                                    }));
                                }
                                renderPromptRows();
                                
                                isGeneratingImages = false;
                                generateImagesBtn.disabled = false;
                                generateImagesBtn.textContent = 'ì´ë¯¸ì§€ ìƒì„±';
                                generateVideoBtn.disabled = false;
                                setStatus('ì´ë¯¸ì§€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ìƒ ìƒì„±ì„ ì§„í–‰í•˜ì„¸ìš”.', 'success');
                                updateStageModal(100, 'ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', 'completed');
                                // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                                if (currentJobId) {
                                    resultContainer.innerHTML = `
                                        <div class="card">
                                            <h2 style="margin-top:0; color:#1f2937;">âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!</h2>
                                            <p>ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ì¼ê´„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                            <button type="button" onclick="window.location.href='/download_images/${currentJobId}'" style="background:#10b981; margin-top:10px;">
                                                ì¼ê´„ ì‚¬ì§„ ë‹¤ìš´ë¡œë“œ
                                            </button>
                                        </div>
                                    `;
                                }
                            } else if (statusData.status === 'error') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                
                                // AI ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
                                hideAILoading();
                                
                                const errorMsg = statusData.error || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                                setStatus(errorMsg, 'error');
                                
                                // ë¡œê·¸ íŒŒì¼ í™•ì¸ ê¸°ëŠ¥ ì¶”ê°€
                                fetch('/api/debug/info')
                                    .then(res => res.json())
                                    .then(debugInfo => {
                                        if (debugInfo.log_file) {
                                            const logPath = debugInfo.log_file;
                                            console.log('[ë””ë²„ê·¸] ë¡œê·¸ íŒŒì¼ ìœ„ì¹˜:', logPath);
                                            // ì—ëŸ¬ ë©”ì‹œì§€ì— ë¡œê·¸ íŒŒì¼ ìœ„ì¹˜ ì¶”ê°€
                                            const logMsg = `\n\në¡œê·¸ íŒŒì¼ ìœ„ì¹˜: ${logPath}\në¬¸ì œê°€ ì§€ì†ë˜ë©´ ë¡œê·¸ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.`;
                                            setStatus(errorMsg + logMsg, 'error');
                                        }
                                    })
                                    .catch(err => console.error('ë¡œê·¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', err));
                                
                                isGeneratingImages = false;
                                generateImagesBtn.disabled = false;
                                generateImagesBtn.textContent = 'ì´ë¯¸ì§€ ìƒì„±';
                            } else if (statusData.status === 'running' || statusData.status === 'processing') {
                                // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
                                if (typeof statusData.stage_progress !== 'undefined') {
                                    updateStageModal(statusData.stage_progress, statusData.current_stage || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘', statusData.status);
                                }
                                
                                // AI ë¡œë”© ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
                                const currentStage = statusData.current_stage || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘';
                                const stageProgress = statusData.stage_progress || 0;
                                
                                // current_stageì—ì„œ "ì´ë¯¸ì§€ ìƒì„± ì¤‘... (N/M)" íŒ¨í„´ ì¶”ì¶œ
                                let progressText = currentStage;
                                let subText = 'AIê°€ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                                let progressPercent = null;
                                
                                const progressMatch = currentStage.match(/\((\d+)\/(\d+)\)/);
                                if (progressMatch) {
                                    const current = parseInt(progressMatch[1]);
                                    const total = parseInt(progressMatch[2]);
                                    progressPercent = Math.round((current / total) * 100);
                                    progressText = `ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘ (${current}/${total})`;
                                    subText = `${current}ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
                                } else if (stageProgress > 0) {
                                    progressPercent = stageProgress;
                                    progressText = `ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ì¤‘... (${stageProgress}%)`;
                                    subText = 'AIê°€ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                                }
                                
                                showAILoading(progressText, subText, progressPercent);
                                
                                if (statusData.progress && statusData.progress.length > 0) {
                                    if (progressLog) {
                                        progressLog.innerHTML = '';
                                        statusData.progress.forEach(msg => {
                                            const text = typeof msg === 'string' ? msg : msg.text || msg;
                                            appendProgressLog(text);
                                        });
                                    }
                                }
                            }
                        } catch (err) {
                            console.error('ì§„í–‰ë„ í™•ì¸ ì˜¤ë¥˜:', err);
                        }
                    };
                    
                    pollingInterval = setInterval(pollImagesProgress, 1000);
                    pollImagesProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                    
                } catch (error) {
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ì˜¤ë¥˜ ë°œìƒ:', error);
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                    
                    // AI ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
                    hideAILoading();
                    
                    setStatus(error.message || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    currentJobId = null;
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    isGeneratingImages = false;
                    generateImagesBtn.disabled = false;
                    generateImagesBtn.textContent = 'ì´ë¯¸ì§€ ìƒì„±';
                }
            });

            generateVideoBtn.addEventListener('click', async () => {
                if (!currentJobId) {
                    setStatus('ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
                    return;
                }
                const scriptText = scriptInput.value.trim();
                if (!scriptText) {
                    setStatus('ëŒ€ë³¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                generatePromptsBtn.disabled = true;
                generatePromptsBtn.textContent = 'ìƒì„± ì¤‘...';
                generateImagesBtn.disabled = true;
                generateVideoBtn.disabled = true;
                imageItems = {};
                promptItems = [];
                renderPromptRows();
                resultContainer.innerHTML = '';
                if (progressPanel) progressPanel.style.display = 'none';
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                setStatus('í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                resetProgressPanel();
                resetStageModal();
                openStageModal();
                updateStageModal(0, 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘', 'running');

                try {
                    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ ìˆ˜ì§‘
                    const userPrompts = [];
                    const promptInputElements = promptInputs.querySelectorAll('textarea[data-index]');
                    promptInputElements.forEach(input => {
                        const index = parseInt(input.dataset.index, 10);
                        const prompt = input.value.trim();
                        userPrompts[index] = prompt || null;
                    });
                    
                    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ê°€ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ìë™ ìƒì„±, í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì‚¬ìš©ì ì…ë ¥ ì‚¬ìš©
                    const hasUserPrompts = userPrompts.some(p => p !== null && p !== undefined && p !== '');
                    
                    const response = await fetch('/generate_prompts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            script_text: scriptText, 
                            mode: currentMode,
                            user_prompts: hasUserPrompts ? userPrompts : null
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const msg = errorData.error || 'í”„ë¡¬í”„íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        throw new Error(msg);
                    }
                    const data = await response.json();
                    currentJobId = data.job_id;
                    
                    // ë°±ì—”ë“œì—ì„œ ë¶„ë¦¬ëœ ë¬¸ì¥ ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ì—…ë°ì´íŠ¸
                    if (data.sentences && Array.isArray(data.sentences)) {
                        updatePromptInputs(data.sentences);
                    }
                    
                    // ì§„í–‰ë„ í´ë§ ì‹œì‘
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                    }
                    
                    const pollPromptsProgress = async () => {
                        try {
                            const statusResponse = await fetch(`/job_status/${currentJobId}`);
                            if (!statusResponse.ok) return;
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'completed') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                
                                // í”„ë¡¬í”„íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                const job = statusData;
                                if (job.prompts && job.sentences) {
                                    promptItems = job.sentences.map((sentence, idx) => ({
                                        index: idx + 1,
                                        sentence: sentence,
                                        prompt: job.prompts[idx] || ''
                                    }));
                                    renderPromptRows();
                                }
                                
                                generateImagesBtn.disabled = false;
                                setStatus('í”„ë¡¬í”„íŠ¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 2ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ì„¸ìš”.', 'success');
                                updateStageModal(100, 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ', 'completed');
                                generatePromptsBtn.disabled = false;
                                generatePromptsBtn.textContent = '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±';
                            } else if (statusData.status === 'error') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                setStatus(statusData.error || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                generatePromptsBtn.disabled = false;
                                generatePromptsBtn.textContent = '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±';
                            } else if (statusData.status === 'running' || statusData.status === 'processing') {
                                // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
                                if (typeof statusData.stage_progress !== 'undefined') {
                                    updateStageModal(statusData.stage_progress, statusData.current_stage || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘', statusData.status);
                                }
                                if (statusData.progress && statusData.progress.length > 0) {
                                    progressLog.innerHTML = '';
                                    statusData.progress.forEach(msg => {
                                        const text = typeof msg === 'string' ? msg : msg.text || msg;
                                        appendProgressLog(text);
                                    });
                                }
                            }
                        } catch (err) {
                            console.error('ì§„í–‰ë„ í™•ì¸ ì˜¤ë¥˜:', err);
                        }
                    };
                    
                    pollingInterval = setInterval(pollPromptsProgress, 1000);
                    pollPromptsProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                    
                } catch (error) {
                    console.error(error);
                    setStatus(error.message || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    currentJobId = null;
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    generatePromptsBtn.disabled = false;
                    generatePromptsBtn.textContent = '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±';
                }
            });

            generateVideoBtn.addEventListener('click', async () => {
                if (!currentJobId) {
                    setStatus('ë¨¼ì € í”„ë¡¬í”„íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
                    return;
                }
                generateVideoBtn.disabled = true;
                generateVideoBtn.textContent = 'ìƒì„± ì¤‘...';
                setStatus('ì˜ìƒ ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì§„í–‰ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'info');
                resetProgressPanel();
                resultContainer.innerHTML = '';
                resetStageModal();
                openStageModal();
                updateStageModal(0, 'ìì‚° ìƒì„±', 'running');

                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }

                const includeSubtitlesCheckbox = document.getElementById('includeSubtitlesCheckbox');
                const includeSubtitles = includeSubtitlesCheckbox ? includeSubtitlesCheckbox.checked : true;
                
                // API í‚¤ ì½ê¸°
                const replicateApiKey = (settingsState.replicate_api_key || '').trim() || null;
                const elevenlabsApiKey = (settingsState.elevenlabs_api_key || '').trim() || null;
                
                const customStylePromptInput = document.getElementById('customStylePrompt');
                const customStylePrompt = (customStylePromptInput && currentMode === 'custom') ? customStylePromptInput.value.trim() : '';
                
                const payload = {
                    job_id: currentJobId,
                    char_limit: charLimitInput.value,
                    voice_id: voiceSelect.value,
                    mode: currentMode,
                    custom_style_prompt: customStylePrompt,
                    include_subtitles: includeSubtitles,
                    replicate_api_key: replicateApiKey,
                    elevenlabs_api_key: elevenlabsApiKey
                };

                try {
                    const response = await fetch('/start_job', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const msg = errorData.error || 'ì˜ìƒ ìƒì„± ì‘ì—…ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                        throw new Error(msg);
                    }
                    const data = await response.json();
                    pollJob(data.job_id);
                } catch (error) {
                    console.error(error);
                    setStatus(error.message || 'ì˜ìƒ ìƒì„± ì‘ì—… ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    generateVideoBtn.disabled = false;
                    generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                    if (progressPanel) progressPanel.style.display = 'none';
                }
            });

            function pollJob(jobId) {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/job_status/${jobId}`);
                        if (!response.ok) {
                            throw new Error('ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        }
                        const data = await response.json();
                        updateProgressBar(data.status, data.progress.length || 0);
                        if (progressMessage) {
                            progressMessage.textContent = data.status === 'completed'
                                ? 'ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
                                : data.status === 'error'
                                    ? 'ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                                    : 'ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.';
                        }
                        if (progressLog) {
                            progressLog.innerHTML = '';
                            (data.progress || []).forEach(item => appendProgressLog(item.text));
                        }

                        if (typeof data.stage_progress !== 'undefined') {
                            updateStageModal(data.stage_progress, data.current_stage || '', data.status);
                        }

                        if (data.status === 'completed') {
                            // video_urlì´ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ ë‹¤ìš´ë¡œë“œ ë§í¬ í‘œì‹œ
                            if (data.video_url && data.video_url !== 'null' && data.video_url !== 'undefined') {
                                clearInterval(pollingInterval);
                                generateVideoBtn.disabled = false;
                                generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                                setStatus('ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                if (progressMessage) progressMessage.textContent = 'ğŸ‰ ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                stageModal.classList.add('stage-complete');
                                stageCloseBtn.style.display = 'block';
                                const videoPreviewUrl = data.video_url;
                                resultContainer.innerHTML = `
                                    <div class="card">
                                        <h2 style="margin-top:0; color:#1f2937;">ğŸ‰ ì˜ìƒ ìƒì„± ì™„ë£Œ!</h2>
                                        <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ ë¯¸ë¦¬ë³´ê¸°í•˜ì„¸ìš”.</p>
                                        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                                            <button type="button" onclick="showVideoPreview('${videoPreviewUrl}', 'ìƒì„±ëœ ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°')" style="background:#8b5cf6;">
                                                ì˜ìƒ ë¯¸ë¦¬ë³´ê¸°
                                            </button>
                                            <button type="button" onclick="downloadVideo('${jobId}')">ì˜ìƒ ë‹¤ìš´ë¡œë“œ</button>
                                            <button type="button" onclick="window.location.href='/download_images/${jobId}'" style="background:#10b981;">
                                                ì¼ê´„ ì‚¬ì§„ ë‹¤ìš´ë¡œë“œ
                                            </button>
                                            <button type="button" onclick="window.location.href='/download_subtitle/${jobId}'" style="background:#3b82f6;">
                                                ìë§‰(SRT) ë‹¤ìš´ë¡œë“œ
                                            </button>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // video_urlì´ ì—†ìœ¼ë©´ ì•„ì§ ìƒì„± ì¤‘ì´ê±°ë‚˜ ì˜¤ë¥˜
                                if (progressMessage) progressMessage.textContent = 'ì˜ìƒ ìƒì„± ì¤‘... (ìµœì¢… íŒŒì¼ í™•ì¸ ì¤‘)';
                            }
                        } else if (data.status === 'error') {
                            clearInterval(pollingInterval);
                            generateVideoBtn.disabled = false;
                            generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                            const errorMsg = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                            setStatus(`ì˜ìƒ ìƒì„± ì‹¤íŒ¨: ${errorMsg}`, 'error');
                            stageModal.classList.add('stage-error');
                            stageCloseBtn.style.display = 'block';
                        }
                    } catch (err) {
                        console.error(err);
                    }
                }, 2000);
            }

            if (openSettingsBtn) {
                openSettingsBtn.addEventListener('click', () => {
                    openSettingsModal();
                });
            }
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', closeSettingsModal);
            }
            if (cancelSettingsBtn) {
                cancelSettingsBtn.addEventListener('click', closeSettingsModal);
            }
            if (settingsModal) {
                settingsModal.addEventListener('click', (event) => {
                    if (event.target === settingsModal) {
                        closeSettingsModal();
                    }
                });
            }
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => {
                    saveSettings();
                });
            }
            
            // ë³´ì´ìŠ¤ ID ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
            if (addVoiceIdBtn) {
                addVoiceIdBtn.addEventListener('click', () => {
                    addCustomVoice();
                });
            }
            
            // ë³´ì´ìŠ¤ ID ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ ì²˜ë¦¬
            if (customVoiceIdInput) {
                customVoiceIdInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addCustomVoice();
                    }
                });
            }
            
            // í´ë” ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
            if (selectFolderBtn) {
                selectFolderBtn.addEventListener('click', async () => {
                    if (!selectFolderBtn) return;
                    const originalText = selectFolderBtn.textContent;
                    selectFolderBtn.disabled = true;
                    selectFolderBtn.textContent = 'ì„ íƒ ì¤‘...';
                    
                    try {
                        // ë¨¼ì € File System Access API ì‹œë„ (ìµœì‹  ë¸Œë¼ìš°ì €/ì›¹ë·°)
                        if (window.showDirectoryPicker) {
                            try {
                                const dirHandle = await window.showDirectoryPicker();
                                const folderPath = await dirHandle.getDirectoryHandle ? dirHandle.name : null;
                                
                                // File System Access APIëŠ” ì‹¤ì œ ê²½ë¡œë¥¼ ì§ì ‘ ì œê³µí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
                                // ì„œë²„ APIë¥¼ í†µí•´ ì²˜ë¦¬
                                const response = await fetch('/api/select_download_folder', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ use_native: true })
                                });
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.folder_path && settingsDownloadFolderInput) {
                                        settingsDownloadFolderInput.value = data.folder_path;
                                        settingsState.download_folder_path = data.folder_path;
                                        setStatus('í´ë”ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                    }
                                } else {
                                    throw new Error('ì„œë²„ì—ì„œ í´ë” ê²½ë¡œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                                }
                            } catch (dirError) {
                                // File System Access API ì‹¤íŒ¨ ì‹œ ì„œë²„ API ì‚¬ìš©
                                console.log('[í´ë” ì„ íƒ] File System Access API ì‹¤íŒ¨, ì„œë²„ API ì‚¬ìš©:', dirError);
                                await selectFolderViaServer();
                            }
                        } else {
                            // File System Access APIê°€ ì—†ìœ¼ë©´ ì„œë²„ API ì‚¬ìš©
                            await selectFolderViaServer();
                        }
                    } catch (error) {
                        console.error('[í´ë” ì„ íƒ] ì˜¤ë¥˜:', error);
                        setStatus(error.message || 'í´ë” ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    } finally {
                        selectFolderBtn.disabled = false;
                        selectFolderBtn.textContent = originalText;
                    }
                    
                    async function selectFolderViaServer() {
                        const response = await fetch('/api/select_download_folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || 'í´ë” ì„ íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        
                        const data = await response.json();
                        if (data.folder_path && settingsDownloadFolderInput) {
                            settingsDownloadFolderInput.value = data.folder_path;
                            settingsState.download_folder_path = data.folder_path;
                            setStatus('í´ë”ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    }
                });
            }
            
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && settingsModal && settingsModal.classList.contains('active')) {
                    closeSettingsModal();
                }
                if (event.key === 'Escape' && previewModal && previewModal.classList.contains('active')) {
                    previewModal.classList.remove('active');
                }
            });

            // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
            if (previewCloseBtn) {
                previewCloseBtn.addEventListener('click', () => {
                    if (previewModal) {
                        previewModal.classList.remove('active');
                    }
                });
            }

            // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            if (previewModal) {
                previewModal.addEventListener('click', (event) => {
                    if (event.target === previewModal) {
                        previewModal.classList.remove('active');
                    }
                });
            }

            loadSettings();

            // ëŒ€ë³¸ ìƒì„± ê¸°ëŠ¥
            const generateDraftBtn = document.getElementById('generateDraftBtn');
            const draftTopic = document.getElementById('draftTopic');
            const draftResult = document.getElementById('draftResult');
            const draftScriptContent = document.getElementById('draftScriptContent');
            const copyDraftBtn = document.getElementById('copyDraftBtn');
            
            const generateFinalBtn = document.getElementById('generateFinalBtn');
            const finalDraftScript = document.getElementById('finalDraftScript');
            const finalResult = document.getElementById('finalResult');
            const finalScriptContent = document.getElementById('finalScriptContent');
            const copyFinalBtn = document.getElementById('copyFinalBtn');
            const visualPromptResult = document.getElementById('visualPromptResult');
            const visualPromptContent = document.getElementById('visualPromptContent');
            const copyVisualPromptBtn = document.getElementById('copyVisualPromptBtn');
            const thumbnailPromptResult = document.getElementById('thumbnailPromptResult');
            const thumbnailPromptContent = document.getElementById('thumbnailPromptContent');
            const copyThumbnailBtn = document.getElementById('copyThumbnailBtn');
            const applyScriptBtn = document.getElementById('applyScriptBtn');
            let savedImagePrompts = []; // ìµœì¢… ëŒ€ë³¸ ìƒì„± ì‹œ ë°›ì€ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì €ì¥
            let savedFullResponse = ''; // ì „ì²´ ì‘ë‹µ ì €ì¥ (ì‹œê°í™” í”„ë¡¬í”„íŠ¸ìš©)
            
            // AI ë¡œë”© ì˜¤ë²„ë ˆì´ ì œì–´ í•¨ìˆ˜
            const aiLoadingOverlay = document.getElementById('aiLoadingOverlay');
            const aiLoadingText = document.getElementById('aiLoadingText');
            const aiLoadingSubtext = document.getElementById('aiLoadingSubtext');
            const aiLoadingProgress = document.getElementById('aiLoadingProgress');
            const aiLoadingProgressBar = document.getElementById('aiLoadingProgressBar');
            
            function showAILoading(text, subtext, progressPercent = null) {
                aiLoadingText.textContent = text || 'AIê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤...';
                aiLoadingSubtext.textContent = subtext || 'ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';
                
                // ì§„í–‰ë„ê°€ ìˆìœ¼ë©´ ì§„í–‰ë„ ë°” í‘œì‹œ
                if (progressPercent !== null && progressPercent !== undefined) {
                    if (aiLoadingProgress) aiLoadingProgress.style.display = 'block';
                    if (aiLoadingProgressBar) {
                        aiLoadingProgressBar.style.width = `${Math.min(100, Math.max(0, progressPercent))}%`;
                    }
                } else {
                    if (aiLoadingProgress) aiLoadingProgress.style.display = 'none';
                }
                
                aiLoadingOverlay.classList.add('active');
            }
            
            function hideAILoading() {
                aiLoadingOverlay.classList.remove('active');
                if (aiLoadingProgress) aiLoadingProgress.style.display = 'none';
                if (aiLoadingProgressBar) aiLoadingProgressBar.style.width = '0%';
            }

            // ê²€ìˆ˜ ëŒ€ë³¸ ìƒì„±
            generateDraftBtn.addEventListener('click', async function() {
                const topic = draftTopic.value.trim();
                if (!topic) {
                    alert('ì£¼ì œ/í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                generateDraftBtn.disabled = true;
                generateDraftBtn.textContent = 'ìƒì„± ì¤‘...';
                draftResult.style.display = 'none';
                showAILoading('ê²€ìˆ˜ ëŒ€ë³¸ ìƒì„± ì¤‘...', 'AIê°€ ì£¼ì œë¥¼ ë¶„ì„í•˜ê³  ëŒ€ë³¸ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤');

                try {
                    const response = await fetch('/api/generate_draft_script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topic: topic }),
                        signal: AbortSignal.timeout(300000) // 5ë¶„ íƒ€ì„ì•„ì›ƒ
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨');
                    }

                    draftScriptContent.textContent = data.script;
                    draftResult.style.display = 'block';
                    finalDraftScript.value = data.script; // ìë™ìœ¼ë¡œ ìµœì¢… ëŒ€ë³¸ ì…ë ¥ë€ì— ì±„ìš°ê¸°
                } catch (error) {
                    console.error('[ê²€ìˆ˜ ëŒ€ë³¸ ìƒì„±] ì˜¤ë¥˜:', error);
                    let errorMessage = 'ê²€ìˆ˜ ëŒ€ë³¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    
                    if (error.name === 'AbortError' || error.name === 'TimeoutError') {
                        errorMessage = 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì£¼ì œê°€ ë³µì¡í•˜ê±°ë‚˜ ì„œë²„ê°€ ë°”ì  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    } else if (error instanceof TypeError && error.message.includes('fetch')) {
                        errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    }
                    
                    alert('ì˜¤ë¥˜: ' + errorMessage);
                } finally {
                    hideAILoading();
                    generateDraftBtn.disabled = false;
                    generateDraftBtn.textContent = 'ê²€ìˆ˜ ëŒ€ë³¸ ìƒì„±';
                }
            });

            // ê²€ìˆ˜ ëŒ€ë³¸ ë³µì‚¬
            copyDraftBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(draftScriptContent.textContent).then(() => {
                    copyDraftBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                    setTimeout(() => {
                        copyDraftBtn.textContent = 'ğŸ“‹ ê²€ìˆ˜ ëŒ€ë³¸ ë³µì‚¬';
                    }, 2000);
                });
            });

            // ìµœì¢… ëŒ€ë³¸ ìƒì„±
            generateFinalBtn.addEventListener('click', async function() {
                const draftScript = finalDraftScript.value.trim();
                if (!draftScript) {
                    alert('ê²€ìˆ˜ ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                generateFinalBtn.disabled = true;
                generateFinalBtn.textContent = 'ì‘ì—… ì‹œì‘ ì¤‘...';
                finalResult.style.display = 'none';
                if (visualPromptResult) visualPromptResult.style.display = 'none';
                if (thumbnailPromptResult) thumbnailPromptResult.style.display = 'none';
                showAILoading('ìµœì¢… ëŒ€ë³¸ ìƒì„± ìš”ì²­ ì¤‘...', 'ì‘ì—… IDë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.');

                try {
                    // 1. ì‘ì—… ì‹œì‘ ìš”ì²­ (ë¹„ë™ê¸°)
                    const response = await fetch('/api/generate_final_script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ draft_script: draftScript })
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'ì‘ì—… ì‹œì‘ ì‹¤íŒ¨');
                    }

                    const data = await response.json();
                    const jobId = data.job_id;
                    
                    // 2. í´ë§ ì‹œì‘
                    showAILoading('ìµœì¢… ëŒ€ë³¸ ìƒì„± ì¤‘...', 'AIê°€ ì—´ì‹¬íˆ ê¸€ì„ ì“°ê³  ìˆìŠµë‹ˆë‹¤. (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
                    pollFinalScriptJob(jobId);

                } catch (error) {
                    console.error('ì˜¤ë¥˜:', error);
                    alert('ì˜¤ë¥˜: ' + error.message);
                    hideAILoading();
                    generateFinalBtn.disabled = false;
                    generateFinalBtn.textContent = 'ìµœì¢… ëŒ€ë³¸ ìƒì„±';
                }
            });

            // ìµœì¢… ëŒ€ë³¸ ì‘ì—… ìƒíƒœ í™•ì¸ í•¨ìˆ˜
            function pollFinalScriptJob(jobId) {
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch(`/job_status/${jobId}`);
                        if (!response.ok) return;
                        
                        const jobData = await response.json();
                        
                        // ë¡œë”© ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ (ì§„í–‰ë¥  í‘œì‹œ)
                        const progress = jobData.stage_progress || 0;
                        const msg = jobData.progress && jobData.progress.length > 0 
                            ? jobData.progress[jobData.progress.length - 1].text 
                            : 'ì²˜ë¦¬ ì¤‘...';
                        
                        // ë¡œë”© í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                        const loadingText = document.getElementById('aiLoadingText');
                        const loadingSubtext = document.getElementById('aiLoadingSubtext');
                        if (loadingText) loadingText.textContent = `ìƒì„± ì¤‘... (${progress}%)`;
                        if (loadingSubtext) loadingSubtext.textContent = msg;

                        if (jobData.status === 'completed') {
                            clearInterval(interval);
                            hideAILoading();
                            
                            // ê²°ê³¼ í‘œì‹œ
                            finalScriptContent.textContent = jobData.final_script || "ê²°ê³¼ ì—†ìŒ";
                            finalResult.style.display = 'block';
                            
                            // ì‹œê°í™” í”„ë¡¬í”„íŠ¸ í‘œì‹œ
                            if (jobData.visual_prompt) {
                                visualPromptContent.textContent = jobData.visual_prompt;
                                visualPromptResult.style.display = 'block';
                            }
                            
                            // ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
                            if (jobData.thumbnail_prompt && thumbnailPromptContent && thumbnailPromptResult) {
                                thumbnailPromptContent.textContent = jobData.thumbnail_prompt;
                                thumbnailPromptResult.style.display = 'block';
                            }
                            
                            // ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹ (ëŒ€ë³¸ ì ìš© ì‹œ ì‚¬ìš©)
                            savedImagePrompts = jobData.image_prompts || [];
                            savedFullResponse = jobData.visual_prompt || '';
                            
                            generateFinalBtn.disabled = false;
                            generateFinalBtn.textContent = 'ìµœì¢… ëŒ€ë³¸ ìƒì„±';
                            applyScriptBtn.disabled = false;
                            
                            alert("ëŒ€ë³¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                            
                        } else if (jobData.status === 'error') {
                            clearInterval(interval);
                            hideAILoading();
                            alert(`ì˜¤ë¥˜ ë°œìƒ: ${jobData.error}`);
                            generateFinalBtn.disabled = false;
                            generateFinalBtn.textContent = 'ìµœì¢… ëŒ€ë³¸ ìƒì„±';
                        }
                        
                    } catch (e) {
                        console.error("Polling error", e);
                    }
                }, 2000); // 2ì´ˆë§ˆë‹¤ í™•ì¸
            }

            // ìµœì¢… ëŒ€ë³¸ ë³µì‚¬
            copyFinalBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(finalScriptContent.textContent).then(() => {
                    copyFinalBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                    setTimeout(() => {
                        copyFinalBtn.textContent = 'ğŸ“‹ ìµœì¢… ëŒ€ë³¸ ë³µì‚¬';
                    }, 2000);
                });
            });

            // ì‹œê°í™” í”„ë¡¬í”„íŠ¸ ë³µì‚¬
            copyVisualPromptBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(visualPromptContent.textContent).then(() => {
                    copyVisualPromptBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                    setTimeout(() => {
                        copyVisualPromptBtn.textContent = 'ğŸ“‹ ì‹œê°í™” í”„ë¡¬í”„íŠ¸ ë³µì‚¬';
                    }, 2000);
                });
            });

            // ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ ë³µì‚¬
            if (copyThumbnailBtn && thumbnailPromptContent) {
                copyThumbnailBtn.addEventListener('click', function() {
                    navigator.clipboard.writeText(thumbnailPromptContent.textContent).then(() => {
                        copyThumbnailBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                        setTimeout(() => {
                            copyThumbnailBtn.textContent = 'ğŸ“‹ ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ ë³µì‚¬';
                        }, 2000);
                    });
                });
            }

            // ë©”ì¸ ì˜ì—­ì— ëŒ€ë³¸ ì ìš©
            applyScriptBtn.addEventListener('click', function() {
                const finalScript = finalScriptContent.textContent;
                if (!finalScript) {
                    alert('ìµœì¢… ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìµœì¢… ëŒ€ë³¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const scriptInput = document.getElementById('script');
                
                // ì‹œê°í™” í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ëŒ€ë³¸ ì…ë ¥ë€ì— ì ìš©, ì—†ìœ¼ë©´ ìˆœìˆ˜ ëŒ€ë³¸ ì ìš©
                const visualPrompt = visualPromptContent.textContent;
                if (visualPrompt && visualPrompt.trim()) {
                    // ì‹œê°í™” í”„ë¡¬í”„íŠ¸ë¥¼ ëŒ€ë³¸ ì…ë ¥ë€ì— ì ìš©
                    scriptInput.value = visualPrompt;
                    console.log('[ëŒ€ë³¸ ì ìš©] ì‹œê°í™” í”„ë¡¬í”„íŠ¸ë¥¼ ëŒ€ë³¸ ì…ë ¥ë€ì— ì ìš©');
                } else {
                    // ì‹œê°í™” í”„ë¡¬í”„íŠ¸ê°€ ì—†ìœ¼ë©´ ìˆœìˆ˜ ëŒ€ë³¸ ì ìš©
                    scriptInput.value = finalScript;
                    console.log('[ëŒ€ë³¸ ì ìš©] ìˆœìˆ˜ ëŒ€ë³¸ì„ ëŒ€ë³¸ ì…ë ¥ë€ì— ì ìš©');
                }
                
                // ëŒ€ë³¸ ì…ë ¥ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°í•˜ì—¬ ë¬¸ì¥ ë¶„ë¦¬ ë° í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ìƒì„±
                const inputEvent = new Event('input', { bubbles: true });
                scriptInput.dispatchEvent(inputEvent);
                
                // ì‹œê°í™” í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ì—ë„ ì˜ì–´ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì±„ìš°ê¸°
                if (savedImagePrompts && savedImagePrompts.length > 0) {
                    setTimeout(() => {
                        const promptInputElements = document.querySelectorAll('#promptInputs textarea[data-index]');
                        console.log('[ëŒ€ë³¸ ì ìš©] í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ê°œìˆ˜:', promptInputElements.length, 'ì €ì¥ëœ í”„ë¡¬í”„íŠ¸ ê°œìˆ˜:', savedImagePrompts.length);
                        
                        promptInputElements.forEach((input, idx) => {
                            if (idx < savedImagePrompts.length && savedImagePrompts[idx]) {
                                input.value = savedImagePrompts[idx];
                                console.log(`[ëŒ€ë³¸ ì ìš©] í”„ë¡¬í”„íŠ¸ ${idx + 1} ì ìš©:`, savedImagePrompts[idx].substring(0, 50) + '...');
                            }
                        });
                        
                        // í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
                        promptInputElements.forEach(input => {
                            const changeEvent = new Event('input', { bubbles: true });
                            input.dispatchEvent(changeEvent);
                        });
                    }, 800); // ë¬¸ì¥ ë¶„ë¦¬ í›„ í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ìƒì„± ëŒ€ê¸°
                }
                
                // [ì¤‘ìš”] ë·° ì „í™˜
                switchView('videoGenView');
                
                // ì‹œê°ì  í”¼ë“œë°±
                applyScriptBtn.textContent = 'âœ“ ì ìš©ë¨';
                applyScriptBtn.style.background = '#10b981';
                setTimeout(() => {
                    applyScriptBtn.textContent = 'ğŸš€ ì˜ìƒ ì œì‘ìœ¼ë¡œ ëŒ€ë³¸ ë³´ë‚´ê¸°';
                    applyScriptBtn.style.background = '#059669';
                }, 2000);
                
                alert("ëŒ€ë³¸ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.");
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // [ì¶”ê°€] ì œëª©/ë‚´ìš© ìƒì„±ê¸° ë¡œì§
            const generateMetadataBtn = document.getElementById('generateMetadataBtn');
            const metadataResult = document.getElementById('metadataResult');
            const targetScriptStatus = document.getElementById('targetScriptStatus');

            // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡
            window.checkScriptAvailability = function() {
                const finalScript = document.getElementById('finalScriptContent').textContent;
                const draftScript = document.getElementById('finalDraftScript').value;
                
                if (finalScript && finalScript !== "ê²°ê³¼ ì—†ìŒ") {
                    targetScriptStatus.innerHTML = "âœ… <b>ìµœì¢… ëŒ€ë³¸</b>ì´ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
                    targetScriptStatus.style.color = "#059669";
                    generateMetadataBtn.disabled = false;
                } else if (draftScript) {
                    targetScriptStatus.innerHTML = "âš ï¸ ìµœì¢… ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤. <b>ê²€ìˆ˜ ëŒ€ë³¸</b>ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.";
                    targetScriptStatus.style.color = "#d97706";
                    generateMetadataBtn.disabled = false;
                } else {
                    targetScriptStatus.innerHTML = "âŒ ë¶„ì„í•  ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤. ëŒ€ë³¸ì„ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.";
                    targetScriptStatus.style.color = "#dc2626";
                    generateMetadataBtn.disabled = true;
                }
            }

            // ë©”íƒ€ë°ì´í„° ìƒì„± ë²„íŠ¼ í´ë¦­
            if (generateMetadataBtn) {
                generateMetadataBtn.addEventListener('click', async function() {
                    // 1. ë¶„ì„í•  ëŒ€ë³¸ ê°€ì ¸ì˜¤ê¸° (ìµœì¢… ëŒ€ë³¸ ìš°ì„ , ì—†ìœ¼ë©´ ê²€ìˆ˜ ëŒ€ë³¸)
                    let scriptText = document.getElementById('finalScriptContent').textContent;
                    if (!scriptText || scriptText === "ê²°ê³¼ ì—†ìŒ") {
                        scriptText = document.getElementById('finalDraftScript').value;
                    }
                    if (!scriptText) {
                        alert("ë¶„ì„í•  ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // UI ìƒíƒœ ë³€ê²½
                    generateMetadataBtn.disabled = true;
                    generateMetadataBtn.textContent = "ì „ëµ ë¶„ì„ ì¤‘... (Gemini)";
                    metadataResult.style.display = 'none';
                    showAILoading("ì„±ì¥ ì „ëµ ìˆ˜ë¦½ ì¤‘...", "íƒ€ê²Ÿ ì˜¤ë””ì–¸ìŠ¤ ë¶„ì„ ë° SEO ìµœì í™” ì§„í–‰ ì¤‘");

                    try {
                        const response = await fetch('/api/generate_metadata', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ script: scriptText })
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || "ìƒì„± ì‹¤íŒ¨");
                        }

                        const data = await response.json();

                        // ê²°ê³¼ ë°”ì¸ë”©
                        document.getElementById('metaAnalysis').textContent = data.analysis;
                        document.getElementById('metaTitleSearch').textContent = data.titles.search;
                        document.getElementById('metaTitleHook').textContent = data.titles.hook;
                        document.getElementById('metaTitleStory').textContent = data.titles.story;
                        document.getElementById('metaDescription').value = data.description;
                        document.getElementById('metaTags').textContent = data.tags;
                        document.getElementById('metaThumbText').textContent = data.thumbnail.text;
                        document.getElementById('metaThumbImage').textContent = data.thumbnail.image_guide;

                        metadataResult.style.display = 'block';

                    } catch (e) {
                        console.error(e);
                        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                    } finally {
                        hideAILoading();
                        generateMetadataBtn.disabled = false;
                        generateMetadataBtn.textContent = "âœ¨ ì „ëµ ë¶„ì„ ë° ìƒì„± ì‹œì‘";
                    }
                });
            }

            // í…ìŠ¤íŠ¸ ë³µì‚¬ í—¬í¼ í•¨ìˆ˜ (ì „ì—­ìœ¼ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ windowì— í• ë‹¹)
            window.copyText = function(element) {
                const text = element.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const original = element.style.backgroundColor;
                    element.style.backgroundColor = "#dcfce7"; // ë…¹ìƒ‰ ë°°ê²½ ê¹œë¹¡ì„
                    setTimeout(() => {
                        element.style.backgroundColor = "transparent";
                    }, 300);
                });
            }

            // í•µì‹¬ ê°€ì¹˜ ë¶„ì„ ë³µì‚¬
            const copyAnalysisBtn = document.getElementById('copyAnalysisBtn');
            if (copyAnalysisBtn) {
                copyAnalysisBtn.addEventListener('click', function() {
                    const text = document.getElementById('metaAnalysis').textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        copyAnalysisBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                        copyAnalysisBtn.style.background = '#10b981';
                        setTimeout(() => {
                            copyAnalysisBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                            copyAnalysisBtn.style.background = '#10b981';
                        }, 2000);
                    });
                });
            }

            // ì œëª© ë³µì‚¬ ë²„íŠ¼ë“¤ (ì œëª© í´ë¦­ë„ ê°€ëŠ¥í•˜ì§€ë§Œ ë²„íŠ¼ë„ ì¶”ê°€)
            document.querySelectorAll('.copyTitleBtn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const text = document.getElementById(targetId).textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        this.textContent = 'âœ“ ë³µì‚¬ë¨';
                        this.style.background = '#10b981';
                        setTimeout(() => {
                            this.textContent = 'ğŸ“‹ ë³µì‚¬';
                            this.style.background = '#10b981';
                        }, 2000);
                    });
                });
            });

            // ì„¤ëª…ë€ ë³µì‚¬
            const copyDescriptionBtn = document.getElementById('copyDescriptionBtn');
            if (copyDescriptionBtn) {
                copyDescriptionBtn.addEventListener('click', function() {
                    const text = document.getElementById('metaDescription').value;
                    navigator.clipboard.writeText(text).then(() => {
                        copyDescriptionBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                        copyDescriptionBtn.style.background = '#10b981';
                        setTimeout(() => {
                            copyDescriptionBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                            copyDescriptionBtn.style.background = '#10b981';
                        }, 2000);
                    });
                });
            }

            // íƒœê·¸ ë³µì‚¬
            const copyTagsBtn = document.getElementById('copyTagsBtn');
            if (copyTagsBtn) {
                copyTagsBtn.addEventListener('click', function() {
                    const text = document.getElementById('metaTags').textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        copyTagsBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                        copyTagsBtn.style.background = '#10b981';
                        setTimeout(() => {
                            copyTagsBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                            copyTagsBtn.style.background = '#10b981';
                        }, 2000);
                    });
                });
            }

            // ì¸ë„¤ì¼ í…ìŠ¤íŠ¸ ë³µì‚¬
            const copyThumbTextBtn = document.getElementById('copyThumbTextBtn');
            if (copyThumbTextBtn) {
                copyThumbTextBtn.addEventListener('click', function() {
                    const text = document.getElementById('metaThumbText').textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        copyThumbTextBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                        copyThumbTextBtn.style.background = '#10b981';
                        setTimeout(() => {
                            copyThumbTextBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                            copyThumbTextBtn.style.background = '#10b981';
                        }, 2000);
                    });
                });
            }

            // ì¸ë„¤ì¼ ì´ë¯¸ì§€ ê°€ì´ë“œ ë³µì‚¬
            const copyThumbImageBtn = document.getElementById('copyThumbImageBtn');
            if (copyThumbImageBtn) {
                copyThumbImageBtn.addEventListener('click', function() {
                    const text = document.getElementById('metaThumbImage').textContent;
                    navigator.clipboard.writeText(text).then(() => {
                        copyThumbImageBtn.textContent = 'âœ“ ë³µì‚¬ë¨';
                        copyThumbImageBtn.style.background = '#10b981';
                        setTimeout(() => {
                            copyThumbImageBtn.textContent = 'ğŸ“‹ ë³µì‚¬';
                            copyThumbImageBtn.style.background = '#10b981';
                        }, 2000);
                    });
                });
            }

            // ============================================================
            // ì¸ë„¤ì¼ ì œì‘ ê¸°ëŠ¥
            // ============================================================
            const thumbnailScriptRef = document.getElementById('thumbnailScriptRef');
            const loadScriptBtn = document.getElementById('loadScriptBtn');
            const thumbnailCharacterSetting = document.getElementById('thumbnailCharacterSetting');
            const thumbnailReferenceImage = document.getElementById('thumbnailReferenceImage');
            const thumbnailReferencePreview = document.getElementById('thumbnailReferencePreview');
            const thumbnailReferenceImg = document.getElementById('thumbnailReferenceImg');
            const removeReferenceImageBtn = document.getElementById('removeReferenceImageBtn');
            const generateThumbnailConceptsBtn = document.getElementById('generateThumbnailConceptsBtn');
            const thumbnailConceptsResult = document.getElementById('thumbnailConceptsResult');
            const thumbnailConceptsContainer = document.getElementById('thumbnailConceptsContainer');
            const thumbnailImageResult = document.getElementById('thumbnailImageResult');
            const thumbnailImageContainer = document.getElementById('thumbnailImageContainer');
            
            let referenceImageBase64 = null;

            // ëŒ€ë³¸ ë¶ˆëŸ¬ì˜¤ê¸°
            if (loadScriptBtn) {
                loadScriptBtn.addEventListener('click', function() {
                    const finalScript = document.getElementById('finalScriptContent').textContent;
                    const draftScript = document.getElementById('finalDraftScript').value;
                    
                    if (finalScript && finalScript !== "ê²°ê³¼ ì—†ìŒ") {
                        thumbnailScriptRef.value = finalScript;
                        alert("ìµœì¢… ëŒ€ë³¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    } else if (draftScript) {
                        thumbnailScriptRef.value = draftScript;
                        alert("ê²€ìˆ˜ ëŒ€ë³¸ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    } else {
                        alert("ë¶ˆëŸ¬ì˜¬ ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ëŒ€ë³¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.");
                    }
                });
            }

            // ì°¸ì¡° ì´ë¯¸ì§€ ì—…ë¡œë“œ
            if (thumbnailReferenceImage) {
                thumbnailReferenceImage.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            referenceImageBase64 = event.target.result;
                            thumbnailReferenceImg.src = referenceImageBase64;
                            thumbnailReferencePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // ì°¸ì¡° ì´ë¯¸ì§€ ì œê±°
            if (removeReferenceImageBtn) {
                removeReferenceImageBtn.addEventListener('click', function() {
                    referenceImageBase64 = null;
                    thumbnailReferenceImage.value = '';
                    thumbnailReferencePreview.style.display = 'none';
                });
            }

            // ì¸ë„¤ì¼ ê¸°íšì•ˆ ìƒì„±
            if (generateThumbnailConceptsBtn) {
                generateThumbnailConceptsBtn.addEventListener('click', async function() {
                    const scriptText = thumbnailScriptRef.value.trim();
                    if (!scriptText) {
                        alert("ì°¸ì¡° ëŒ€ë³¸ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.");
                        return;
                    }

                    generateThumbnailConceptsBtn.disabled = true;
                    generateThumbnailConceptsBtn.textContent = "ê¸°íšì•ˆ ìƒì„± ì¤‘...";
                    thumbnailConceptsResult.style.display = 'none';
                    thumbnailImageResult.style.display = 'none';
                    
                    showAILoading('ì¸ë„¤ì¼ ê¸°íšì•ˆ ìƒì„± ì¤‘...', 'AIê°€ í´ë¦­ë¥ ì„ ë†’ì¼ ìˆ˜ ìˆëŠ” ì¸ë„¤ì¼ ì»¨ì…‰ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.');

                    try {
                        const response = await fetch('/api/generate_thumbnail_concepts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                script: scriptText,
                                character_setting: thumbnailCharacterSetting.value.trim()
                            })
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || "ê¸°íšì•ˆ ìƒì„± ì‹¤íŒ¨");
                        }

                        const data = await response.json();
                        
                        // ê¸°íšì•ˆ ì¹´ë“œ ìƒì„±
                        thumbnailConceptsContainer.innerHTML = '';
                        data.concepts.forEach((concept, index) => {
                            const card = document.createElement('div');
                            card.className = 'card';
                            card.style.border = '2px solid #e5e7eb';
                            card.style.padding = '20px';
                            card.innerHTML = `
                                <h4 style="margin-top:0; color: #2563eb;">ì˜µì…˜ ${index + 1}</h4>
                                
                                <label>ìƒí™© ë¬˜ì‚¬</label>
                                <textarea class="concept-situation" data-index="${index}" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">${concept.situation || ''}</textarea>
                                
                                <label style="margin-top: 16px;">í…ìŠ¤íŠ¸(ì¹´í”¼)</label>
                                <input type="text" class="concept-copy" data-index="${index}" value="${concept.copy || ''}" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                
                                <label style="margin-top: 16px;">ë‚˜ë…¸ë°”ë‚˜ë‚˜ PROìš© í”„ë¡¬í”„íŠ¸</label>
                                <textarea class="concept-prompt" data-index="${index}" style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; font-family: monospace;">${concept.prompt || ''}</textarea>
                                
                                <button type="button" class="generateThumbnailImageBtn success-btn" data-index="${index}" style="width: 100%; margin-top: 16px; padding: 12px;">
                                    ğŸ–¼ï¸ ì´ ì»¨ì…‰ìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„±
                                </button>
                            `;
                            thumbnailConceptsContainer.appendChild(card);
                        });

                        thumbnailConceptsResult.style.display = 'block';

                    } catch (e) {
                        console.error(e);
                        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                    } finally {
                        hideAILoading();
                        generateThumbnailConceptsBtn.disabled = false;
                        generateThumbnailConceptsBtn.textContent = "âœ¨ ì¸ë„¤ì¼ ê¸°íšì•ˆ ìƒì„±í•˜ê¸°";
                    }
                });
            }

            // ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„
            document.addEventListener('click', async function(e) {
                if (e.target.classList.contains('generateThumbnailImageBtn')) {
                    const index = parseInt(e.target.dataset.index);
                    const card = e.target.closest('.card');
                    
                    const situation = card.querySelector(`.concept-situation[data-index="${index}"]`).value.trim();
                    const copy = card.querySelector(`.concept-copy[data-index="${index}"]`).value.trim();
                    const prompt = card.querySelector(`.concept-prompt[data-index="${index}"]`).value.trim();
                    
                    if (!prompt) {
                        alert("í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }

                    e.target.disabled = true;
                    e.target.textContent = "ì´ë¯¸ì§€ ìƒì„± ì¤‘...";
                    thumbnailImageResult.style.display = 'none';
                    
                    showAILoading('ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìƒì„± ì¤‘...', 'AIê°€ ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 0);

                    try {
                        const response = await fetch('/api/generate_thumbnail_image', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                prompt: prompt,
                                reference_image: referenceImageBase64
                            })
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.error || "ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨");
                        }

                        const data = await response.json();
                        
                        // ì´ë¯¸ì§€ í‘œì‹œ
                        thumbnailImageContainer.innerHTML = `
                            <div style="margin-bottom: 20px;">
                                <h4>ìƒì„±ëœ ì¸ë„¤ì¼</h4>
                                <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; display: inline-block;">
                                    <img src="data:${data.mime_type || 'image/png'};base64,${data.image}" alt="ì¸ë„¤ì¼" style="max-width: 100%; max-height: 600px; border-radius: 8px;">
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <p><strong>ìƒí™© ë¬˜ì‚¬:</strong> ${situation}</p>
                                <p><strong>ì¹´í”¼:</strong> <span style="font-size: 24px; font-weight: bold; color: #dc2626;">${copy}</span></p>
                            </div>
                            <button type="button" id="downloadThumbnailBtn" class="success-btn" style="width: 100%; margin-top: 16px; padding: 12px;">
                                ğŸ’¾ ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ
                            </button>
                        `;
                        
                        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ (Blob ì‚¬ìš©)
                        const downloadBtn = document.getElementById('downloadThumbnailBtn');
                        if (downloadBtn) {
                            downloadBtn.addEventListener('click', function() {
                                try {
                                    // base64ë¥¼ Blobìœ¼ë¡œ ë³€í™˜
                                    const byteCharacters = atob(data.image);
                                    const byteNumbers = new Array(byteCharacters.length);
                                    for (let i = 0; i < byteCharacters.length; i++) {
                                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                                    }
                                    const byteArray = new Uint8Array(byteNumbers);
                                    const blob = new Blob([byteArray], { type: data.mime_type || 'image/png' });
                                    
                                    // Blob URL ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                                    const url = URL.createObjectURL(blob);
                                    const link = document.createElement('a');
                                    link.href = url;
                                    link.download = `thumbnail_${Date.now()}.png`;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(url);
                                } catch (err) {
                                    console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', err);
                                    alert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                                }
                            });
                        }
                        
                        thumbnailImageResult.style.display = 'block';
                        thumbnailImageResult.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    } catch (e) {
                        console.error(e);
                        alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                    } finally {
                        hideAILoading();
                        e.target.disabled = false;
                        e.target.textContent = "ğŸ–¼ï¸ ì´ ì»¨ì…‰ìœ¼ë¡œ ì´ë¯¸ì§€ ìƒì„±";
                    }
                }
            });

            // ì¸ë„¤ì¼ íƒ­ ì „í™˜ ì‹œ ëŒ€ë³¸ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°
            const originalSwitchView = window.switchView;
            window.switchView = function(viewId) {
                originalSwitchView(viewId);
                if (viewId === 'thumbnailView') {
                    // ëŒ€ë³¸ ìë™ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œë„
                    setTimeout(() => {
                        if (loadScriptBtn) {
                            loadScriptBtn.click();
                        }
                    }, 100);
                }
            };
        });
    </script>
    </main>
    </div>
</div>
</body>
</html>
