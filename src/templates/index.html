<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì…€íŒœ AI ì• ë‹ˆë©”ì´ì…˜ ë©”ì´ì»¤</title>
    <style>
        body { font-family: 'Noto Sans KR', Arial, sans-serif; background:#f5f7fb; margin:0; padding:0; }
        main { max-width: 1000px; margin: 40px auto 60px; padding: 0 20px; }
        h1 { color: #1f2937; margin-bottom: 10px; }
        p { color:#4b5563; }
        textarea { width: 100%; min-height: 200px; padding: 14px; border:1px solid #d1d5db; border-radius:8px; resize: vertical; background:#fff; font-size:15px; line-height:1.5; }
        input[type="number"], select, input[type="text"] { width: 100%; padding: 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:15px; }
        label { display:block; margin:16px 0 6px; font-weight:600; color:#1f2937; }
        button { background:#2563eb; color:#fff; border:none; border-radius:8px; padding:12px 18px; cursor:pointer; font-size:15px; transition: background 0.2s ease; }
        button:hover { background:#1d4ed8; }
        button:disabled { background:#9ca3af; cursor:not-allowed; }
        .settings-button { background:#111827; font-weight:600; }
        .settings-button:hover { background:#030712; }
        .card { background:#fff; border-radius:12px; box-shadow:0 12px 24px rgba(15,23,42,0.08); padding:28px; margin-bottom:24px; }
        .button-row { display:flex; flex-wrap:wrap; gap:12px; margin:18px 0 0; }
        .preview-controls { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 0; }
        .preview-controls input { flex: 1 1 300px; }
        audio { width:100%; margin-top:10px; }
        .mode-tabs { display:flex; gap:10px; margin-top:14px; }
        .mode-tab { padding:8px 18px; border-radius:999px; border:1px solid #93c5fd; background:#e0f2fe; color:#2563eb; font-weight:600; cursor:pointer; transition: all 0.2s ease; }
        .mode-tab.active { background:#2563eb; color:#fff; border-color:#2563eb; }
        .status-msg { margin-top:18px; padding:14px 16px; border-radius:10px; display:none; font-weight:600; }
        .status-msg.info { background:#dbeafe; color:#1d4ed8; }
        .status-msg.success { background:#dcfce7; color:#15803d; }
        .status-msg.error { background:#fee2e2; color:#b91c1c; }
        #promptSection { display:none; }
        table { width:100%; border-collapse: collapse; margin-top: 16px; }
        th, td { border:1px solid #e5e7eb; padding:12px; text-align:left; vertical-align:top; }
        th { background:#f3f4f6; color:#1f2937; font-weight:700; }
        pre { white-space: pre-wrap; word-break: break-word; margin:0; font-family: inherit; }
        .img-placeholder { color:#9ca3af; font-style:italic; }
        img.prompt-img { max-width:180px; border-radius:10px; box-shadow:0 6px 12px rgba(15,23,42,0.15); }
        #progressPanel { display:none; }
        #progressPanel ul { list-style:none; padding-left:0; margin-top:12px; max-height:220px; overflow-y:auto; }
        #progressPanel li { padding:8px 0; border-bottom:1px solid #e5e7eb; font-size:14px; color:#4b5563; }
        progress { width:100%; height:16px; border-radius:999px; background:#e0e7ff; overflow:hidden; }
        progress::-webkit-progress-bar { background:#e0e7ff; border-radius:999px; }
        progress::-webkit-progress-value { background:#2563eb; border-radius:999px; }
        #stageModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
        #stageModal.active { display:flex; }
        .stage-modal-content { background:#fff; border-radius:12px; padding:24px 28px; width:320px; box-shadow:0 20px 40px rgba(15,23,42,0.18); }
        .stage-modal-content h3 { margin:0; color:#1f2937; font-size:18px; }
        .stage-list { list-style:none; padding:0; margin:18px 0 16px; }
        .stage-item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #e5e7eb; font-weight:600; color:#4b5563; }
        .stage-item:last-child { border-bottom:none; }
        .stage-item .status-dot { width:12px; height:12px; border-radius:50%; margin-left:12px; background:#d1d5db; transition:background 0.3s ease; }
        .stage-item.completed { color:#15803d; }
        .stage-item.completed .status-dot { background:#22c55e; }
        .stage-item.active { color:#1d4ed8; }
        .stage-item.active .status-dot { background:#2563eb; }
        .stage-item.error { color:#b91c1c; }
        .stage-item.error .status-dot { background:#ef4444; }
        .stage-progress-track { width:100%; height:6px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:6px; }
        .stage-progress-bar { height:100%; width:0; background:#2563eb; transition:width 0.3s ease; }
        .stage-close { margin-top:18px; width:100%; padding:10px 14px; border:none; border-radius:8px; background:#1f2937; color:#fff; font-weight:600; cursor:pointer; display:none; }
        #stageModal.stage-complete .stage-close,
        #stageModal.stage-error .stage-close { display:block; }
        .settings-modal { position:fixed; inset:0; background:rgba(15,23,42,0.55); display:none; align-items:center; justify-content:center; z-index:10000; padding:16px; }
        .settings-modal.active { display:flex; }
        .settings-modal-content { width:100%; max-width:420px; background:#fff; border-radius:16px; padding:24px; box-shadow:0 25px 45px rgba(15,23,42,0.2); position:relative; }
        .settings-modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .settings-modal-header h2 { margin:0; color:#111827; }
        .settings-close { background:transparent; border:none; font-size:26px; line-height:1; cursor:pointer; color:#6b7280; }
        .settings-close:hover { color:#111827; }
        .settings-modal-content label { margin-top:12px; }
        .settings-modal-content input { margin-top:4px; }
        .settings-helper { color:#6b7280; font-size:13px; margin:4px 0 0; }
        .settings-actions { display:flex; justify-content:flex-end; margin-top:20px; gap:10px; }
        @media (max-width:768px) {
            .button-row { flex-direction:column; }
            .preview-controls { flex-direction:column; align-items:stretch; }
            img.prompt-img { width:100%; max-width:none; }
        }
    </style>
</head>
<body>
<main>
    <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <h1 style="margin:0;">ì…€íŒœ AI ì• ë‹ˆë©”ì´ì…˜ ë©”ì´ì»¤</h1>
                <button type="button" id="testModeBtn" style="background:#10b981; padding:8px 16px; font-size:14px;">í…ŒìŠ¤íŠ¸</button>
            </div>
            <button type="button" id="openSettingsBtn" class="settings-button" title="API í‚¤ ì„¤ì •">âš™ï¸ ì„¤ì •</button>
        </div>
        <p>ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì„ ì„ íƒí•œ ë’¤, ë‹¨ê³„ë³„ë¡œ í”„ë¡¬í”„íŠ¸ â†’ ì´ë¯¸ì§€ â†’ ì˜ìƒì„ ìƒì„±í•˜ì„¸ìš”.</p>

        <label for="script">ëŒ€ë³¸ ì…ë ¥</label>
        <textarea id="script" placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>

        <div id="promptInputSection" style="display:none; margin-top:20px;">
            <label>ë¬¸ì¥ë³„ ì˜ì–´ í”„ë¡¬í”„íŠ¸ ì…ë ¥ (ì„ íƒì‚¬í•­)</label>
            <p style="color:#6b7280; font-size:14px; margin:6px 0 12px;">ê° ë¬¸ì¥ì— ëŒ€í•œ ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜, ì•„ë˜ '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±' ë²„íŠ¼ì„ ëˆŒëŸ¬ ìë™ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div id="promptInputs" style="max-height:400px; overflow-y:auto; border:1px solid #d1d5db; border-radius:8px; padding:12px; background:#f9fafb;"></div>
        </div>

        <label for="limit">ìë§‰ ì¤„ë°”ê¿ˆ ê¸€ì ìˆ˜ (ê¸°ë³¸ 15ì)</label>
        <input type="number" id="limit" value="30" min="5">

        <label for="voiceSelect">ì¼ë˜ë¸ë©ìŠ¤ ë³´ì´ìŠ¤ ì„ íƒ</label>
        <select id="voiceSelect">
            {% for voice in voices %}
                <option value="{{ voice.id }}" {% if default_voice_id == voice.id %}selected{% endif %}>
                    {{ voice.name }} ({{ voice.id }})
                </option>
            {% endfor %}
        </select>

        <div class="mode-tabs">
            <button type="button" class="mode-tab active" data-mode="animation">ì• ë‹ˆë©”ì´ì…˜</button>
            <button type="button" class="mode-tab" data-mode="realistic">ì‹¤ì‚¬í™”</button>
        </div>

        <div class="preview-controls">
            <button type="button" id="previewBtn">ë¯¸ë¦¬ ë“£ê¸°</button>
            <input type="text" id="previewText" placeholder="ë¯¸ë¦¬ ë“£ê¸° ë¬¸ì¥ (ì„ íƒ ì…ë ¥)">
        </div>
        <audio id="previewAudio" controls style="display:none;"></audio>
        <div id="previewStatus" style="color:#6b7280; margin-top:6px;"></div>

        <div class="button-row">
            <button type="button" id="generateImagesBtn" disabled>ì´ë¯¸ì§€ ìƒì„±</button>
            <button type="button" id="generateVideoBtn" disabled>ì˜ìƒ ìƒì„±</button>
        </div>
        
        <div style="margin-top: 12px; display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="includeSubtitlesCheckbox" checked style="width: 18px; height: 18px; cursor: pointer;">
            <label for="includeSubtitlesCheckbox" style="cursor: pointer; color: #374151; font-size: 14px;">ìë§‰ í¬í•¨</label>
        </div>

        <div id="statusMessage" class="status-msg info"></div>
    </div>

    <section id="promptSection" class="card">
        <h2 style="margin-top:0; color:#1f2937;">ë¬¸ì¥ë³„ í”„ë¡¬í”„íŠ¸ ë° ì´ë¯¸ì§€</h2>
        <table id="promptTable">
            <thead>
                <tr>
                    <th style="width:30%;">ì›ë³¸ ë¬¸ì¥</th>
                    <th style="width:40%;">ìƒì„±ëœ ì˜ì–´ í”„ë¡¬í”„íŠ¸</th>
                    <th style="width:20%;">ì´ë¯¸ì§€</th>
                    <th style="width:10%;">ì¡°ì‘</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <div id="progressPanel" class="card">
        <h2 style="margin-top:0; color:#1f2937;">ì˜ìƒ ìƒì„± ì§„í–‰ë„</h2>
        <progress id="progressBar" value="0" max="100"></progress>
        <div id="progressMessage" style="margin-top:12px; font-weight:600; color:#1f2937;"></div>
        <ul id="progressLog"></ul>
    </div>

    <div id="resultContainer">
        {% if video_filename %}
        <div class="card">
            <h2 style="margin-top:0; color:#1f2937;">ğŸ‰ ì˜ìƒ ìƒì„± ì™„ë£Œ!</h2>
            <p>ì•„ë˜ ë§í¬ë¥¼ ëˆŒëŸ¬ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p>
            {% set video_job_id = video_filename.replace('final_video_', '').replace('.mp4', '') %}
            <a href="/download_video/{{ video_job_id }}" style="display:inline-block; margin-top:10px;">
                <button type="button">{{ video_filename }} ë‹¤ìš´ë¡œë“œ</button>
            </a>
        </div>
        {% endif %}
    </div>
</main>

<div id="settingsModal" class="settings-modal">
    <div class="settings-modal-content">
        <div class="settings-modal-header">
            <h2>ì„¤ì •</h2>
            <button type="button" class="settings-close" id="closeSettingsBtn" aria-label="ë‹«ê¸°">&times;</button>
        </div>
        <p class="settings-helper">ì…ë ¥í•œ í‚¤ëŠ” ë¡œì»¬ Application Support/AppData í´ë”ì— ì €ì¥ë˜ë©°, ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <label for="settingsReplicateKey">Replicate ì´ë¯¸ì§€ ìƒì„± API í‚¤</label>
        <input type="password" id="settingsReplicateKey" placeholder="r8_..." autocomplete="off">
        <p class="settings-helper">Replicate í‚¤ê°€ ì—†ìœ¼ë©´ ì´ë¯¸ì§€ ìƒì„±ì´ ì œí•œë©ë‹ˆë‹¤.</p>
        <label for="settingsElevenlabsKey">ElevenLabs TTS API í‚¤</label>
        <input type="password" id="settingsElevenlabsKey" placeholder="sk-..." autocomplete="off">
        <p class="settings-helper">ElevenLabs í‚¤ê°€ ì—†ìœ¼ë©´ TTSê°€ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        <label for="settingsOpenaiKey">OpenAI í”„ë¡¬í”„íŠ¸ ìƒì„± API í‚¤</label>
        <input type="password" id="settingsOpenaiKey" placeholder="sk-..." autocomplete="off">
        <p class="settings-helper">OpenAI í‚¤ëŠ” ëŒ€ë³¸ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ìë™ ìƒì„±ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
        <label for="settingsDownloadFolder">ë‹¤ìš´ë¡œë“œ í´ë” ê²½ë¡œ (ì„ íƒì‚¬í•­)</label>
        <div style="display:flex; gap:8px; align-items:center;">
            <input type="text" id="settingsDownloadFolder" placeholder="ì˜ˆ: /Users/username/Downloads ë˜ëŠ” C:\Users\username\Downloads" autocomplete="off" style="flex:1;">
            <button type="button" id="selectFolderBtn" style="background:#6366f1; padding:10px 16px; white-space:nowrap;">í´ë” ì„ íƒ</button>
        </div>
        <p class="settings-helper">ë‹¤ìš´ë¡œë“œ í´ë” ê²½ë¡œë¥¼ ì§€ì •í•˜ë©´ ìƒì„±ëœ íŒŒì¼ì´ í•´ë‹¹ í´ë”ë¡œ ë³µì‚¬ë©ë‹ˆë‹¤. í´ë” ì„ íƒ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì§ì ‘ ì„ íƒí•˜ê±°ë‚˜, ê²½ë¡œë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <div class="settings-actions">
            <button type="button" id="cancelSettingsBtn" style="background:#e5e7eb; color:#111827;">ì·¨ì†Œ</button>
            <button type="button" id="saveSettingsBtn">ì €ì¥</button>
        </div>
    </div>
</div>

<div id="stageModal">
    <div class="stage-modal-content">
        <h3>ì‘ì—… ì§„í–‰ ìƒíƒœ</h3>
        <ul class="stage-list">
            <li class="stage-item pending" data-stage="1" data-stage-key="ìì‚° ìƒì„±">
                <span>1. ìì‚° ìƒì„±</span>
                <span class="status-dot"></span>
            </li>
            <li class="stage-item pending" data-stage="2" data-stage-key="íƒ€ì„ìŠ¤íƒ¬í”„ ê³„ì‚°">
                <span>2. íƒ€ì„ìŠ¤íƒ¬í”„ ê³„ì‚°</span>
                <span class="status-dot"></span>
            </li>
            <li class="stage-item pending" data-stage="3" data-stage-key="ì˜ìƒ í•©ì„±">
                <span>3. ì˜ìƒ í•©ì„±</span>
                <span class="status-dot"></span>
            </li>
        </ul>
        <div class="stage-progress-track">
            <div class="stage-progress-bar" id="stageProgressBar"></div>
        </div>
        <button type="button" class="stage-close" id="stageCloseBtn">ë‹«ê¸°</button>
    </div>
</div>

<script>
        // ë¹„ë””ì˜¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„)
        async function downloadVideo(jobId) {
            try {
                const statusMessage = document.getElementById('statusMessage');
                if (statusMessage) {
                    statusMessage.style.display = 'block';
                    statusMessage.textContent = 'ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì¤‘...';
                    statusMessage.className = 'status-msg info';
                }
                // ì§ì ‘ ë§í¬ë¡œ ì´ë™í•˜ì—¬ ë‹¤ìš´ë¡œë“œ (ì¬ìƒ ë°©ì§€)
                const downloadUrl = `/download_video/${jobId}`;
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `video_${jobId}.mp4`;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // ì•½ê°„ì˜ ì§€ì—° í›„ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    if (statusMessage) {
                        statusMessage.textContent = 'ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.';
                        statusMessage.className = 'status-msg success';
                    }
                }, 500);
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                const statusMessage = document.getElementById('statusMessage');
                if (statusMessage) {
                    statusMessage.style.display = 'block';
                    statusMessage.textContent = 'ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    statusMessage.className = 'status-msg error';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const previewBtn = document.getElementById('previewBtn');
            const voiceSelect = document.getElementById('voiceSelect');
            const previewAudio = document.getElementById('previewAudio');
            const previewText = document.getElementById('previewText');
            const previewStatus = document.getElementById('previewStatus');

            const scriptInput = document.getElementById('script');
            const charLimitInput = document.getElementById('limit');
            const generateImagesBtn = document.getElementById('generateImagesBtn');
            const generateVideoBtn = document.getElementById('generateVideoBtn');
            const statusMessage = document.getElementById('statusMessage');
            const promptSection = document.getElementById('promptSection');
            const promptTableBody = document.querySelector('#promptTable tbody');
            const progressPanel = document.getElementById('progressPanel');
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressLog = document.getElementById('progressLog');
            const resultContainer = document.getElementById('resultContainer');
            const modeTabs = document.querySelectorAll('.mode-tab');
            const stageModal = document.getElementById('stageModal');
            const stageItems = Array.from(stageModal.querySelectorAll('.stage-item'));
            const stageProgressBar = document.getElementById('stageProgressBar');
            const stageCloseBtn = document.getElementById('stageCloseBtn');
            const stageTotal = stageItems.length;
            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const settingsReplicateInput = document.getElementById('settingsReplicateKey');
            const settingsElevenlabsInput = document.getElementById('settingsElevenlabsKey');
            const settingsOpenaiInput = document.getElementById('settingsOpenaiKey');
            const settingsDownloadFolderInput = document.getElementById('settingsDownloadFolder');
            const selectFolderBtn = document.getElementById('selectFolderBtn');
            let settingsState = {
                replicate_api_key: '',
                elevenlabs_api_key: '',
                openai_api_key: '',
                download_folder_path: ''
            };

            function populateSettingsForm() {
                if (!settingsReplicateInput || !settingsElevenlabsInput || !settingsOpenaiInput) return;
                settingsReplicateInput.value = settingsState.replicate_api_key || '';
                settingsElevenlabsInput.value = settingsState.elevenlabs_api_key || '';
                settingsOpenaiInput.value = settingsState.openai_api_key || '';
                if (settingsDownloadFolderInput) {
                    settingsDownloadFolderInput.value = settingsState.download_folder_path || '';
                }
            }

            function openSettingsModal() {
                if (!settingsModal) return;
                populateSettingsForm();
                settingsModal.classList.add('active');
            }

            function closeSettingsModal() {
                if (!settingsModal) return;
                settingsModal.classList.remove('active');
            }

            async function loadSettings() {
                try {
                    const response = await fetch('/api/settings');
                    if (!response.ok) {
                        throw new Error('ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                    const data = await response.json();
                    settingsState = {
                        replicate_api_key: data.replicate_api_key || '',
                        elevenlabs_api_key: data.elevenlabs_api_key || '',
                        openai_api_key: data.openai_api_key || '',
                        download_folder_path: data.download_folder_path || ''
                    };
                    populateSettingsForm();
                } catch (error) {
                    console.error('[ì„¤ì •] ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                }
            }

            async function saveSettings() {
                if (!saveSettingsBtn) return;
                const payload = {
                    replicate_api_key: settingsReplicateInput.value.trim(),
                    elevenlabs_api_key: settingsElevenlabsInput.value.trim(),
                    openai_api_key: settingsOpenaiInput.value.trim(),
                    download_folder_path: settingsDownloadFolderInput ? settingsDownloadFolderInput.value.trim() : ''
                };
                saveSettingsBtn.disabled = true;
                saveSettingsBtn.textContent = 'ì €ì¥ ì¤‘...';
                try {
                    const response = await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'ì„¤ì •ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                    settingsState = { ...settingsState, ...payload };
                    setStatus('API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    closeSettingsModal();
                } catch (error) {
                    console.error('[ì„¤ì •] ì €ì¥ ì‹¤íŒ¨:', error);
                    setStatus(error.message || 'ì„¤ì •ì„ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    saveSettingsBtn.disabled = false;
                    saveSettingsBtn.textContent = 'ì €ì¥';
                }
            }

            let currentJobId = null;
            let currentMode = 'animation';
            let promptItems = [];
            let imageItems = {};
            let pollingInterval = null;
            let isTestMode = false;
            
            // í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ ë³€ìˆ˜ (scriptInputì€ ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            const promptInputSection = document.getElementById('promptInputSection');
            const promptInputs = document.getElementById('promptInputs');
            
            // í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ìƒì„± í•¨ìˆ˜
            function updatePromptInputs(sentences) {
                if (!promptInputSection || !promptInputs) {
                    console.error('í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                if (!sentences || sentences.length === 0) {
                    promptInputSection.style.display = 'none';
                    promptInputs.innerHTML = '';
                    return;
                }
                
                promptInputSection.style.display = 'block';
                
                // ê¸°ì¡´ ì…ë ¥ê°’ ì €ì¥
                const existingValues = {};
                promptInputs.querySelectorAll('textarea[data-index]').forEach(input => {
                    const index = parseInt(input.dataset.index, 10);
                    const value = input.value.trim();
                    if (value) {
                        existingValues[index] = value;
                    }
                });
                
                promptInputs.innerHTML = '';
                
                sentences.forEach((sentence, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.style.marginBottom = '16px';
                    itemDiv.style.padding = '12px';
                    itemDiv.style.background = '#fff';
                    itemDiv.style.borderRadius = '8px';
                    itemDiv.style.border = '1px solid #e5e7eb';
                    
                    const sentenceLabel = document.createElement('label');
                    sentenceLabel.textContent = `ë¬¸ì¥ ${index + 1}:`;
                    sentenceLabel.style.display = 'block';
                    sentenceLabel.style.fontWeight = '600';
                    sentenceLabel.style.marginBottom = '6px';
                    sentenceLabel.style.color = '#1f2937';
                    
                    const sentenceText = document.createElement('div');
                    sentenceText.textContent = sentence;
                    sentenceText.dataset.sentenceIndex = index;
                    sentenceText.className = 'sentence-text';
                    sentenceText.style.color = '#4b5563';
                    sentenceText.style.fontSize = '14px';
                    sentenceText.style.marginBottom = '8px';
                    sentenceText.style.padding = '8px';
                    sentenceText.style.background = '#f9fafb';
                    sentenceText.style.borderRadius = '6px';
                    
                    const promptInput = document.createElement('textarea');
                    promptInput.dataset.index = index;
                    promptInput.placeholder = 'ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)';
                    promptInput.style.width = '100%';
                    promptInput.style.minHeight = '60px';
                    promptInput.style.padding = '10px';
                    promptInput.style.border = '1px solid #d1d5db';
                    promptInput.style.borderRadius = '6px';
                    promptInput.style.fontSize = '14px';
                    promptInput.style.resize = 'vertical';
                    promptInput.style.fontFamily = 'inherit';
                    
                    // ê¸°ì¡´ ì…ë ¥ê°’ ë³µì› (ì¸ë±ìŠ¤ê°€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°)
                    if (existingValues[index] !== undefined) {
                        promptInput.value = existingValues[index];
                    }
                    
                    itemDiv.appendChild(sentenceLabel);
                    itemDiv.appendChild(sentenceText);
                    itemDiv.appendChild(promptInput);
                    promptInputs.appendChild(itemDiv);
                });
            }
            
            // íŒ¨í„´ ê¸°ë°˜ ëŒ€ë³¸ íŒŒì‹± í•¨ìˆ˜ (í•œêµ­ì–´ ë²ˆì—­ + ì˜ì–´ í”„ë¡¬í”„íŠ¸ í˜•ì‹)
            function parseScriptWithPrompts(scriptText) {
                const results = [];
                
                // íŒ¨í„´: [í•œêµ­ì–´ ë²ˆì—­] ... [ì˜ì–´ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸] ...
                // ì—¬ëŸ¬ ì¤„ì— ê±¸ì³ ìˆì„ ìˆ˜ ìˆìŒ
                // ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›: [í•œêµ­ì–´ ë²ˆì—­], [í•œêµ­ì–´], [Korean Translation], [English Image Prompt] ë“±
                const pattern = /\[(?:í•œêµ­ì–´\s*(?:ë²ˆì—­)?|Korean(?:\s*Translation)?)\]\s*([\s\S]*?)\s*\[(?:ì˜ì–´\s*(?:ì´ë¯¸ì§€\s*)?í”„ë¡¬í”„íŠ¸|English(?:\s*Image)?\s*Prompt)\]\s*([\s\S]*?)(?=\[(?:í•œêµ­ì–´|Korean)|$)/gi;
                
                let match;
                
                while ((match = pattern.exec(scriptText)) !== null) {
                    const koreanText = match[1].trim();
                    const englishPrompt = match[2].trim();
                    
                    if (koreanText && englishPrompt) {
                        results.push({
                            sentence: koreanText,
                            prompt: englishPrompt
                        });
                    }
                }
                
                // íŒ¨í„´ì´ ë°œê²¬ë˜ë©´ ê²°ê³¼ ë°˜í™˜
                if (results.length > 0) {
                    return results;
                }
                
                // íŒ¨í„´ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ë¬¸ì¥ ë¶„ë¦¬
                return null;
            }
            
            // ëŒ€ë³¸ ì…ë ¥ ì‹œ ë¬¸ì¥ë³„ í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ìƒì„±
            if (scriptInput && promptInputSection && promptInputs) {
                scriptInput.addEventListener('input', () => {
                    const scriptText = scriptInput.value.trim();
                    if (!scriptText) {
                        promptInputSection.style.display = 'none';
                        promptInputs.innerHTML = '';
                        return;
                    }
                    
                    // ë¨¼ì € íŒ¨í„´ ê¸°ë°˜ íŒŒì‹± ì‹œë„
                    const parsedResults = parseScriptWithPrompts(scriptText);
                    
                    if (parsedResults && parsedResults.length > 0) {
                        // íŒ¨í„´ì´ ê°ì§€ëœ ê²½ìš°: í•œêµ­ì–´ ë¬¸ì¥ê³¼ ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ í•¨ê»˜ í‘œì‹œ
                        promptInputSection.style.display = 'block';
                        promptInputs.innerHTML = '';
                        
                        parsedResults.forEach((item, index) => {
                            const itemDiv = document.createElement('div');
                            itemDiv.style.marginBottom = '16px';
                            itemDiv.style.padding = '12px';
                            itemDiv.style.background = '#fff';
                            itemDiv.style.borderRadius = '8px';
                            itemDiv.style.border = '1px solid #e5e7eb';
                            
                            const sentenceLabel = document.createElement('label');
                            sentenceLabel.textContent = `ë¬¸ì¥ ${index + 1}:`;
                            sentenceLabel.style.display = 'block';
                            sentenceLabel.style.fontWeight = '600';
                            sentenceLabel.style.marginBottom = '6px';
                            sentenceLabel.style.color = '#1f2937';
                            
                            const sentenceText = document.createElement('div');
                            sentenceText.textContent = item.sentence;
                            sentenceText.dataset.sentenceIndex = index;
                            sentenceText.className = 'sentence-text';
                            sentenceText.style.color = '#4b5563';
                            sentenceText.style.fontSize = '14px';
                            sentenceText.style.marginBottom = '8px';
                            sentenceText.style.padding = '8px';
                            sentenceText.style.background = '#f9fafb';
                            sentenceText.style.borderRadius = '6px';
                            
                            const promptInput = document.createElement('textarea');
                            promptInput.dataset.index = index;
                            promptInput.value = item.prompt; // ì˜ì–´ í”„ë¡¬í”„íŠ¸ ìë™ ì±„ìš°ê¸°
                            promptInput.placeholder = 'ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)';
                            promptInput.style.width = '100%';
                            promptInput.style.minHeight = '60px';
                            promptInput.style.padding = '10px';
                            promptInput.style.border = '1px solid #d1d5db';
                            promptInput.style.borderRadius = '6px';
                            promptInput.style.fontSize = '14px';
                            promptInput.style.resize = 'vertical';
                            promptInput.style.fontFamily = 'inherit';
                            
                            itemDiv.appendChild(sentenceLabel);
                            itemDiv.appendChild(sentenceText);
                            itemDiv.appendChild(promptInput);
                            promptInputs.appendChild(itemDiv);
                        });
                        
                        // íŒ¨í„´ ê°ì§€ ì™„ë£Œ ì‹œ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ í™œì„±í™”
                        generateImagesBtn.disabled = false;
                        setStatus('ëŒ€ë³¸ì´ ìë™ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ìƒì„±ì„ ì§„í–‰í•˜ì„¸ìš”.', 'success');
                    } else {
                        // íŒ¨í„´ì´ ì—†ìœ¼ë©´ ì¼ë°˜ ë¬¸ì¥ ë¶„ë¦¬
                        const sentences = scriptText
                            .split(/[.!?ã€‚ï¼ï¼Ÿ]\s*/)
                            .map(s => s.trim())
                            .filter(s => s.length > 0);
                        
                        if (sentences.length === 0) {
                            promptInputSection.style.display = 'none';
                            promptInputs.innerHTML = '';
                            generateImagesBtn.disabled = true;
                            return;
                        }
                        
                        updatePromptInputs(sentences);
                        // ì¼ë°˜ ë¬¸ì¥ ë¶„ë¦¬ ì‹œì—ëŠ” í”„ë¡¬í”„íŠ¸ ìƒì„±ì´ í•„ìš”í•˜ë¯€ë¡œ ë²„íŠ¼ ë¹„í™œì„±í™” ìœ ì§€
                        generateImagesBtn.disabled = true;
                    }
                });
            } else {
                console.error('ëŒ€ë³¸ ì…ë ¥ë€ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            function openStageModal() {
                stageModal.classList.add('active');
                stageModal.classList.remove('stage-complete', 'stage-error');
                stageCloseBtn.style.display = 'none';
            }

            function closeStageModal() {
                stageModal.classList.remove('active');
            }

            stageCloseBtn.addEventListener('click', closeStageModal);

            function resetStageModal() {
                stageItems.forEach(item => {
                    item.classList.remove('completed', 'active', 'pending', 'error');
                    item.classList.add('pending');
                    const dot = item.querySelector('.status-dot');
                    if (dot) dot.style.background = '';
                });
                stageProgressBar.style.width = '0%';
                stageModal.classList.remove('stage-complete', 'stage-error');
                stageCloseBtn.style.display = 'none';
            }

            function updateStageModal(stageProgress, currentStage, status) {
                const completedCount = Math.min(stageProgress || 0, stageTotal);
                stageItems.forEach((item, index) => {
                    item.classList.remove('completed', 'active', 'pending', 'error');
                    if (index < completedCount) {
                        item.classList.add('completed');
                    } else if (index === completedCount && status === 'running') {
                        item.classList.add('active');
                    } else {
                        item.classList.add('pending');
                    }
                });

                if (status === 'error') {
                    stageModal.classList.add('stage-error');
                    stageItems[Math.min(completedCount, stageTotal - 1)].classList.add('error');
                    stageCloseBtn.style.display = 'block';
                } else if (status === 'completed') {
                    stageItems.forEach(item => item.classList.add('completed'));
                    stageProgressBar.style.width = '100%';
                    stageModal.classList.add('stage-complete');
                    stageCloseBtn.style.display = 'block';
                    return;
                }

            const percent = Math.min(completedCount / stageTotal, 1) * 100;
                stageProgressBar.style.width = `${percent}%`;
            }

            function setStatus(text, type = 'info') {
                if (!text) {
                    statusMessage.style.display = 'none';
                    statusMessage.textContent = '';
                    statusMessage.className = 'status-msg';
                    return;
                }
                statusMessage.style.display = 'block';
                statusMessage.textContent = text;
                statusMessage.className = `status-msg ${type}`;
            }

            function renderPromptRows() {
                promptTableBody.innerHTML = '';
                if (!promptItems.length) {
                    promptSection.style.display = 'none';
                    return;
                }
                promptSection.style.display = 'block';
                promptItems.forEach(item => {
                    const row = document.createElement('tr');

                    const sentenceCell = document.createElement('td');
                    sentenceCell.textContent = item.sentence;
                    row.appendChild(sentenceCell);

                    const promptCell = document.createElement('td');
                    const promptPre = document.createElement('pre');
                    promptPre.textContent = item.prompt || '';
                    promptCell.appendChild(promptPre);
                    row.appendChild(promptCell);

                    const imageCell = document.createElement('td');
                    const imageUrl = imageItems[item.index];
                    if (imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `Scene ${item.index}`;
                        img.className = 'prompt-img';
                        imageCell.appendChild(img);
                    } else {
                        const span = document.createElement('span');
                        span.textContent = 'ì´ë¯¸ì§€ ì—†ìŒ';
                        span.className = 'img-placeholder';
                        imageCell.appendChild(span);
                    }
                    row.appendChild(imageCell);

                    const actionCell = document.createElement('td');
                    const regenBtn = document.createElement('button');
                    regenBtn.type = 'button';
                    regenBtn.textContent = 'ì¬ìƒì„±';
                    regenBtn.dataset.index = item.index;
                    regenBtn.className = 'regen-button';
                    if (!currentJobId) {
                        regenBtn.disabled = true;
                    }
                    actionCell.appendChild(regenBtn);
                    row.appendChild(actionCell);

                    promptTableBody.appendChild(row);
                });
                bindRegenerateButtons();
            }

            function bindRegenerateButtons() {
                document.querySelectorAll('.regen-button').forEach(btn => {
                    btn.addEventListener('click', async (event) => {
                        const index = parseInt(event.currentTarget.dataset.index, 10);
                        if (!currentJobId || !index) {
                            setStatus('ë¨¼ì € í”„ë¡¬í”„íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ ì¤€ë¹„í•˜ì„¸ìš”.', 'error');
                            return;
                        }
                        const button = event.currentTarget;
                        const originalText = button.textContent;
                        button.disabled = true;
                        button.textContent = 'ìƒì„± ì¤‘...';
                        setStatus(`${index}ë²ˆ ì´ë¯¸ì§€ ì¬ìƒì„± ì¤‘...`, 'info');

                        try {
                            const response = await fetch('/regenerate_image', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ job_id: currentJobId, scene_index: index })
                            });
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                const msg = errorData.error || 'ì´ë¯¸ì§€ ì¬ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                                throw new Error(msg);
                            }
                            const data = await response.json();
                            imageItems[index] = data.image_url;
                            renderPromptRows();
                            setStatus(`${index}ë²ˆ ì´ë¯¸ì§€ê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        } catch (error) {
                            console.error(error);
                            setStatus(error.message || 'ì´ë¯¸ì§€ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                            button.disabled = false;
                            button.textContent = originalText;
                        }
                    });
                });
            }

            function setActiveModeTab() {
                modeTabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.mode === currentMode);
                });
            }

            function resetProgressPanel() {
                progressPanel.style.display = 'block';
                progressBar.value = 0;
                progressMessage.textContent = 'ì‘ì—…ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.';
                progressLog.innerHTML = '';
            }

            function appendProgressLog(text) {
                const li = document.createElement('li');
                li.textContent = text;
                progressLog.appendChild(li);
                progressLog.scrollTop = progressLog.scrollHeight;
            }

            function updateProgressBar(status, messageCount) {
                let value = 0;
                if (status === 'pending') value = 5;
                else if (status === 'running') value = Math.min(95, 10 + messageCount * 5);
                else if (status === 'completed') value = 100;
                else if (status === 'error') value = 100;
                progressBar.value = value;
            }

            setActiveModeTab();

            modeTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const newMode = this.dataset.mode;
                    if (!newMode) {
                        console.error('ëª¨ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤:', this);
                        return;
                    }
                    if (currentMode === newMode) return;
                    currentMode = newMode;
                    setActiveModeTab();
                    setStatus(`${newMode === 'realistic' ? 'ì‹¤ì‚¬í™”' : 'ì• ë‹ˆë©”ì´ì…˜'} ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. í”„ë¡¬í”„íŠ¸ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì„¸ìš”.`, 'info');
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    currentJobId = null;
                    promptItems = [];
                    imageItems = {};
                    renderPromptRows();
                    generateImagesBtn.disabled = true;
                    generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                    generateVideoBtn.disabled = true;
                    generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                    progressPanel.style.display = 'none';
                    resultContainer.innerHTML = '';
                });
            });

            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ ë²„íŠ¼
            const testModeBtn = document.getElementById('testModeBtn');
            if (testModeBtn) {
                testModeBtn.addEventListener('click', function() {
                    isTestMode = !isTestMode;
                    if (isTestMode) {
                        this.style.background = '#ef4444';
                        this.textContent = 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ ON';
                        setStatus('í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ ìƒì„± ì‹œ photo í´ë”ì˜ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'info');
                    } else {
                        this.style.background = '#10b981';
                        this.textContent = 'í…ŒìŠ¤íŠ¸';
                        setStatus('í…ŒìŠ¤íŠ¸ ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                    }
                });
            }

            if (previewBtn) {
                previewBtn.addEventListener('click', async () => {
                    const voiceId = voiceSelect.value;
                    const text = previewText.value.trim();
                    previewBtn.disabled = true;
                    previewBtn.textContent = 'ìƒì„± ì¤‘...';
                    previewStatus.textContent = 'ë¯¸ë¦¬ ë“£ê¸°ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

                    try {
                        const params = new URLSearchParams({ voice_id: voiceId });
                        if (text) {
                            params.append('text', text);
                        }
                        const response = await fetch(`/preview_voice?${params.toString()}`);
                        if (!response.ok) {
                            throw new Error('ë¯¸ë¦¬ ë“£ê¸° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        previewAudio.src = url;
                        previewAudio.style.display = 'block';
                        previewAudio.play();
                        previewStatus.textContent = 'ë¯¸ë¦¬ ë“£ê¸°ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤.';
                    } catch (error) {
                        console.error(error);
                        previewStatus.textContent = 'ë¯¸ë¦¬ ë“£ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    } finally {
                        previewBtn.disabled = false;
                        previewBtn.textContent = 'ë¯¸ë¦¬ ë“£ê¸°';
                    }
                });
            }

            // í”„ë¡¬í”„íŠ¸ ìƒì„± ë²„íŠ¼ ì œê±°ë¨ - ëŒ€ë³¸ ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ íŒ¨í„´ ê°ì§€ ë° ë¶„ë¥˜

            generateImagesBtn.addEventListener('click', async () => {
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ë²„íŠ¼ í´ë¦­ë¨');
                
                // ë²„íŠ¼ì´ disabled ìƒíƒœì¸ì§€ í™•ì¸
                if (generateImagesBtn.disabled) {
                    console.warn('[ì´ë¯¸ì§€ ìƒì„±] ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    setStatus('ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  íŒ¨í„´ì´ ê°ì§€ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                const scriptText = scriptInput.value.trim();
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ëŒ€ë³¸ ê¸¸ì´:', scriptText.length);
                
                if (!scriptText) {
                    console.warn('[ì´ë¯¸ì§€ ìƒì„±] ëŒ€ë³¸ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                    setStatus('ëŒ€ë³¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ ìˆ˜ì§‘
                const userPrompts = [];
                const sentences = [];
                const promptInputElements = promptInputs.querySelectorAll('textarea[data-index]');
                
                console.log('[ì´ë¯¸ì§€ ìƒì„±] í”„ë¡¬í”„íŠ¸ ì…ë ¥ ìš”ì†Œ ê°œìˆ˜:', promptInputElements.length);
                
                if (promptInputElements.length === 0) {
                    console.warn('[ì´ë¯¸ì§€ ìƒì„±] í”„ë¡¬í”„íŠ¸ ì…ë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    setStatus('ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  íŒ¨í„´ì´ ê°ì§€ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // ì •ë ¬ëœ ìˆœì„œë¡œ ìˆ˜ì§‘
                const sortedInputs = Array.from(promptInputElements).sort((a, b) => {
                    return parseInt(a.dataset.index, 10) - parseInt(b.dataset.index, 10);
                });
                
                sortedInputs.forEach(input => {
                    const index = parseInt(input.dataset.index, 10);
                    const prompt = input.value.trim();
                    const itemDiv = input.parentElement;
                    
                    if (!itemDiv) {
                        console.warn(`ì¸ë±ìŠ¤ ${index}: itemDivë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    // ë” ì•ˆì •ì ì¸ ë°©ë²•ìœ¼ë¡œ ë¬¸ì¥ ì°¾ê¸°
                    let sentence = '';
                    const sentenceDiv = itemDiv.querySelector('.sentence-text');
                    if (sentenceDiv) {
                        sentence = sentenceDiv.textContent.trim();
                    } else {
                        // fallback: data-sentence-indexë¡œ ì°¾ê¸°
                        const fallbackDiv = itemDiv.querySelector(`[data-sentence-index="${index}"]`);
                        if (fallbackDiv) {
                            sentence = fallbackDiv.textContent.trim();
                        } else {
                            // ë§ˆì§€ë§‰ fallback: background ìŠ¤íƒ€ì¼ë¡œ ì°¾ê¸°
                            const styleDiv = itemDiv.querySelector('div[style*="background: #f9fafb"]');
                            if (styleDiv) {
                                sentence = styleDiv.textContent.trim();
                            } else {
                                console.warn(`ì¸ë±ìŠ¤ ${index}: ë¬¸ì¥ divë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, itemDiv);
                            }
                        }
                    }
                    
                    if (sentence) {
                        sentences.push(sentence);
                        userPrompts.push(prompt || null);
                    } else {
                        console.warn(`ì¸ë±ìŠ¤ ${index}: ë¬¸ì¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.`);
                    }
                });
                
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ìˆ˜ì§‘ëœ ë¬¸ì¥ ê°œìˆ˜:', sentences.length);
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ìˆ˜ì§‘ëœ í”„ë¡¬í”„íŠ¸ ê°œìˆ˜:', userPrompts.length);
                
                if (sentences.length === 0) {
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    setStatus('ë¬¸ì¥ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // í”„ë¡¬í”„íŠ¸ê°€ ì—†ëŠ” ë¬¸ì¥ì´ ìˆìœ¼ë©´ ì˜¤ë¥˜
                const hasEmptyPrompts = userPrompts.some(p => !p || p.trim() === '');
                if (hasEmptyPrompts) {
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ë¹ˆ í”„ë¡¬í”„íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤.');
                    setStatus('ëª¨ë“  ë¬¸ì¥ì— ì˜ì–´ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                console.log('[ì´ë¯¸ì§€ ìƒì„±] ê²€ì¦ ì™„ë£Œ, ì´ë¯¸ì§€ ìƒì„± ì‹œì‘');
                
                // ê¸°ì¡´ ì½”ë“œ ì œê±°í•˜ê³  ìƒˆë¡œ ì‘ì„±
                generateImagesBtn.disabled = true;
                generateImagesBtn.textContent = 'ìƒì„± ì¤‘...';
                generateVideoBtn.disabled = true;
                imageItems = {};
                promptItems = sentences.map((sentence, idx) => ({
                    index: idx + 1,
                    sentence: sentence,
                    prompt: userPrompts[idx] || ''
                }));
                renderPromptRows();
                resultContainer.innerHTML = '';
                progressPanel.style.display = 'none';
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                setStatus('ì´ë¯¸ì§€ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                resetProgressPanel();
                resetStageModal();
                openStageModal();
                updateStageModal(0, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘', 'running');

                try {
                    // í”„ë¡¬í”„íŠ¸ ìƒì„± ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³  ë°”ë¡œ ì´ë¯¸ì§€ ìƒì„±
                    // API í‚¤ ì½ê¸°
                    const replicateApiKey = (settingsState.replicate_api_key || '').trim() || null;
                    const elevenlabsApiKey = (settingsState.elevenlabs_api_key || '').trim() || null;
                    
                    console.log('[ì´ë¯¸ì§€ ìƒì„±] API ìš”ì²­ ì‹œì‘:', {
                        sentencesCount: sentences.length,
                        promptsCount: userPrompts.length,
                        mode: currentMode,
                        hasReplicateKey: !!replicateApiKey,
                        hasElevenlabsKey: !!elevenlabsApiKey
                    });
                    
                    const response = await fetch('/generate_images_direct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            script_text: scriptText,
                            sentences: sentences,
                            prompts: userPrompts,
                            mode: currentMode,
                            test_mode: isTestMode,
                            replicate_api_key: replicateApiKey,
                            elevenlabs_api_key: elevenlabsApiKey
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        let msg = errorData.error || 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        if (response.status === 404) {
                            msg = 'ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ì£¼ì„¸ìš”.';
                        } else if (response.status === 400) {
                            msg = errorData.error || 'ìš”ì²­ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        }
                        throw new Error(msg);
                    }
                    const data = await response.json();
                    currentJobId = data.job_id;
                    
                    // ì§„í–‰ë„ í´ë§ ì‹œì‘
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                    }
                    
                    const pollImagesProgress = async () => {
                        try {
                            const statusResponse = await fetch(`/job_status/${currentJobId}`);
                            if (!statusResponse.ok) return;
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'completed') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                
                                // ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                const job = statusData;
                                imageItems = {};
                                
                                if (job.image_files) {
                                    // ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œë¥¼ URLë¡œ ë³€í™˜
                                    Object.keys(job.image_files).forEach(idx => {
                                        const absPath = job.image_files[idx];
                                        // ì ˆëŒ€ ê²½ë¡œì—ì„œ static/ ì´í›„ ë¶€ë¶„ ì¶”ì¶œ
                                        const relPath = absPath.replace(/^.*?static\//, 'static/');
                                        imageItems[parseInt(idx)] = '/' + relPath.replace(/\\/g, '/');
                                    });
                                }
                                
                                // í”„ë¡¬í”„íŠ¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
                                if (job.prompts && job.sentences) {
                                    promptItems = job.sentences.map((sentence, idx) => ({
                                        index: idx + 1,
                                        sentence: sentence,
                                        prompt: job.prompts[idx] || ''
                                    }));
                                } else {
                                    // jobì— promptsê°€ ì—†ìœ¼ë©´ ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
                                    promptItems = sentences.map((sentence, idx) => ({
                                        index: idx + 1,
                                        sentence: sentence,
                                        prompt: userPrompts[idx] || ''
                                    }));
                                }
                                renderPromptRows();
                                
                                generateImagesBtn.disabled = false;
                                generateImagesBtn.textContent = 'ì´ë¯¸ì§€ ìƒì„±';
                                generateVideoBtn.disabled = false;
                                setStatus('ì´ë¯¸ì§€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì˜ìƒ ìƒì„±ì„ ì§„í–‰í•˜ì„¸ìš”.', 'success');
                                updateStageModal(100, 'ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', 'completed');
                                // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                                if (currentJobId) {
                                    resultContainer.innerHTML = `
                                        <div class="card">
                                            <h2 style="margin-top:0; color:#1f2937;">âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!</h2>
                                            <p>ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ì¼ê´„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                            <button type="button" onclick="window.location.href='/download_images/${currentJobId}'" style="background:#10b981; margin-top:10px;">
                                                ì¼ê´„ ì‚¬ì§„ ë‹¤ìš´ë¡œë“œ
                                            </button>
                                        </div>
                                    `;
                                }
                            } else if (statusData.status === 'error') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                setStatus(statusData.error || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                generateImagesBtn.disabled = false;
                                generateImagesBtn.textContent = 'ì´ë¯¸ì§€ ìƒì„±';
                            } else if (statusData.status === 'running' || statusData.status === 'processing') {
                                // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
                                if (typeof statusData.stage_progress !== 'undefined') {
                                    updateStageModal(statusData.stage_progress, statusData.current_stage || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘', statusData.status);
                                }
                                if (statusData.progress && statusData.progress.length > 0) {
                                    progressLog.innerHTML = '';
                                    statusData.progress.forEach(msg => {
                                        const text = typeof msg === 'string' ? msg : msg.text || msg;
                                        appendProgressLog(text);
                                    });
                                }
                            }
                        } catch (err) {
                            console.error('ì§„í–‰ë„ í™•ì¸ ì˜¤ë¥˜:', err);
                        }
                    };
                    
                    pollingInterval = setInterval(pollImagesProgress, 1000);
                    pollImagesProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                    
                } catch (error) {
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ì˜¤ë¥˜ ë°œìƒ:', error);
                    console.error('[ì´ë¯¸ì§€ ìƒì„±] ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
                    setStatus(error.message || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    currentJobId = null;
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    generateImagesBtn.disabled = false;
                    generateImagesBtn.textContent = 'ì´ë¯¸ì§€ ìƒì„±';
                }
            });

            generateVideoBtn.addEventListener('click', async () => {
                if (!currentJobId) {
                    setStatus('ë¨¼ì € í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
                    return;
                }
                const scriptText = scriptInput.value.trim();
                if (!scriptText) {
                    setStatus('ëŒ€ë³¸ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                generatePromptsBtn.disabled = true;
                generatePromptsBtn.textContent = 'ìƒì„± ì¤‘...';
                generateImagesBtn.disabled = true;
                generateVideoBtn.disabled = true;
                imageItems = {};
                promptItems = [];
                renderPromptRows();
                resultContainer.innerHTML = '';
                progressPanel.style.display = 'none';
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                setStatus('í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                resetProgressPanel();
                resetStageModal();
                openStageModal();
                updateStageModal(0, 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘', 'running');

                try {
                    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ ìˆ˜ì§‘
                    const userPrompts = [];
                    const promptInputElements = promptInputs.querySelectorAll('textarea[data-index]');
                    promptInputElements.forEach(input => {
                        const index = parseInt(input.dataset.index, 10);
                        const prompt = input.value.trim();
                        userPrompts[index] = prompt || null;
                    });
                    
                    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í”„ë¡¬í”„íŠ¸ê°€ ëª¨ë‘ ë¹„ì–´ìˆìœ¼ë©´ ìë™ ìƒì„±, í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì‚¬ìš©ì ì…ë ¥ ì‚¬ìš©
                    const hasUserPrompts = userPrompts.some(p => p !== null && p !== undefined && p !== '');
                    
                    const response = await fetch('/generate_prompts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            script_text: scriptText, 
                            mode: currentMode,
                            user_prompts: hasUserPrompts ? userPrompts : null
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const msg = errorData.error || 'í”„ë¡¬í”„íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        throw new Error(msg);
                    }
                    const data = await response.json();
                    currentJobId = data.job_id;
                    
                    // ë°±ì—”ë“œì—ì„œ ë¶„ë¦¬ëœ ë¬¸ì¥ ë¦¬ìŠ¤íŠ¸ê°€ ìˆìœ¼ë©´ í”„ë¡¬í”„íŠ¸ ì…ë ¥ë€ ì—…ë°ì´íŠ¸
                    if (data.sentences && Array.isArray(data.sentences)) {
                        updatePromptInputs(data.sentences);
                    }
                    
                    // ì§„í–‰ë„ í´ë§ ì‹œì‘
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                    }
                    
                    const pollPromptsProgress = async () => {
                        try {
                            const statusResponse = await fetch(`/job_status/${currentJobId}`);
                            if (!statusResponse.ok) return;
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'completed') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                
                                // í”„ë¡¬í”„íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                const job = statusData;
                                if (job.prompts && job.sentences) {
                                    promptItems = job.sentences.map((sentence, idx) => ({
                                        index: idx + 1,
                                        sentence: sentence,
                                        prompt: job.prompts[idx] || ''
                                    }));
                                    renderPromptRows();
                                }
                                
                                generateImagesBtn.disabled = false;
                                setStatus('í”„ë¡¬í”„íŠ¸ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 2ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ì„¸ìš”.', 'success');
                                updateStageModal(100, 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ', 'completed');
                                generatePromptsBtn.disabled = false;
                                generatePromptsBtn.textContent = '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±';
                            } else if (statusData.status === 'error') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                setStatus(statusData.error || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                generatePromptsBtn.disabled = false;
                                generatePromptsBtn.textContent = '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±';
                            } else if (statusData.status === 'running' || statusData.status === 'processing') {
                                // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
                                if (typeof statusData.stage_progress !== 'undefined') {
                                    updateStageModal(statusData.stage_progress, statusData.current_stage || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘', statusData.status);
                                }
                                if (statusData.progress && statusData.progress.length > 0) {
                                    progressLog.innerHTML = '';
                                    statusData.progress.forEach(msg => {
                                        const text = typeof msg === 'string' ? msg : msg.text || msg;
                                        appendProgressLog(text);
                                    });
                                }
                            }
                        } catch (err) {
                            console.error('ì§„í–‰ë„ í™•ì¸ ì˜¤ë¥˜:', err);
                        }
                    };
                    
                    pollingInterval = setInterval(pollPromptsProgress, 1000);
                    pollPromptsProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                    
                } catch (error) {
                    console.error(error);
                    setStatus(error.message || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    currentJobId = null;
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    generatePromptsBtn.disabled = false;
                    generatePromptsBtn.textContent = '1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±';
                }
            });

            generateVideoBtn.addEventListener('click', async () => {
                if (!currentJobId) {
                    setStatus('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
                    return;
                }
                generateVideoBtn.disabled = true;
                setStatus('ì´ë¯¸ì§€ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...', 'info');
                resetProgressPanel();
                resetStageModal();
                openStageModal();
                updateStageModal(0, 'ì´ë¯¸ì§€ ìƒì„± ì¤‘', 'running');

                try {
                    const response = await fetch('/generate_images', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ job_id: currentJobId })
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const msg = errorData.error || 'ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                        throw new Error(msg);
                    }
                    const data = await response.json();
                    
                    // ì§„í–‰ë„ í´ë§ ì‹œì‘
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                    }
                    
                    const pollImagesProgress = async () => {
                        try {
                            const statusResponse = await fetch(`/job_status/${currentJobId}`);
                            if (!statusResponse.ok) return;
                            const statusData = await statusResponse.json();
                            
                            if (statusData.status === 'completed') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                
                                // ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                const job = statusData;
                                imageItems = {};
                                
                                if (job.image_files) {
                                    // ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œë¥¼ URLë¡œ ë³€í™˜
                                    Object.keys(job.image_files).forEach(idx => {
                                        const absPath = job.image_files[idx];
                                        // ì ˆëŒ€ ê²½ë¡œì—ì„œ static/ ì´í›„ ë¶€ë¶„ ì¶”ì¶œ
                                        let relPath = absPath;
                                        if (absPath.includes('/static/')) {
                                            relPath = absPath.split('/static/')[1];
                                        } else if (absPath.includes('static/')) {
                                            relPath = absPath.split('static/')[1];
                                        } else if (absPath.includes('generated_assets/')) {
                                            relPath = 'generated_assets/' + absPath.split('generated_assets/')[1];
                                        }
                                        imageItems[parseInt(idx)] = '/static/' + relPath;
                                    });
                                }
                                
                                // jobì—ì„œ sentencesë¥¼ ì‚¬ìš©í•˜ì—¬ ëˆ„ë½ëœ ì´ë¯¸ì§€ URL êµ¬ì„±
                                if (job.sentences) {
                                    const totalImages = job.sentences.length;
                                    for (let i = 1; i <= totalImages; i++) {
                                        if (!imageItems[i]) {
                                            const assetsFolder = `generated_assets/${currentJobId}`;
                                            imageItems[i] = `/static/${assetsFolder}/scene_${i}_image.png`;
                                        }
                                    }
                                }
                                
                                renderPromptRows();
                                generateVideoBtn.disabled = false;
                                setStatus('ì´ë¯¸ì§€ ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. 3ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ì„¸ìš”.', 'success');
                                updateStageModal(100, 'ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ', 'completed');
                                generateImagesBtn.disabled = false;
                                generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                                // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                                if (currentJobId) {
                                    resultContainer.innerHTML = `
                                        <div class="card">
                                            <h2 style="margin-top:0; color:#1f2937;">âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!</h2>
                                            <p>ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ì¼ê´„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                            <button type="button" onclick="window.location.href='/download_images/${currentJobId}'" style="background:#10b981; margin-top:10px;">
                                                ì¼ê´„ ì‚¬ì§„ ë‹¤ìš´ë¡œë“œ
                                            </button>
                                        </div>
                                    `;
                                }
                            } else if (statusData.status === 'error') {
                                clearInterval(pollingInterval);
                                pollingInterval = null;
                                setStatus(statusData.error || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                generateImagesBtn.disabled = false;
                                generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                            } else if (statusData.status === 'running' || statusData.status === 'processing') {
                                // ì§„í–‰ë„ ì—…ë°ì´íŠ¸
                                if (typeof statusData.stage_progress !== 'undefined') {
                                    updateStageModal(statusData.stage_progress, statusData.current_stage || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘', statusData.status);
                                }
                                if (statusData.progress && statusData.progress.length > 0) {
                                    progressLog.innerHTML = '';
                                    statusData.progress.forEach(msg => {
                                        const text = typeof msg === 'string' ? msg : msg.text || msg;
                                        appendProgressLog(text);
                                    });
                                }
                            }
                        } catch (err) {
                            console.error('ì§„í–‰ë„ í™•ì¸ ì˜¤ë¥˜:', err);
                        }
                    };
                    
                    pollingInterval = setInterval(pollImagesProgress, 1000);
                    pollImagesProgress(); // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
                    
                } catch (error) {
                    console.error(error);
                    setStatus(error.message || 'ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                    generateImagesBtn.disabled = false;
                    generateImagesBtn.textContent = '2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±';
                }
            });

            generateVideoBtn.addEventListener('click', async () => {
                if (!currentJobId) {
                    setStatus('ë¨¼ì € í”„ë¡¬í”„íŠ¸ì™€ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”.', 'error');
                    return;
                }
                generateVideoBtn.disabled = true;
                generateVideoBtn.textContent = 'ìƒì„± ì¤‘...';
                setStatus('ì˜ìƒ ìƒì„±ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì§„í–‰ë„ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'info');
                resetProgressPanel();
                resultContainer.innerHTML = '';
                resetStageModal();
                openStageModal();
                updateStageModal(0, 'ìì‚° ìƒì„±', 'running');

                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }

                const includeSubtitlesCheckbox = document.getElementById('includeSubtitlesCheckbox');
                const includeSubtitles = includeSubtitlesCheckbox ? includeSubtitlesCheckbox.checked : true;
                
                // API í‚¤ ì½ê¸°
                const replicateApiKey = (settingsState.replicate_api_key || '').trim() || null;
                const elevenlabsApiKey = (settingsState.elevenlabs_api_key || '').trim() || null;
                
                const payload = {
                    job_id: currentJobId,
                    char_limit: charLimitInput.value,
                    voice_id: voiceSelect.value,
                    mode: currentMode,
                    include_subtitles: includeSubtitles,
                    replicate_api_key: replicateApiKey,
                    elevenlabs_api_key: elevenlabsApiKey
                };

                try {
                    const response = await fetch('/start_job', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const msg = errorData.error || 'ì˜ìƒ ìƒì„± ì‘ì—…ì„ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                        throw new Error(msg);
                    }
                    const data = await response.json();
                    pollJob(data.job_id);
                } catch (error) {
                    console.error(error);
                    setStatus(error.message || 'ì˜ìƒ ìƒì„± ì‘ì—… ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    generateVideoBtn.disabled = false;
                    generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                    progressPanel.style.display = 'none';
                }
            });

            function pollJob(jobId) {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
                pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`/job_status/${jobId}`);
                        if (!response.ok) {
                            throw new Error('ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        }
                        const data = await response.json();
                        updateProgressBar(data.status, data.progress.length || 0);
                        progressMessage.textContent = data.status === 'completed'
                            ? 'ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
                            : data.status === 'error'
                                ? 'ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                                : 'ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.';
                        progressLog.innerHTML = '';
                        (data.progress || []).forEach(item => appendProgressLog(item.text));

                        if (typeof data.stage_progress !== 'undefined') {
                            updateStageModal(data.stage_progress, data.current_stage || '', data.status);
                        }

                        if (data.status === 'completed') {
                            // video_urlì´ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ ë‹¤ìš´ë¡œë“œ ë§í¬ í‘œì‹œ
                            if (data.video_url && data.video_url !== 'null' && data.video_url !== 'undefined') {
                                clearInterval(pollingInterval);
                                generateVideoBtn.disabled = false;
                                generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                                setStatus('ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                progressMessage.textContent = 'ğŸ‰ ì˜ìƒì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                                stageModal.classList.add('stage-complete');
                                stageCloseBtn.style.display = 'block';
                                resultContainer.innerHTML = `
                                    <div class="card">
                                        <h2 style="margin-top:0; color:#1f2937;">ğŸ‰ ì˜ìƒ ìƒì„± ì™„ë£Œ!</h2>
                                        <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p>
                                        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                                            <button type="button" onclick="downloadVideo('${jobId}')">ì˜ìƒ ë‹¤ìš´ë¡œë“œ</button>
                                            <button type="button" onclick="window.location.href='/download_images/${jobId}'" style="background:#10b981;">
                                                ì¼ê´„ ì‚¬ì§„ ë‹¤ìš´ë¡œë“œ
                                            </button>
                                            <button type="button" onclick="window.location.href='/download_subtitle/${jobId}'" style="background:#3b82f6;">
                                                ìë§‰(SRT) ë‹¤ìš´ë¡œë“œ
                                            </button>
                                        </div>
                                    </div>
                                `;
                            } else {
                                // video_urlì´ ì—†ìœ¼ë©´ ì•„ì§ ìƒì„± ì¤‘ì´ê±°ë‚˜ ì˜¤ë¥˜
                                progressMessage.textContent = 'ì˜ìƒ ìƒì„± ì¤‘... (ìµœì¢… íŒŒì¼ í™•ì¸ ì¤‘)';
                            }
                        } else if (data.status === 'error') {
                            clearInterval(pollingInterval);
                            generateVideoBtn.disabled = false;
                            generateVideoBtn.textContent = '3ë‹¨ê³„: ì˜ìƒ ìƒì„±';
                            const errorMsg = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                            setStatus(`ì˜ìƒ ìƒì„± ì‹¤íŒ¨: ${errorMsg}`, 'error');
                            stageModal.classList.add('stage-error');
                            stageCloseBtn.style.display = 'block';
                        }
                    } catch (err) {
                        console.error(err);
                    }
                }, 2000);
            }

            if (openSettingsBtn) {
                openSettingsBtn.addEventListener('click', () => {
                    openSettingsModal();
                });
            }
            if (closeSettingsBtn) {
                closeSettingsBtn.addEventListener('click', closeSettingsModal);
            }
            if (cancelSettingsBtn) {
                cancelSettingsBtn.addEventListener('click', closeSettingsModal);
            }
            if (settingsModal) {
                settingsModal.addEventListener('click', (event) => {
                    if (event.target === settingsModal) {
                        closeSettingsModal();
                    }
                });
            }
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => {
                    saveSettings();
                });
            }
            
            // í´ë” ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
            if (selectFolderBtn) {
                selectFolderBtn.addEventListener('click', async () => {
                    if (!selectFolderBtn) return;
                    const originalText = selectFolderBtn.textContent;
                    selectFolderBtn.disabled = true;
                    selectFolderBtn.textContent = 'ì„ íƒ ì¤‘...';
                    
                    try {
                        // ë¨¼ì € File System Access API ì‹œë„ (ìµœì‹  ë¸Œë¼ìš°ì €/ì›¹ë·°)
                        if (window.showDirectoryPicker) {
                            try {
                                const dirHandle = await window.showDirectoryPicker();
                                const folderPath = await dirHandle.getDirectoryHandle ? dirHandle.name : null;
                                
                                // File System Access APIëŠ” ì‹¤ì œ ê²½ë¡œë¥¼ ì§ì ‘ ì œê³µí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ
                                // ì„œë²„ APIë¥¼ í†µí•´ ì²˜ë¦¬
                                const response = await fetch('/api/select_download_folder', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ use_native: true })
                                });
                                
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data.folder_path && settingsDownloadFolderInput) {
                                        settingsDownloadFolderInput.value = data.folder_path;
                                        settingsState.download_folder_path = data.folder_path;
                                        setStatus('í´ë”ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                                    }
                                } else {
                                    throw new Error('ì„œë²„ì—ì„œ í´ë” ê²½ë¡œë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                                }
                            } catch (dirError) {
                                // File System Access API ì‹¤íŒ¨ ì‹œ ì„œë²„ API ì‚¬ìš©
                                console.log('[í´ë” ì„ íƒ] File System Access API ì‹¤íŒ¨, ì„œë²„ API ì‚¬ìš©:', dirError);
                                await selectFolderViaServer();
                            }
                        } else {
                            // File System Access APIê°€ ì—†ìœ¼ë©´ ì„œë²„ API ì‚¬ìš©
                            await selectFolderViaServer();
                        }
                    } catch (error) {
                        console.error('[í´ë” ì„ íƒ] ì˜¤ë¥˜:', error);
                        setStatus(error.message || 'í´ë” ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    } finally {
                        selectFolderBtn.disabled = false;
                        selectFolderBtn.textContent = originalText;
                    }
                    
                    async function selectFolderViaServer() {
                        const response = await fetch('/api/select_download_folder', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.error || 'í´ë” ì„ íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        
                        const data = await response.json();
                        if (data.folder_path && settingsDownloadFolderInput) {
                            settingsDownloadFolderInput.value = data.folder_path;
                            settingsState.download_folder_path = data.folder_path;
                            setStatus('í´ë”ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        }
                    }
                });
            }
            
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && settingsModal && settingsModal.classList.contains('active')) {
                    closeSettingsModal();
                }
            });

            loadSettings();
        });
    </script>
</body>
</html>
